{% extends "base.html" %}
{% block content %}
<h2>å£²ä¸Šé›†è¨ˆ</h2>
<!-- DEBUG: {{ debug_info }} -->

{# ========== é™¤å¤–å¯¾è±¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å®šç¾© ========== #}
{% set excluded_status = ['çµ±åˆæ¸ˆ', 'integrated', 'merged'] %}

{# ========== orders ãŒæ¥ã¦ã„ã‚‹å ´åˆã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå´ã§ã€Œçµ±åˆæ¸ˆã€ã‚’é™¤å¤–ã—ã¦å†é›†è¨ˆ ========== #}
{% if orders is defined and orders %}
  {% set ns = namespace(count=0, subtotal=0, tax=0, total=0) %}
  {% for o in orders %}
    {% set st = (o.status if o.status is defined else (o.get('status') if o is mapping else '')) %}
    {% if (st or '') not in excluded_status %}
      {% set sub = (o.subtotal if o.subtotal is defined else (o.get('subtotal') if o is mapping else 0)) or (o.get('å°è¨ˆ') if o is mapping else 0) %}
      {% set tx  = (o.tax      if o.tax      is defined else (o.get('tax')      if o is mapping else 0)) or (o.get('ç¨é¡') if o is mapping else 0) %}
      {% set tot = (o.total    if o.total    is defined else (o.get('total')    if o is mapping else 0)) or (o.get('åˆè¨ˆ') if o is mapping else 0) %}
      {% set ns.count    = ns.count + 1 %}
      {% set ns.subtotal = ns.subtotal + (sub or 0) %}
      {% set ns.tax      = ns.tax + (tx or 0) %}
      {% set ns.total    = ns.total + (tot or 0) %}
    {% endif %}
  {% endfor %}
  <p class="small" style="color:#6b7280;margin:6px 0 0;">â€»ã€Œçµ±åˆæ¸ˆã€ã®ä¼ç¥¨ã¯æ¦‚è¦é›†è¨ˆã‹ã‚‰é™¤å¤–ã—ã¦ã„ã¾ã™ã€‚</p>
{% endif %}

{# ========== å°ã•ãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== #}
{% macro numfmt(v) -%}
  {{ "{:,}".format((v or 0)|int) }}
{%- endmacro %}

{# ========== çµã‚Šè¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ  ========== #}
<form method="get" class="card" style="display:flex;gap:12px;flex-wrap:wrap;align-items:end;max-width:720px">
  <div>
    <label>é–‹å§‹æ—¥</label>
    <input type="date" name="start" value="{{ start or '' }}">
  </div>
  <div>
    <label>çµ‚äº†æ—¥</label>
    <input type="date" name="end" value="{{ end or '' }}">
  </div>
  <div>
    <button class="btn" type="submit">é›†è¨ˆã™ã‚‹</button>
    {% if has_endpoint and has_endpoint('floor') %}
      <a class="btn sub" href="{{ url_for('floor') }}">ãƒ•ãƒ­ã‚¢ã¸æˆ»ã‚‹</a>
    {% endif %}
  </div>
</form>

{# ========== æ¦‚è¦ & æ”¯æ‰•æ–¹æ³•åˆ¥ ========== #}
<div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:12px">
  <div class="card">
    <h3>æ¦‚è¦</h3>
    {% set ov = overview or {} %}

    {# å®¢å˜ä¾¡ï¼ˆåˆè¨ˆ/æ¥å®¢æ•°ï¼‰ #}
    {% set guests_n = (ov.guests or 0)|int %}
    {% set total_n  = ((ns.total if ns is defined else ov.total) or 0)|int %}
    {% set arppu    = (total_n // guests_n) if guests_n > 0 else 0 %}

    <table class="compact">
      <tr>
        <th>æ¥å®¢çµ„æ•°</th>
        <td style="text-align:right">
          {{ (ns.count if ns is defined else (ov.count_orders or 0)) }}
        </td>
      </tr>
      <tr>
        <th>æ¥å®¢è€…æ•°</th>
        <td style="text-align:right">
          {{ numfmt(ov.guests or 0) }}
        </td>
      </tr>
      <tr>
        <th>å®¢å˜ä¾¡</th>
        <td style="text-align:right"><strong>Â¥{{ numfmt(arppu) }}</strong></td>
      </tr>
      <tr>
        <th>å°è¨ˆ</th>
        <td style="text-align:right">{{ numfmt(ns.subtotal if ns is defined else ov.subtotal) }}</td>
      </tr>
      <tr>
        <th>ç¨é¡</th>
        <td style="text-align:right">{{ numfmt(ns.tax if ns is defined else ov.tax) }}</td>
      </tr>
      <tr>
        <th>åˆè¨ˆ</th>
        <td style="text-align:right"><strong>{{ numfmt(total_n) }}</strong></td>
      </tr>
    </table>
    {% if ns is not defined %}
      <p class="small" style="color:#6b7280;margin:6px 0 0;">â€»ã€Œçµ±åˆæ¸ˆã€ã®é™¤å¤–ã¯ã‚µãƒ¼ãƒå´é›†è¨ˆã«ä¾å­˜ã—ã¾ã™ã€‚</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>æ”¯æ‰•æ–¹æ³•åˆ¥</h3>
    {% if by_method and by_method|length %}
      <table class="compact">
        <tr><th>æ–¹æ³•</th><th style="text-align:right">é‡‘é¡</th></tr>
        {% for m in by_method %}
          <tr>
            <td>{{ m.name or "-" }}</td>
            <td style="text-align:right">{{ numfmt(m.amount) }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p class="small" style="color:#6b7280">è©²å½“æœŸé–“ã®æ”¯æ‰•è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
  </div>
</div>

{# ========== æ—¥åˆ¥å£²ä¸Š ========== #}
<div class="card" style="margin-top:12px">
  <h3>æ—¥åˆ¥å£²ä¸Š</h3>
  {% if days and days|length %}
    <table>
      <tr>
        <th>æ—¥ä»˜</th>
        <th style="text-align:right">æ¥å®¢çµ„æ•°</th>
        <th style="text-align:right">æ¥å®¢è€…æ•°</th>
        <th style="text-align:right">å®¢å˜ä¾¡</th>
        <th style="text-align:right">å°è¨ˆ</th>
        <th style="text-align:right">ç¨é¡</th>
        <th style="text-align:right">åˆè¨ˆ</th>
      </tr>
      {% for d in days %}
        {% set day_orders = (d.orders or 0)|int %}
        {% set day_total  = (d.total or 0)|int %}
        {% set day_guests = (d.guests or 0)|int %}
        {% set day_arppu  = (day_total // day_guests) if day_guests > 0 else 0 %}
      <tr>
        <td>{{ d.day or "-" }}</td>
        <td style="text-align:right">{{ day_orders }}</td>
        <td style="text-align:right">{{ numfmt(day_guests) }}</td>
        <td style="text-align:right"><strong>Â¥{{ numfmt(day_arppu) }}</strong></td>
        <td style="text-align:right">{{ numfmt(d.subtotal) }}</td>
        <td style="text-align:right">{{ numfmt(d.tax) }}</td>
        <td style="text-align:right"><strong>{{ numfmt(day_total) }}</strong></td>
      </tr>
      {% endfor %}
    </table>
    <p class="small" style="color:#6b7280;margin:6px 0 0;">
      â€» æ—¥åˆ¥ã®ã€Œæ¥å®¢è€…æ•°ã€ã€Œå®¢å˜ä¾¡ã€ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ <code>days[i].guests</code> ãŒæ¸¡ã£ã¦ãã‚‹å ´åˆã«ç®—å‡ºã—ã¾ã™ï¼ˆç„¡ã„å ´åˆã¯ 0 è¡¨ç¤ºï¼‰ã€‚
    </p>
  {% else %}
    <p class="small" style="color:#6b7280">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}
</div>

<!-- ========== æœˆåˆ¥å£²ä¸Šï¼ˆdays ã‚’æœˆå˜ä½ã«é›†è¨ˆã—ã¦è¡¨ç¤ºï¼‰ ========== -->
<div class="card" style="margin-top:12px">
  <h3>æœˆåˆ¥å£²ä¸Š</h3>
  <div style="overflow:auto">
    <table id="monthly-sales-table">
      <thead>
        <tr>
          <th>æœˆ</th>
          <th style="text-align:right">æ¥å®¢çµ„æ•°</th>
          <th style="text-align:right">æ¥å®¢è€…æ•°</th>
          <th style="text-align:right">å®¢å˜ä¾¡</th>
          <th style="text-align:right">å°è¨ˆ</th>
          <th style="text-align:right">ç¨é¡</th>
          <th style="text-align:right">åˆè¨ˆ</th>
        </tr>
      </thead>
      <tbody id="monthly-sales-body">
        <!-- JSã§æç”» -->
      </tbody>
    </table>
  </div>
</div>

<script>
(function(){
  // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’ JSON ã§å—ã‘å–ã‚Š
  const days = {{ (days or []) | tojson | safe }};

  // æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  const num = (v)=> (Number(v||0)).toLocaleString('ja-JP');
  const yen = (v)=> 'Â¥' + num(v||0);

  // "YYYY-MM" ã®ã‚­ãƒ¼ã‚’ä½œã‚‹ï¼ˆd.day ã¯ "YYYY-MM-DD" æƒ³å®šï¼‰
  const monthKey = (d)=> (String(d.day||'').slice(0,7));

  // æœˆåˆ¥é›†è¨ˆ
  const monthly = {}; // key => {orders, guests, subtotal, tax, total}
  (days||[]).forEach(d=>{
    const key = monthKey(d);
    if(!key) return;
    if(!monthly[key]){
      monthly[key] = {orders:0, guests:0, subtotal:0, tax:0, total:0};
    }
    const m = monthly[key];
    m.orders   += Number(d.orders||0);
    m.subtotal += Number(d.subtotal||0);
    m.tax      += Number(d.tax||0);
    m.total    += Number(d.total||0);
    // guests ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒæ¸¡ã—ã¦ã„ã‚‹å ´åˆã®ã¿åŠ ç®—
    m.guests   += Number(d.guests||0);
  });

  // è¡¨æç”»ï¼ˆã‚­ãƒ¼ã‚’æ˜‡é †ã«ï¼‰
  const tbody = document.getElementById('monthly-sales-body');
  tbody.innerHTML = '';
  Object.keys(monthly).sort().forEach(k=>{
    const v = monthly[k];
    const avg = v.guests > 0 ? Math.floor(v.total / v.guests) : 0;

    const tr = document.createElement('tr');
    tr.innerHTML =
      `<td>${k}</td>
       <td style="text-align:right">${num(v.orders)}</td>
       <td style="text-align:right">${num(v.guests)}</td>
       <td style="text-align:right"><strong>${yen(avg)}</strong></td>
       <td style="text-align:right">${yen(v.subtotal)}</td>
       <td style="text-align:right">${yen(v.tax)}</td>
       <td style="text-align:right"><strong>${yen(v.total)}</strong></td>`;
    tbody.appendChild(tr);
  });
})();
</script>



<!-- ========== ğŸ“… æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå£²ä¸Š / æ¥å®¢çµ„æ•° / æ¥å®¢è€…æ•° / å®¢å˜ä¾¡ï¼‰ ========== -->
<div class="card" style="margin-top:12px">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
    <h3 style="margin:0">æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
    <div style="display:flex;gap:6px;align-items:center">
      <button class="btn sub" id="cal-prev">&laquo; å‰æœˆ</button>
      <strong id="cal-title" style="min-width:7em;text-align:center"></strong>
      <button class="btn sub" id="cal-next">ç¿Œæœˆ &raquo;</button>
    </div>
  </div>

  <div style="overflow:auto;margin-top:8px">
    <table id="sales-calendar" class="compact" style="min-width:860px">
      <thead>
        <tr>
          <th style="width:12%">æ—¥</th>
          <th style="width:12%">æœˆ</th>
          <th style="width:12%">ç«</th>
          <th style="width:12%">æ°´</th>
          <th style="width:12%">æœ¨</th>
          <th style="width:12%">é‡‘</th>
          <th style="width:12%">åœŸ</th>
        </tr>
      </thead>
      <tbody id="cal-body">
        <!-- JS ã§ 6 é€±ã¶ã‚“æç”» -->
      </tbody>
    </table>
  </div>

  <p class="small" style="color:#6b7280;margin-top:8px">
    â€» å„ãƒã‚¹ã«ã€Œåˆè¨ˆå£²ä¸Šï¼æ¥å®¢çµ„æ•°ï¼æ¥å®¢è€…æ•°ï¼å®¢å˜ä¾¡ï¼ˆç¨è¾¼ï¼‰ã€ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ <code>/api/sales/daily</code> ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚<br>
    â€» æ—¥ä»˜ã®åˆ¤å®šã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã§è¡Œã„ã€<code>toISOString()</code> ã¯ä½¿ã£ã¦ã„ã¾ã›ã‚“ï¼ˆæ™‚å·®ã‚ºãƒ¬å¯¾ç­–ï¼‰ã€‚
  </p>
</div>

<style>
  #sales-calendar td{
    vertical-align:top; height:96px; padding:6px 8px; background:#fff;
  }
  #sales-calendar td.muted{ background:#fafafa; color:#6b7280; }
  .cal-daynum{ font-weight:700; }
  .cal-metrics{ margin-top:4px; line-height:1.35 }
  .cal-metrics .price{ font-weight:700; }
</style>

<script>
(function(){
  // ===== æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã§ YYYY-MM-DD ã‚’ä½œã‚‹ï¼štoISOString() ä¸ä½¿ç”¨ï¼‰ =====
  function ymd(d){
    const y = d.getFullYear();
    const m = ('0'+(d.getMonth()+1)).slice(-2);
    const day = ('0'+d.getDate()).slice(-2);
    return `${y}-${m}-${day}`;
  }
  function ymText(d){
    return `${d.getFullYear()}å¹´ ${d.getMonth()+1}æœˆ`;
  }
  function monthRange(d){
    const y = d.getFullYear(), m = d.getMonth();
    const first = new Date(y, m, 1);
    const last = new Date(y, m+1, 0);
    return {first, last};
  }
  function startOfCalendarGrid(first){
    // æ—¥æ›œå§‹ã¾ã‚Šã€‚æœˆåˆã®æ›œæ—¥ã¾ã§å‰å€’ã—
    const shift = first.getDay(); // 0:æ—¥
    return new Date(first.getFullYear(), first.getMonth(), first.getDate() - shift);
  }

  // ===== ç”»é¢çŠ¶æ…‹ =====
  const q = new URL(location.href).searchParams;
  // é›†è¨ˆæœŸé–“ã® end ãŒã‚ã‚‹ãªã‚‰ã€ãã®æœˆã‚’åˆæœŸè¡¨ç¤ºã€‚ç„¡ã‘ã‚Œã°æœ¬æ—¥ã€‚
  const endParam = q.get('end') || q.get('end_date');
  let current = endParam ? new Date(endParam+'T00:00:00') : new Date();

  const titleEl = document.getElementById('cal-title');
  const bodyEl  = document.getElementById('cal-body');
  const btnPrev = document.getElementById('cal-prev');
  const btnNext = document.getElementById('cal-next');

  btnPrev.addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()-1, 1); renderMonth(); });
  btnNext.addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()+1, 1); renderMonth(); });

  async function fetchDailyMap(first,last){
    const start = ymd(first), end = ymd(last);
    const url = `/api/sales/daily?start_date=${start}&end_date=${end}`;
    const res = await fetch(url, {headers:{'Accept':'application/json'}});
    const j = await res.json();
    if(!res.ok || j.status!=='success'){ throw new Error(j.message || res.status); }
    const map = {};
    (j.data||[]).forEach(r=>{
      map[r.date] = r; // {date, order_count, subtotal, tax_amount, total_sales, guests, avg_sales_per_guest}
    });
    return map;
  }

  function yen(n){ try{ return 'Â¥'+Number(n||0).toLocaleString('ja-JP'); }catch(_){ return 'Â¥'+(n||0); } }

  async function renderMonth(){
    const {first,last} = monthRange(current);
    titleEl.textContent = ymText(current);

    // API ã‹ã‚‰æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿å–å¾—
    let dataMap = {};
    try{
      dataMap = await fetchDailyMap(first, last);
    }catch(e){
      console.error(e);
      dataMap = {};
    }

    // 6é€±é–“ã‚°ãƒªãƒƒãƒ‰ï¼ˆæ—¥æ›œé–‹å§‹ï¼‰
    const gridStart = startOfCalendarGrid(first);
    bodyEl.innerHTML = '';
    for(let week=0; week<6; week++){
      const tr = document.createElement('tr');
      for(let dow=0; dow<7; dow++){
        const day = new Date(gridStart.getFullYear(), gridStart.getMonth(), gridStart.getDate() + (week*7 + dow));
        const inMonth = (day.getMonth() === current.getMonth());
        const key = ymd(day);
        const d = dataMap[key] || null;

        const td = document.createElement('td');
        if(!inMonth) td.classList.add('muted');

        const daynum = document.createElement('div');
        daynum.className = 'cal-daynum';
        daynum.textContent = day.getDate();

        const metrics = document.createElement('div');
        metrics.className = 'cal-metrics';
        const orders = d ? (d.order_count||0) : 0;
        const guests = d ? (d.guests||0) : 0;
        const sales  = d ? (d.total_sales||0) : 0;
        const avg    = d ? (d.avg_sales_per_guest||0) : 0;

        metrics.innerHTML =
          `<div class="price">${yen(sales)}</div>
           <div class="small">çµ„: ${orders} / å®¢: ${guests}</div>
           <div class="small">å®¢å˜ä¾¡: ${yen(avg)}</div>`;

        td.appendChild(daynum);
        td.appendChild(metrics);
        tr.appendChild(td);
      }
      bodyEl.appendChild(tr);
    }
  }

  renderMonth();
})();
</script>


{# ========== ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Š ========== #}
<div class="card" style="margin-top:12px">
  <h3>ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Š</h3>
  {% if by_menu and by_menu|length %}
    <table>
      <tr>
        <th>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th>
        <th style="text-align:right">æ•°é‡</th>
        <th style="text-align:right">ç¨æŠœ</th>
        <th style="text-align:right">ç¨é¡</th>
        <th style="text-align:right">ç¨è¾¼</th>
      </tr>
      {% for r in by_menu %}
        <tr>
          <td>{{ r.name or "-" }}</td>
          <td style="text-align:right">{{ r.qty or 0 }}</td>
          <td style="text-align:right">{{ numfmt(r.excl) }}</td>
          <td style="text-align:right">{{ numfmt(r.tax) }}</td>
          <td style="text-align:right"><strong>{{ numfmt(r.incl) }}</strong></td>
        </tr>
      {% endfor %}
    </table>
    <p class="small" style="color:#6b7280;margin:6px 0 0;">â€» ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥é›†è¨ˆã‚‚ã‚µãƒ¼ãƒå´ã§ã®ãƒ•ã‚£ãƒ«ã‚¿çµæœã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
  {% else %}
    <p class="small" style="color:#6b7280">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}
</div>

{# ========== ã¡ã‚‡ã„è¶³ã—ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆcompactï¼‰ ========== #}
<style>
  .compact th, .compact td { padding: 6px 8px; }
</style>

{% endblock %}
