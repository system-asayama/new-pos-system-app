<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title or APP_TITLE or "Simple POS" }}</title>
  <style>
    :root{
      --bg:#f7f8fb; --card:#fff; --text:#1f2937; --muted:#6b7280; --danger:#dc2626;
      --primary:#2563eb; --sub:#eef2f7; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; color:var(--text); background:var(--bg);}
    header{background:#fff; border-bottom:1px solid var(--border); padding:10px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    header .left{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    header .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    header a{color:var(--text); text-decoration:none;}
    main{max-width:1100px; margin:24px auto; padding:0 16px;}
    h1{font-size:18px; margin:0;}
    h2{font-size:20px; margin:0 0 12px;}
    .grid{display:grid; gap:16px; grid-template-columns:1fr;}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr;} }
    .card{background:var(--card); border:1px solid var(--border); border-radius:10px; padding:16px;}
    label{display:block; font-size:14px; color:var(--muted); margin:10px 0 6px;}
    input, textarea, select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; font-size:16px; }
    textarea{min-height:96px; resize:vertical;}  /* â† min_height ã‚’ min-height ã«ä¿®æ­£ */
    .btn{display:inline-block; padding:10px 14px; background:var(--primary); color:#fff; border:none; border-radius:8px; font-size:14px; cursor:pointer; text-decoration:none; text-align:center;}
    .btn.sub{background:var(--sub); color:var(--text); border:1px solid var(--border);}
    .btn.sales{background:#10b981; color:#fff;}
    .btn.sales:hover{background:#059669;}
    .small{font-size:12px;}
    .thumbbox{width:96px; height:96px; border:1px solid var(--border); border-radius:8px; overflow:hidden; background:#fff}
    .thumb{width:100%; height:100%; object-fit:cover}
    table{width:100%; border-collapse:collapse;}
    th, td{border-bottom:1px solid var(--border); padding:8px 10px; text-align:left; vertical-align:top;}
    .badge{display:inline-block; padding:4px 8px; background:#eef2ff; border:1px solid #e0e7ff; border-radius:999px; font-size:12px;}
    .price{background:#ecfeff; border-color:#cffafe;}
    .actions{display:flex; gap:8px; flex-wrap:wrap;}
    .flash{background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:10px 12px; border-radius:8px; margin-bottom:12px;}
    .nav{display:flex; gap:8px; flex-wrap:wrap;}
  </style>
  {% block head_extra %}{% endblock %}
</head>
<body>
  <header>
    <div class="left">
      <a href="{{ url_for('index') }}"><strong>{{ APP_TITLE or "Simple POS" }}</strong></a>

      {# å½¹å‰²åˆ¥ãƒŠãƒ“ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼‰ #}
      {% if session.get('logged_in') %}
        {% set _role = session.get('role') %}
        <nav class="nav">
          {# --- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… --- #}
          {% if _role == 'sysadmin' %}
            <a class="btn sub" href="{{ url_for('dev_tools') }}">é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«</a>
            <a class="btn sub" href="{{ url_for('sys_tenants') }}">ãƒ†ãƒŠãƒ³ãƒˆä¸€è¦§</a>

          {# --- ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†è€… --- #}
          {% elif _role == 'tenant_admin' %}
            <a class="btn sub" href="{{ url_for('tenant_portal') }}">ãƒ†ãƒŠãƒ³ãƒˆãƒãƒ¼ã‚¿ãƒ«</a>
            <a class="btn sub" href="{{ url_for('floor') }}">ãƒ•ãƒ­ã‚¢</a>
            <a class="btn sub" href="{{ url_for('kds') }}">KDS</a>
            <a class="btn sales" href="{{ url_for('sales_report') }}">ğŸ“Š å£²ä¸Šé›†è¨ˆ</a>

          {# --- åº—èˆ—ç®¡ç†è€…ï¼ˆæ—§ adminï¼‰ --- #}
          {% elif _role == 'store_admin' %}
            {# ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆBuildErrorå›é¿ï¼‰ #}
            {% set _has_console = has_endpoint('admin_console') %}
            {% set _has_mypage  = has_endpoint('admin_mypage') %}

            {% if _has_console %}
              <a class="btn sub" href="{{ url_for('admin_console') }}">åº—èˆ—ç®¡ç†ãƒšãƒ¼ã‚¸</a>
            {% endif %}
            {% if _has_mypage %}
              <a class="btn sub" href="{{ url_for('admin_mypage') }}">ç®¡ç†è€…ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
            {% endif %}

            <a class="btn sub" href="{{ url_for('floor') }}">ãƒ•ãƒ­ã‚¢</a>
            <a class="btn sub" href="{{ url_for('kds') }}">KDS</a>
            <a class="btn sub" href="{{ url_for('staff_floor') }}">ã‚¹ã‚¿ãƒƒãƒ•ç”»é¢</a>
            <a class="btn sales" href="{{ url_for('sales_report') }}">ğŸ“Š å£²ä¸Šé›†è¨ˆ</a>

          {# --- å¾“æ¥­å“¡ --- #}
          {% else %}
            <a class="btn sub" href="{{ url_for('staff_mypage') }}">å¾“æ¥­å“¡ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
            <a class="btn sub" href="{{ url_for('staff_floor') }}">ã‚¹ã‚¿ãƒƒãƒ•ãƒ•ãƒ­ã‚¢</a>
            <a class="btn sub" href="{{ url_for('floor') }}">ãƒ•ãƒ­ã‚¢</a>
          {% endif %}
        </nav>
      {% else %}
        {# æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ç°¡æ˜“ãƒŠãƒ“ï¼ˆQRãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯éè¡¨ç¤ºï¼‰ #}
        {% if not is_qr_user %}
        <nav class="nav">
          <a class="btn sub" href="{{ url_for('login_choice') }}">ãƒ­ã‚°ã‚¤ãƒ³é¸æŠ</a>
          <a class="btn sub" href="{{ url_for('sysadmin_login') }}">ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</a>
          {# â–¼ ã“ã“ã‚’å‰å®¤ã«å¤‰æ›´ â–¼ #}
          <a class="btn sub" href="{{ url_for('tenant_admin_login_entry') }}">ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</a>
          <a class="btn sub" href="{{ url_for('admin_login') }}">åº—èˆ—ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</a>
          <a class="btn sub" href="{{ url_for('staff_login') }}">å¾“æ¥­å“¡ãƒ­ã‚°ã‚¤ãƒ³</a>
        </nav>
        {% endif %}
      {% endif %}
    </div>

    <div class="right small">
      {% if session.get('logged_in') %}
        {% set _role = session.get('role') %}
        {% set role_label = {
          'sysadmin': 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…',
          'tenant_admin': 'ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†è€…',
          'store_admin': 'åº—èˆ—ç®¡ç†è€…',
          'staff': 'å¾“æ¥­å“¡'
        }.get(_role, 'å¾“æ¥­å“¡') %}
        <span>
          {% if _role not in ['sysadmin','tenant_admin'] and session.get('store_name') %}
            åº—èˆ—: <strong>{{ session.get('store_name') }}</strong> ï¼
          {% endif %}
          ãƒ¦ãƒ¼ã‚¶ãƒ¼: <strong>{{ session.get('user_name') }}</strong>
          ï¼ˆ{{ role_label }}ï¼‰
        </span>
        <a class="btn sub" href="{{ url_for('logout') }}">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
      {% else %}
        {% if not is_qr_user %}
        <a class="btn sub" href="{{ url_for('login_choice') }}">ãƒ­ã‚°ã‚¤ãƒ³</a>
        {% endif %}
      {% endif %}
    </div>
  </header>

  <main>
    {% with msgs = get_flashed_messages() %}
      {% if msgs %}
        <div class="flash">
          {% for m in msgs %}<div>{{ m }}</div>{% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  {% block scripts_extra %}{% endblock %}

  <!-- â–¼ é€šçŸ¥ã‚µã‚¦ãƒ³ãƒ‰ï¼ˆå…±é€šï¼‰ï¼šKDSã‚„ä»–ç”»é¢ã‹ã‚‰ window.playNotify() ã‚’å‘¼ã¶ã ã‘ã§é³´ã‚‹ â–¼ -->
  <audio id="notify-audio"
         src="{{ url_for('static', filename='sounds/order_notify.wav') }}"
         preload="auto"
         style="display:none"></audio>

  <button id="unlock-audio-global"
          type="button"
          style="position:fixed;right:12px;bottom:12px;z-index:9999;">
    ğŸ”Š é€šçŸ¥ã‚’æœ‰åŠ¹åŒ–
  </button>

  <script>
  (() => {
    const audioEl = document.getElementById('notify-audio');
    const unlockBtn = document.getElementById('unlock-audio-global');
    let unlocked = false;

    function hideUnlock(){ if (unlockBtn) unlockBtn.style.display = 'none'; }
    function showUnlock(){ if (unlockBtn) unlockBtn.style.display = ''; }

    async function unlockOnce(){
      try{
        await audioEl.play();   // å†ç”Ÿã§ãã‚‹æ¨©é™ã‚’ç¢ºä¿
        audioEl.pause();
        audioEl.currentTime = 0;
        unlocked = true;
        hideUnlock();
      }catch(e){
        unlocked = false;
        showUnlock();
      }
    }

    // åˆå›ã®ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã§è‡ªå‹•è§£éŒ 
    const firstGesture = () => { unlockOnce(); window.removeEventListener('pointerdown', firstGesture); };
    window.addEventListener('pointerdown', firstGesture);

    // æ˜ç¤ºãƒœã‚¿ãƒ³ã§ã‚‚è§£éŒ 
    if (unlockBtn) unlockBtn.addEventListener('click', unlockOnce);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼šã©ã“ã‹ã‚‰ã§ã‚‚å‘¼ã¹ã‚‹
    window.playNotify = async function(){
      if (!audioEl) return;
      if (!unlocked){
        try { await unlockOnce(); } catch(_){}
        if (!unlocked) return; // ã¾ã è§£éŒ ã§ãã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
      }
      try{
        audioEl.currentTime = 0;   // å…ˆé ­æ¬ ã‘é˜²æ­¢
        await audioEl.play();
      }catch(err){
        showUnlock();
        console.warn('playNotify failed:', err);
      }
    };
  })();
  </script>
  <!-- â–² é€šçŸ¥ã‚µã‚¦ãƒ³ãƒ‰ã“ã“ã¾ã§ â–² -->
</body>
</html>
