{% extends "base.html" %}

{% block head_extra %}
<style>
  :root {
    --bg: #f3f4f6; --card:#fff; --text-base:#1f2937; --text-muted:#6b7280;
    --primary:#4f46e5; --primary-light:#818cf8; --border:#e5e7eb;
    --ring: rgba(79,70,229,.5);
    --shadow-sm: 0 1px 2px rgba(0,0,0,.05);
    --shadow-md: 0 4px 6px rgba(0,0,0,.1), 0 2px 4px rgba(0,0,0,.06);
  }
  .wrap{max-width:960px;margin:24px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:var(--shadow-sm);transition:.2s}
  .card:hover{box-shadow:var(--shadow-md);transform:translateY(-2px)}
  h2{font-size:18px;margin:0 0 12px}
  h3{font-size:16px;margin:8px 0 4px;font-weight:600}
  .muted{color:var(--text-muted);font-size:14px}
  .price{font-weight:700;color:var(--primary);font-size:18px}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:#f9fafb;cursor:pointer;text-decoration:none;font-size:14px;color:var(--text-base)}
  .btn:visited,.btn:hover{color:var(--text-base)!important}
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn.primary:visited,.btn.primary:hover{color:#fff!important;background:var(--primary-light)}
  .btn.danger{border-color:#fecaca;background:#fef2f2;color:#b91c1c}
  .btn.danger:visited,.btn.danger:hover{color:#991b1b!important}
  .pill{display:inline-flex;align-items:center;padding:6px 12px;border:1px solid var(--border);border-radius:9999px;font-size:14px;background:#f9fafb;cursor:pointer}
  .pill:hover{border-color:var(--primary);background:#eff6ff;color:var(--primary)}
  .pill.active{border-color:var(--primary);background:var(--primary);color:#fff;box-shadow:0 0 0 3px var(--ring)}
  .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
  img{max-width:100%;border-radius:8px;height:150px;object-fit:cover}
  #category-list{display:block;margin-top:12px}
  .cat-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;padding-top:8px;border-top:1px dashed var(--border)}
  .cat-row[data-depth="0"]{border-top:none;padding-top:0;margin-top:0}
  .loading{text-align:center;color:var(--text-muted);padding:3rem 0}
  .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}
  .badge.ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
  .badge.ng{background:#fef2f2;border-color:#fecaca;color:#991b1b}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}

  /* ä»–CSSã®åŠé€æ˜/ç„¡åŠ¹åŒ–ã‚’æ‰“ã¡æ¶ˆã™ */
  .card .actions a.btn,
  .card .actions button.btn {
    opacity: 1 !important;
    pointer-events: auto !important;
    filter: none !important;
  }

  /* ã‚«ãƒ†ã‚´ãƒªä¸€æ‹¬æ“ä½œãƒãƒ¼ */
  #cat-actions {
    display:none; gap:8px; align-items:center; flex-wrap:wrap;
    margin-top:8px; padding-top:8px; border-top:1px dashed var(--border);
  }
  /* ğŸ”’ ã€Œå­ã‚«ãƒ†ã‚´ãƒªã‚‚å«ã‚ã‚‹ã€ã‚’æŠ˜ã‚Šè¿”ã—ãªã— */
  #cat-actions .pill { white-space: nowrap; }
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="row" style="margin-bottom:12px">
    <h2>ä½œæˆæ¸ˆã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
    <div class="actions">
      {% if has_endpoint('admin_menu_new_form') %}
        <a class="btn primary" href="{{ url_for('admin_menu_new_form') }}">ï¼‹ æ–°è¦ä½œæˆ</a>
      {% endif %}
      {% if has_endpoint('admin_menu_home') %}
        <a class="btn" href="{{ url_for('admin_menu_home') }}">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ãƒˆãƒƒãƒ—ã¸</a>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <h2>ã‚«ãƒ†ã‚´ãƒª</h2>
    <div id="category-list"></div>

    <!-- ğŸ”¹ ã‚«ãƒ†ã‚´ãƒªä¸€æ‹¬æ“ä½œãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <div id="cat-actions">
      <label class="pill" style="gap:6px;">
        <input type="checkbox" id="cat-recursive" checked>
        å­ã‚«ãƒ†ã‚´ãƒªã‚‚å«ã‚ã‚‹
      </label>
      <button type="button" class="btn" id="btn-cat-enable">ã‚«ãƒ†ã‚´ãƒªã‚’æä¾›é–‹å§‹</button>
      <button type="button" class="btn" id="btn-cat-disable">ã‚«ãƒ†ã‚´ãƒªã‚’æä¾›åœæ­¢</button>
      <button type="button" class="btn danger" id="btn-cat-delete">ã‚«ãƒ†ã‚´ãƒªå†…ã‚’å‰Šé™¤</button>
    </div>
  </div>

  <h2 style="margin:24px 0 16px">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
  <div id="menu-grid" class="grid"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const categoryList = document.getElementById('category-list');
  const menuGrid = document.getElementById('menu-grid');

  // ä¸€æ‹¬æ“ä½œUI
  const catActions  = document.getElementById('cat-actions');
  const chkRecursive = document.getElementById('cat-recursive');
  const btnEnable   = document.getElementById('btn-cat-enable');
  const btnDisable  = document.getElementById('btn-cat-disable');
  const btnDelete   = document.getElementById('btn-cat-delete');
  let currentCatId = null;

  // {"root":[{id,name}], "<id>":[{id,name}], ...}
  const categoryTree = {{ category_tree | tojson | safe }};
  const hasChildren = id => Array.isArray(categoryTree[String(id)]) && categoryTree[String(id)].length > 0;

  function removeRowsFromDepth(depth){
    [...categoryList.querySelectorAll('.cat-row')].forEach(row=>{
      const d = Number(row.dataset.depth||0);
      if(d >= depth) row.remove();
    });
  }
  function clearActiveFromDepth(depth){
    categoryList.querySelectorAll('.category-pill').forEach(p=>{
      const d = Number(p.dataset.depth||0);
      if(d >= depth) p.classList.remove('active');
    });
  }
  function renderRow(parentId, depth){
    removeRowsFromDepth(depth);
    const cats = categoryTree[String(parentId)] || [];
    if(cats.length === 0) return;
    const row = document.createElement('div');
    row.className = 'cat-row';
    row.dataset.depth = depth;
    cats.forEach(c=>{
      const pill = document.createElement('span');
      pill.className = 'pill category-pill';
      pill.dataset.categoryId = c.id;
      pill.dataset.depth = depth;
      pill.textContent = c.name;
      if(hasChildren(c.id)) pill.classList.add('parent');
      row.appendChild(pill);
    });
    categoryList.appendChild(row);
  }

  function priceFmt(v){ const n = Number(v); return Number.isFinite(n) ? n.toLocaleString('ja-JP') : v; }

  function renderMenus(menus){
    menuGrid.innerHTML = '';
    if(!menus || menus.length === 0){
      menuGrid.innerHTML = '<div class="card">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
      return;
    }
    menus.forEach(m=>{
      const card = document.createElement('div');
      card.className = 'card';
      const img = m.photo_url ? `<img src="${m.photo_url}" alt="${m.name}">` : '';
      const avail = Number(m.available||0) === 1;

      const priceIncl = priceFmt(m.price_incl);
      const priceExcl = priceFmt(m.price_excl);

      card.innerHTML = `
        ${img}
        <h3 style="margin:6px 0 4px">${m.name}</h3>
        <div class="muted">${m.description||''}</div>

        <div class="row" style="margin-top:12px">
          <div>
            <div class="price">Â¥${priceIncl} <span class="muted" style="font-size:12px">(ç¨è¾¼)</span></div>
            <div class="muted" style="font-size:12px">ç¨æŠœ Â¥${priceExcl}</div>
          </div>
          <span class="badge ${avail?'ok':'ng'} js-badge">${avail?'æä¾›ä¸­':'åœæ­¢ä¸­'}</span>
        </div>

        <div class="actions">
          <a class="btn" href="${makeUrl('admin_menu_edit', {mid:m.id})}">ç·¨é›†</a>
          <a class="btn js-toggle" href="#" data-mid="${m.id}">${avail?'æä¾›åœæ­¢':'æä¾›é–‹å§‹'}</a>
          <form method="post" action="${makeUrl('admin_menu_delete', {mid:m.id})}" onsubmit="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" style="display:inline">
            {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
            <button type="submit" class="btn danger">å‰Šé™¤</button>
          </form>
        </div>
      `;
      menuGrid.appendChild(card);
    });
  }

  async function loadMenus(categoryId){
    menuGrid.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
    try{
      const resp = await fetch(`/api/admin/menus/by_category/${categoryId}`);
      const data = await resp.json();
      if(data.ok){ renderMenus(data.menus); }
      else{ menuGrid.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>'; }
    }catch(e){
      console.error(e);
      menuGrid.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div>';
    }
  }

  function makeUrl(endpoint, params){
    switch(endpoint){
      case 'admin_menu_edit':   return `/admin/menu/${params.mid}/edit`;
      case 'admin_menu_toggle': return `/admin/menu/${params.mid}/toggle`;
      case 'admin_menu_delete': return `/admin/menu/${params.mid}/delete`;
      default: return '#';
    }
  }

  // æä¾›åœæ­¢ï¼æä¾›é–‹å§‹ ã‚’Ajaxãƒˆã‚°ãƒ«ï¼ˆå˜ä½“ï¼‰
  menuGrid.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('.js-toggle');
    if(!btn) return;
    ev.preventDefault();

    const mid = btn.dataset.mid;
    if(!mid) return;

    try{
      btn.setAttribute('aria-busy','true');
      const resp = await fetch(`/api/admin/menu/${mid}/toggle`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          {% if csrf_token %}'X-CSRFToken': '{{ csrf_token }}',{% endif %}
        },
        body: '{}'
      });
      const data = await resp.json();
      if(!resp.ok || !data.ok){
        alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' + (data && data.error ? `\n${data.error}` : ''));
        return;
      }
      // ãƒãƒƒã‚¸ã¨ãƒœã‚¿ãƒ³æ–‡è¨€ã‚’æ›´æ–°
      const card  = btn.closest('.card');
      const badge = card.querySelector('.js-badge');
      if(Number(data.available) === 1){
        badge.classList.remove('ng'); badge.classList.add('ok');
        badge.textContent = 'æä¾›ä¸­';
        btn.textContent = 'æä¾›åœæ­¢';
      }else{
        badge.classList.remove('ok'); badge.classList.add('ng');
        badge.textContent = 'åœæ­¢ä¸­';
        btn.textContent = 'æä¾›é–‹å§‹';
      }
    }catch(e){
      console.error(e);
      alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }finally{
      btn.removeAttribute('aria-busy');
    }
  });

  // ğŸ”¹ ä¸€æ‹¬ï¼šæä¾›é–‹å§‹/åœæ­¢
  async function bulkAvailable(to){
    if(!currentCatId) return;
    const recursive = chkRecursive.checked ? 1 : 0;
    const resp = await fetch(`/api/admin/category/${currentCatId}/bulk_available`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        {% if csrf_token %}'X-CSRFToken': '{{ csrf_token }}',{% endif %}
      },
      body: JSON.stringify({ available: to, recursive })
    });
    const data = await resp.json();
    if(!resp.ok || !data.ok){
      alert('ä¸€æ‹¬æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' + (data && data.error ? `\n${data.error}` : ''));
      return;
    }
    await loadMenus(currentCatId);
  }
  btnEnable?.addEventListener('click', ()=> bulkAvailable(1));
  btnDisable?.addEventListener('click', ()=> bulkAvailable(0));

  // ğŸ”¹ ä¸€æ‹¬ï¼šå‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰
  btnDelete?.addEventListener('click', async ()=>{
    if(!currentCatId) return;
    const recursive = chkRecursive.checked ? 1 : 0;
    if(!confirm('ã“ã®ã‚«ãƒ†ã‚´ãƒªå†…ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

    const resp = await fetch(`/api/admin/category/${currentCatId}/bulk_delete`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        {% if csrf_token %}'X-CSRFToken': '{{ csrf_token }}',{% endif %}
      },
      body: JSON.stringify({ recursive })
    });
    const data = await resp.json();
    if(!resp.ok || !data.ok){
      alert('ä¸€æ‹¬å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ' + (data && data.error ? `\n${data.error}` : ''));
      return;
    }
    await loadMenus(currentCatId);
  });

  // ã‚«ãƒ†ã‚´ãƒªé¸æŠï¼ˆcurrentCatIdè¨­å®šï¼†ãƒ„ãƒ¼ãƒ«ãƒãƒ¼è¡¨ç¤ºï¼‰
  categoryList.addEventListener('click', (ev)=>{
    const pill = ev.target.closest('.category-pill'); if(!pill) return;
    const catId = pill.dataset.categoryId;
    const depth = Number(pill.dataset.depth||0);
    clearActiveFromDepth(depth);
    pill.classList.add('active');

    currentCatId = Number(catId || 0) || null;
    catActions.style.display = currentCatId ? 'flex' : 'none';

    if(hasChildren(catId)){
      renderRow(catId, depth+1);
      // è¦ªã‚«ãƒ†ã‚´ãƒªé¸æŠæ™‚ã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç©ºï¼ˆå­ã§èª­ã¿è¾¼ã‚€ï¼‰
      menuGrid.innerHTML = '';
    }else{
      removeRowsFromDepth(depth+1);
      loadMenus(catId);
    }
  });

  // åˆæœŸè¡¨ç¤º
  renderRow('root', 0);
  const roots = categoryTree['root'] || [];
  if(roots.length){
    const first = roots[0].id;
    const firstPill = (() => {
      const all = categoryList.querySelectorAll('.category-pill[data-depth="0"]');
      return [...all].find(el => String(el.dataset.categoryId) === String(first));
    })();
    if(firstPill){
      firstPill.classList.add('active');
      currentCatId = Number(first);
      catActions.style.display = 'flex';
    }
    if(hasChildren(first)){ renderRow(first, 1); menuGrid.innerHTML=''; }
    else{ loadMenus(first); }
  }
});
</script>
{% endblock %}
