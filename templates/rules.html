{% extends "base.html" %}
{% block content %}
<h2>印刷ルール</h2>

<div class="grid">
  <div class="card">
    <h3>新規ルール</h3>
    <form method="post" action="{{ url_for('admin_rules_new') }}">
      <label>カテゴリ（任意）</label>
      <select name="カテゴリID">
        <option value="">(なし)</option>
        {% for large in cats %}
          <optgroup label="■ {{ large['名称'] }} (大分類)">
            <option value="{{ large['id'] }}">【大】{{ large['名称'] }}</option>
            {% for mid in large['mid'] %}
              <option value="{{ mid['id'] }}">&nbsp;&nbsp;【中】{{ mid['名称'] }}</option>
              {% for small in mid['small'] %}
                <option value="{{ small['id'] }}">&nbsp;&nbsp;&nbsp;&nbsp;【小】{{ small['名称'] }}</option>
              {% endfor %}
            {% endfor %}
          </optgroup>
        {% endfor %}
      </select>

      <label>メニュー（任意）</label>
      <select name="メニューID">
        <option value="">(なし)</option>
        {% for m in menu %}<option value="{{ m['id'] }}">{{ m['名称'] }}</option>{% endfor %}
      </select>

      <label>プリンタ</label>
      <select name="プリンタID" required>
        {% for p in printers %}<option value="{{ p['id'] }}">{{ p['名称'] }}</option>{% endfor %}
      </select>

      <button class="btn" type="submit">追加</button>
    </form>
  </div>

  <div class="card">
    <h3>一覧</h3>
    <table>
      <thead><tr><th>#</th><th>カテゴリ</th><th>メニュー</th><th>プリンタ</th><th>操作</th></tr></thead>
      <tbody>
        {% for r in rules %}
        <tr>
          <td>{{ r['id'] }}</td>
          <td>{{ r['cat_name'] or '-' }}</td>
          <td>{{ r['menu_name'] or '-' }}</td>
          <td>{{ r['printer_name'] }}</td>
          <td>
            <form method="post" action="{{ url_for('admin_rules_delete', rid=r['id']) }}" style="display:inline" onsubmit="return confirm('削除しますか？')">
              <button class="btn sub" type="submit">削除</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
// メニューデータをJavaScriptに渡す
const allMenus = {{ menu|tojson }};

// カテゴリ選択時のイベントリスナー
const categorySelect = document.querySelector('select[name="カテゴリID"]');
const menuSelect = document.querySelector('select[name="メニューID"]');

if (categorySelect && menuSelect) {
  categorySelect.addEventListener('change', function() {
    const selectedCategoryId = parseInt(this.value) || 0;
    
    // メニュードロップダウンをクリア
    menuSelect.innerHTML = '<option value="">(なし)</option>';
    
    // カテゴリが選択されていない場合はすべて表示
    if (selectedCategoryId === 0) {
      allMenus.forEach(menu => {
        const option = document.createElement('option');
        option.value = menu.id;
        option.textContent = menu['名称'];
        menuSelect.appendChild(option);
      });
    } else {
      // 選択されたカテゴリに属するメニューのみ表示
      allMenus.forEach(menu => {
        if (menu.category_ids && menu.category_ids.includes(selectedCategoryId)) {
          const option = document.createElement('option');
          option.value = menu.id;
          option.textContent = menu['名称'];
          menuSelect.appendChild(option);
        }
      });
    }
  });
  
  // 初期表示時にもフィルタリングを適用
  categorySelect.dispatchEvent(new Event('change'));
}
</script>
{% endblock %}
