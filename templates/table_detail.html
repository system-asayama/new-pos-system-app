{% extends "base.html" %}
{% block content %}

<!-- debug: {{ debug_info }} -->

<style>
  /* â–¼ ç›£æŸ»ç”¨ãƒã‚¤ãƒŠã‚¹è¡Œã‚’èµ¤ç³»ã§ */
  .neg-row { color:#b91c1c; background:#fff1f2; }
  .void-badge {
    display:inline-block; padding:2px 6px; font-size:12px;
    border:1px solid #b91c1c; border-radius:6px; color:#b91c1c; background:#fff;
    margin-left:6px;
  }

  /* â–¼ çŠ¶æ…‹ã®ãƒãƒƒã‚¸ç¾¤ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ */
  .progress-detail { display:inline-flex; gap:8px; font-size:12px; flex-wrap:wrap; }
  .status-chip {
    display:inline-block; padding:2px 8px; border-radius:4px; font-weight:500; cursor:pointer;
    user-select:none; border:1px solid transparent;
  }
  .status-chip:focus-visible { outline:2px solid #2563eb; outline-offset:2px; }
  .chip-new{background:#dbeafe;color:#1e40af}
  .chip-cooking{background:#fef3c7;color:#92400e}
  .chip-served{background:#d1fae5;color:#065f46}
  .chip-canceled{background:#fee2e2;color:#991b1b}

  .time-cell{white-space:nowrap;font-variant-numeric:tabular-nums}
  .small.muted{color:#6b7280}

  /* â–¼ æ“ä½œç”¨ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ï¼ˆçŠ¶æ…‹ãƒãƒƒã‚¸ã‚’æŠ¼ã™ã¨å‡ºã‚‹ï¼‰ */
  .action-host { position:relative; min-height:26px; }
  .action-pop {
    position:absolute; top:0; left:0; z-index:50;
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    padding:8px; background:#fff; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.12);
  }
  .action-pop .badge-src {
    display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px; border:1px solid #e5e7eb; background:#f9fafb;
  }
  .action-pop input[type="number"] { width:72px; padding:4px 6px; }
  .action-pop .btn { padding:6px 10px; }
  .action-pop .btn.sub { background:#f3f4f6; border:1px solid #e5e7eb; }
  .action-pop .btn.primary { background:#2563eb; color:#fff; border:1px solid #1d4ed8; }

  /* â–¼ ã‚¯ãƒªãƒƒã‚¯ã‚’ç¢ºå®Ÿã«é€šã™ãŸã‚ã®ä¿é™º */
  .card, table, thead, tbody, tr, th, td, .action-host, .action-pop, .progress-detail, .status-chip, select, input, button {
    position:relative; z-index:1; pointer-events:auto !important;
  }
  tr::before, tr::after, td::before, td::after { pointer-events:none !é‡è¦; }
  
  /* â–¼ QRãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯æ“ä½œåˆ—ã‚’éè¡¨ç¤º */
  {% if is_qr_user %}
  .action-host { display: none !important; }
  th:has(+ th:last-child), td:has(+ td:last-child) { /* æ“ä½œåˆ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚»ãƒ«ã‚’éè¡¨ç¤º */ }
  table th:nth-last-child(2), table td:nth-last-child(2) { /* æ“ä½œåˆ—ã‚’éè¡¨ç¤º */ display: none; }
  {% endif %}
</style>

{% set table_no = (
  table.table_no
  if table is defined and table.table_no is defined
  else (table['ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·'] if table is defined and table is mapping and 'ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·' in table else '')
) %}

<h2>ãƒ†ãƒ¼ãƒ–ãƒ« {{ table_no }}</h2>

{% set hdrs = (orders if orders is defined and orders else (order_list if order_list is defined else [])) %}
{% if hdrs and hdrs|length > 0 %}
  {% for h in hdrs %}
    {% set hid = (h.id if h.id is defined else (h['id'] if h is mapping and 'id' in h else None)) %}
    {% set hopened =
      (opened_at_map[hid] if opened_at_map is defined and hid in opened_at_map else
       (h.opened_at if h.opened_at is defined else (h['opened_at'] if h is mapping and 'opened_at' in h else None)))
    %}
    {% set hstatus = h.status if h.status is defined else (h['status'] if h is mapping and 'status' in h else '') %}

    {% set items = (items_map.get(hid, []) if items_map is defined else []) %}
    {% set ns = namespace(subtotal=0, tax=0, total=0) %}
    {% for d in items %}
      {% set qty   = (d['æ•°é‡'] if 'æ•°é‡' in d else 0) | int %}
      {% set excl  = (d['ç¨æŠœå˜ä¾¡'] if 'ç¨æŠœå˜ä¾¡' in d else 0) | int %}
      {% set rate  = (d['ç¨ç‡'] if 'ç¨ç‡' in d else 0.10) | float %}
      {% set unit_tax = (excl * rate) | round(0, 'floor') | int %}
      {% set incl  = (d['ç¨è¾¼å˜ä¾¡'] if 'ç¨è¾¼å˜ä¾¡' in d else (excl + unit_tax)) | int %}
      {% set label_raw = (d['çŠ¶æ…‹'] if 'çŠ¶æ…‹' in d else '') | string %}
      {% set label = label_raw|lower %}
      {% set is_cancel = label in ['å–æ¶ˆ','ï½·ï½¬ï¾ï½¾ï¾™','ã‚­ãƒ£ãƒ³ã‚»ãƒ«','cancel','void'] %}
      {% if qty != 0 and (qty < 0 or not is_cancel) %}
        {% set ns.subtotal = ns.subtotal + (excl * qty) %}
        {% set ns.tax      = ns.tax      + (unit_tax * qty) %}
        {% set ns.total    = ns.total    + (incl * qty) %}
      {% endif %}
    {% endfor %}

    <div class="card">
      <div>
        ä¼ç¥¨ID: {{ hid }} / åˆè¨ˆ: Â¥{{ ns.total }}
        {% if hopened %} / é–‹å§‹: {{ hopened }}{% endif %}
      </div>
      <div class="small muted" style="margin-top:4px">
        å°è¨ˆ(ç¨æŠœ): Â¥{{ ns.subtotal }} / ç¨é¡: Â¥{{ ns.tax }}
      </div>

      {% if not is_qr_user %}
      <div class="small" style="margin-top:6px">
        ä¼ç¥¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:
        <select class="js-hdr-status" data-order-id="{{ hid }}">
          {% set hdr_opts = ['æ–°è¦','èª¿ç†ä¸­','æä¾›æ¸ˆ','ä¼šè¨ˆä¸­','ä¼šè¨ˆæ¸ˆ'] %}
          {% for opt in hdr_opts %}
            <option value="{{ opt }}" {{ 'selected' if opt == hstatus else '' }}>{{ opt }}</option>
          {% endfor %}
        </select>
        <span class="small muted js-hdr-save-result" data-order-id="{{ hid }}"></span>
      </div>
      {% endif %}
    </div>

    <!-- â˜… é¸æŠã—ãŸæ˜ç´°ã®ä¸€æ‹¬æ“ä½œãƒœã‚¿ãƒ³ -->
    {% if not is_qr_user %}
    <div id="bulk-actions-{{ hid }}" class="bulk-actions-panel" style="display:none; margin:12px 0; padding:12px; background:#f3f4f6; border-radius:8px; border:1px solid #d1d5db;">
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <span style="font-weight:600; font-size:16px;">é¸æŠã—ãŸæ˜ç´°: <span class="selected-count" data-order-id="{{ hid }}">0</span>ä»¶</span>
        <button type="button" class="bulk-btn bulk-new" data-order-id="{{ hid }}" style="padding:10px 20px; background:#6b7280; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">
          ğŸ“ ä¸€æ‹¬æ–°è¦
        </button>
        {% if use_cooking_status %}
        <button type="button" class="bulk-btn bulk-cooking" data-order-id="{{ hid }}" style="padding:10px 20px; background:#3b82f6; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">
          ğŸ‘¨â€ğŸ³ ä¸€æ‹¬èª¿ç†ä¸­
        </button>
        {% endif %}
        <button type="button" class="bulk-btn bulk-served" data-order-id="{{ hid }}" style="padding:10px 20px; background:#10b981; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">
          âœ… ä¸€æ‹¬æä¾›æ¸ˆ
        </button>
        <button type="button" class="bulk-btn bulk-cancel" data-order-id="{{ hid }}" style="padding:10px 20px; background:#ef4444; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">
          âŒ ä¸€æ‹¬å–æ¶ˆ
        </button>
      </div>
    </div>
    {% endif %}

    {% if items and items|length > 0 %}
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" id="select-all-{{ hid }}" class="select-all-checkbox" data-order-id="{{ hid }}" title="å…¨é¸æŠ"></th>
            <th>ID</th>
            <th>å“å</th>
            <th>æ•°é‡</th>
            <th>å˜ä¾¡<br><span class="small muted">(ç¨è¾¼ / ç¨æŠœ)</span></th>
            <th>å°è¨ˆ<br><span class="small muted">(ç¨è¾¼ / ç¨æŠœ)</span></th>
            <!-- çŠ¶æ…‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ“ä½œãƒ‘ãƒãƒ«ã‚’é–‹ãï¼‰ -->
            <th>çŠ¶æ…‹</th>
            <th>ãƒ¡ãƒ¢</th>
            <!-- æ“ä½œï¼ˆãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ã®è¡¨ç¤ºå ´æ‰€ï¼‰ -->
            <th>æ“ä½œ</th>
            <th>æ³¨æ–‡</th>
          </tr>
        </thead>
        <tbody>
          {% for d in items %}
            {% set did      = d['id'] if 'id' in d else '' %}
            {% set name     = d['åç§°'] if 'åç§°' in d else '' %}
            {% set qty      = (d['æ•°é‡'] if 'æ•°é‡' in d else 0) | int %}
            {% set excl     = (d['ç¨æŠœå˜ä¾¡'] if 'ç¨æŠœå˜ä¾¡' in d else 0) | int %}
            {% set rate     = (d['ç¨ç‡'] if 'ç¨ç‡' in d else 0.10) | float %}
            {% set unit_tax = (excl * rate) | round(0, 'floor') | int %}
            {% set incl     = (d['ç¨è¾¼å˜ä¾¡'] if 'ç¨è¾¼å˜ä¾¡' in d else (excl + unit_tax)) | int %}
            {% set label    = (d['çŠ¶æ…‹'] if 'çŠ¶æ…‹' in d else 'æ–°è¦') | string %}
            {% set is_cancel = label|lower in ['å–æ¶ˆ','ï½·ï½¬ï¾ï½¾ï¾™','ã‚­ãƒ£ãƒ³ã‚»ãƒ«','cancel','void'] %}
            {% set is_cancel_positive = is_cancel and (qty > 0) %}
            {% set is_negative = qty < 0 %}

            {% set prog = (d['progress'] if 'progress' in d else {}) %}
            {% set qty_new = (prog.get('qty_new', 0) if prog else 0) | int %}
            {% set qty_cooking = (prog.get('qty_cooking', 0) if prog else 0) | int %}
            {% set qty_served = (prog.get('qty_served', 0) if prog else 0) | int %}
            {% set qty_canceled = (prog.get('qty_canceled', 0) if prog else 0) | int %}

            {# â˜… ã“ã“ã‚’ç°¡æ½”ã«ä¿®æ­£ï¼ˆã‚«ãƒƒã‚³éå¤šã‚¨ãƒ©ãƒ¼å›é¿ï¼‰ #}
            {% set ordered_at = d.get('ordered_at') or d.get('added_at') or d.get('created_at') or d.get('è¿½åŠ æ—¥æ™‚') %}

            {% set sub_excl = (is_cancel_positive and 0 or (excl * qty)) %}
            {% set sub_incl = (is_cancel_positive and 0 or (incl * qty)) %}
            {% set is_all_canceled = (qty_canceled >= qty and qty > 0) %}

            <tr class="{% if is_negative %}neg-row{% elif is_cancel %}muted{% endif %}" data-item-id="{{ did }}">
              <td>
                {% if not is_negative and not is_cancel and not is_all_canceled %}
                  <input type="checkbox" class="item-checkbox" data-item-id="{{ did }}" data-order-id="{{ hid }}">
                {% endif %}
              </td>
              <td>{{ did }}</td>
              <td>
                {{ name }}
                {# å–æ¶ˆãƒãƒƒã‚¸ã¯ãƒã‚¤ãƒŠã‚¹ç›£æŸ»è¡Œã ã‘ã«è¡¨ç¤º #}
                {% if is_negative %}<span class="void-badge">å–æ¶ˆ</span>{% endif %}
              </td>
              <td>{{ qty }}</td>
              <td>
                {% if d.get('is_market_price', False) and excl == 0 %}
                  <strong style="color:#e11d48">æ™‚ä¾¡</strong><br><span class="small muted">ä¾¡æ ¼æœªç¢ºå®š</span>
                {% else %}
                  ç¨è¾¼ ï¿¥{{ incl }}<br><span class="small muted">ç¨æŠœ ï¿¥{{ excl }}</span>
                {% endif %}
                {% if not is_qr_user and d.get('is_market_price', False) %}
                  {% if excl == 0 %}
                    <br><button class="btn btn-sm" onclick="openMarketPriceModal({{ did }}, '{{ name }}', {{ hid }})"
                            style="margin-top:4px;font-size:0.8em;padding:2px 6px;background:#fbbf24;color:#000">ğŸ’° ä¾¡æ ¼è¨­å®š</button>
                  {% else %}
                    <br><button class="btn btn-sm" onclick="openEditPriceModal({{ did }}, '{{ name }}', {{ hid }}, {{ excl }}, {{ incl }})"
                            style="margin-top:4px;font-size:0.8em;padding:2px 6px;background:#3b82f6;color:#fff">âœï¸ ä¾¡æ ¼ä¿®æ­£</button>
                  {% endif %}
                {% endif %}
              </td>
              <td>ç¨è¾¼ Â¥{{ sub_incl }}<br><span class="small muted">ç¨æŠœ Â¥{{ sub_excl }}</span></td>

              <!-- çŠ¶æ…‹ï¼šå„ãƒãƒƒã‚¸ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼ˆdata-src, data-count ã‚’æŒã¤ï¼‰ -->
              <td>
                {% if is_negative %}
                  {# å–æ¶ˆè¡Œï¼ˆãƒã‚¤ãƒŠã‚¹æ•°é‡ï¼‰ã¯æ£’ç·šè¡¨ç¤º #}
                  <div class="progress-detail">
                    <span class="muted">ãƒ¼</span>
                  </div>
                {% else %}
                  <div class="progress-detail">
                    <span class="status-chip chip-new"
                          data-role="chip" data-src="new" data-count="{{ qty_new }}"
                          data-item-id="{{ did }}">æ–°è¦: {{ qty_new }}</span>
                    <span class="status-chip chip-cooking"
                          data-role="chip" data-src="cooking" data-count="{{ qty_cooking }}"
                          data-item-id="{{ did }}">èª¿ç†ä¸­: {{ qty_cooking }}</span>
                    <span class="status-chip chip-served"
                          data-role="chip" data-src="served" data-count="{{ qty_served }}"
                          data-item-id="{{ did }}">æä¾›æ¸ˆ: {{ qty_served }}</span>
                    <span class="status-chip chip-canceled"
                          data-role="chip" data-src="canceled" data-count="{{ qty_canceled }}"
                          data-item-id="{{ did }}">å–æ¶ˆ: {{ qty_canceled }}</span>
                  </div>
                {% endif %}
              </td>

              <!-- ãƒ¡ãƒ¢ -->
              <td>
                {% set memo = d.get('ãƒ¡ãƒ¢', '') %}
                {% if memo %}
                  <span class="small">{{ memo }}</span>
                {% endif %}
              </td>

              <!-- æ“ä½œï¼šãƒãƒƒãƒ—ã‚’å·®ã—è¾¼ã‚€ãŸã‚ã®ãƒ›ã‚¹ãƒˆ -->
              <td>
                <div class="action-host" data-item-id="{{ did }}"></div>
                <span class="small muted js-save-result" data-item-id="{{ did }}"></span>
              </td>

              <td class="time-cell">{% if ordered_at %}<span class="small">{{ ordered_at }}</span>{% endif %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="card muted">ã“ã®ä¼ç¥¨ã«æ˜ç´°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    {% endif %}
  {% endfor %}

{% elif order is defined and order %}
  <div class="card">
    <div>æ³¨æ–‡ID: {{ order['id'] }}</div>
    <div>å°è¨ˆ(ç¨æŠœ): Â¥{{ order['å°è¨ˆ'] }} / ç¨é¡: Â¥{{ order['ç¨é¡'] }} / åˆè¨ˆ(ç¨è¾¼): Â¥{{ order['åˆè¨ˆ'] }}</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th><th>å“å</th><th>æ•°é‡</th>
        <th>å˜ä¾¡<br><span class="small muted">(ç¨è¾¼ / ç¨æŠœ)</span></th>
        <th>å°è¨ˆ<br><span class="small muted">(ç¨è¾¼ / ç¨æŠœ)</span></th>
        <th>çŠ¶æ…‹</th><th>ãƒ¡ãƒ¢</th><th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      {% for d in details %}
        {% set excl = d['å˜ä¾¡'] %}{% set rate = d['ç¨ç‡'] or 0 %}
        {% set incl = excl + ((excl * rate)|round(0, 'floor')) %}
        {% set sub_excl = excl * d['æ•°é‡'] %}{% set sub_incl = incl * d['æ•°é‡'] %}
        <tr>
          <td>{{ d['id'] }}</td><td>{{ d['åç§°'] }}</td><td>{{ d['æ•°é‡'] }}</td>
          <td>ç¨è¾¼ Â¥{{ incl }}<br><span class="small muted">ç¨æŠœ Â¥{{ excl }}</span></td>
          <td>ç¨è¾¼ Â¥{{ sub_incl }}<br><span class="small muted">ç¨æŠœ Â¥{{ sub_excl }}</span></td>
          <td>{{ d['çŠ¶æ…‹'] }}</td>
          <td>
            {% set memo = d.get('ãƒ¡ãƒ¢', '') %}
            {% if memo %}<span class="small">{{ memo }}</span>{% endif %}
          </td>
          <td></td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

{% else %}
  <div class="card">æœªæ³¨æ–‡</div>
{% endif %}

<div style="display: flex; gap: 10px; margin-top: 20px;">
  {% if orders and orders[0] and not is_qr_user %}
  <a class="btn" href="{{ url_for('receipt_print', order_id=orders[0].id) }}" target="_blank" style="background: #2563eb; color: white;">
    ğŸ“ ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·
  </a>
  <a class="btn" href="{{ url_for('invoice_print', order_id=orders[0].id) }}" target="_blank" style="background: #059669; color: white;">
    ğŸ“„ é ˜åæ›¸å°åˆ·
  </a>
  <a class="btn" href="{{ url_for('bill_print', order_id=orders[0].id) }}" target="_blank" style="background: #f59e0b; color: white;">
    ğŸ´ æ³¨æ–‡ä¼ç¥¨å°åˆ·
  </a>
  {% endif %}
  <a id="btn-back" class="btn" href="{{ url_for('floor') }}">æˆ»ã‚‹</a>
</div>

<script>
  (function () {
    var back = document.getElementById('btn-back');
    if (!back) return;
    back.addEventListener('click', function (e) {
      e.preventDefault();
      var hasHistory = (document.referrer && document.referrer !== location.href) || (history.length > 1);
      if (hasHistory) { history.back(); } else { location.href = "{{ url_for('floor') }}"; }
    });
  })();
</script>

<script>
  (function () {
    const CSRF = "{{ csrf_token or '' }}";
    const IS_QR_USER = {{ 'true' if is_qr_user else 'false' }};

    async function postJSON(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": CSRF },
        body: JSON.stringify(body || {})
      });
      return res.json().catch(() => ({}));
    }
    function clamp(n, lo, hi){ n = Number(n || 0); return Math.max(lo, Math.min(hi, n)); }

    /* â–¼ çŠ¶æ…‹â†’é·ç§»å…ˆã®è¨±å¯ãƒ«ãƒ¼ãƒ«ï¼ˆå·»ãæˆ»ã—è¨±å¯ã‚’è¿½åŠ ï¼‰ */
    const ALLOW = {
      new:      ["èª¿ç†ä¸­","æä¾›æ¸ˆ","å–æ¶ˆ"],
      cooking:  ["æ–°è¦","æä¾›æ¸ˆ","å–æ¶ˆ"],
      served:   ["æ–°è¦","èª¿ç†ä¸­","å–æ¶ˆ"],
      canceled: []
    };

    function statusLabel(srcKey){
      return srcKey==="new"?"æ–°è¦":srcKey==="cooking"?"èª¿ç†ä¸­":srcKey==="served"?"æä¾›æ¸ˆ":"å–æ¶ˆ";
    }

    function refreshChips(rowEl, p){
      const map = {
        new: Number(p.qty_new||0),
        cooking: Number(p.qty_cooking||0),
        served: Number(p.qty_served||0),
        canceled: Number(p.qty_canceled||0),
      };
      rowEl.querySelectorAll('[data-role="chip"]').forEach(chip=>{
        const k = chip.dataset.src;
        const v = map[k]||0;
        chip.dataset.count = String(v);
        chip.textContent = statusLabel(k) + ": " + v;
      });
    }

    function openActionPop(itemId, srcKey, maxCount, anchorEl){
      document.querySelectorAll('.action-pop').forEach(p=>p.remove());

      const host = document.querySelector(`.action-host[data-item-id="${itemId}"]`);
      if (!host) return;

      const targets = ALLOW[srcKey] || [];
      const pop = document.createElement('div');
      pop.className = 'action-pop';
      pop.innerHTML = `
        <span class="badge-src">${statusLabel(srcKey)} â†’</span>
        <select class="js-target">
          ${targets.map(t => `<option value="${t}">${t}</option>`).join('')}
        </select>
        <input type="number" class="js-count" min="1" value="${maxCount>0?maxCount:1}">
        <button type="button" class="btn primary js-apply">é©ç”¨</button>
        <button type="button" class="btn sub js-cancel">é–‰ã˜ã‚‹</button>
      `;
      host.appendChild(pop);

      const countInput = pop.querySelector('.js-count');
      countInput.max = String(Math.max(1, maxCount));
      countInput.value = String(Math.max(1, Math.min(maxCount||1, Number(countInput.value||1))));

      pop.querySelector('.js-cancel').addEventListener('click', ()=>pop.remove());
      pop.addEventListener('keydown', (e)=>{ if(e.key==='Escape') pop.remove(); });

      pop.querySelector('.js-apply').addEventListener('click', async ()=>{
        const to = pop.querySelector('.js-target').value;
        const cnt = clamp(countInput.value, 1, Math.max(1, maxCount||1));
        const hint = document.querySelector(`.js-save-result[data-item-id="${itemId}"]`);
        if (hint) hint.textContent = "ä¿å­˜ä¸­â€¦";
        try{
          const json = await postJSON(`/staff/api/order_item/${itemId}/status`, {
            status: to,
            from_status: statusLabel(srcKey),
            count: cnt
          });
          if (json && (json.ok || json.status==='success')){
            if (hint) hint.textContent = `âœ“ ${statusLabel(srcKey)} ã‹ã‚‰ ${to} ã« ${cnt}å€‹å¤‰æ›´`;
            if (json.progress){
              const tr = host.closest('tr');
              refreshChips(tr, json.progress);
            }
            pop.remove();
            setTimeout(()=>location.reload(), 400);
          }else{
            if (hint) hint.textContent = "Ã— å¤±æ•—" + (json && (json.error||json.message)?(": "+(json.error||json.message)):"");
          }
        }catch(e){
          if (hint) hint.textContent = "Ã— é€šä¿¡ã‚¨ãƒ©ãƒ¼";
        }
        setTimeout(()=>{ if(hint) hint.textContent = ""; }, 2500);
      });
    }

    document.querySelectorAll('[data-role="chip"]').forEach(chip=>{
      // QRãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯çŠ¶æ…‹å¤‰æ›´ã‚’ç„¡åŠ¹åŒ–
      if (IS_QR_USER) {
        chip.style.cursor = 'default';
        chip.style.opacity = '0.7';
        return;
      }
      
      chip.addEventListener('click', function(){
        const itemId = this.dataset.itemId;
        const srcKey = this.dataset.src;
        const maxCount = Number(this.dataset.count || 0);
        if (!ALLOW[srcKey] || ALLOW[srcKey].length===0 || maxCount<=0){
          return;
        }
        openActionPop(itemId, srcKey, maxCount, this);
      });
    });

    document.querySelectorAll("select.js-hdr-status").forEach(function(sel){
      sel.addEventListener("change", async function(){
        const orderId = this.dataset.orderId;
        const val = this.value;
        const hint = document.querySelector(`.js-hdr-save-result[data-order-id="${orderId}"]`);
        if (hint) hint.textContent = "ä¿å­˜ä¸­â€¦";
        try {
          const json = await postJSON(`/staff/api/order/${orderId}/status`, {status: val});
          if (json && (json.ok || json.status==='success')) {
            if (hint) hint.textContent = "âœ“ ä¿å­˜ã—ã¾ã—ãŸ";
          } else {
            if (hint) hint.textContent = "Ã— å¤±æ•—" + (json && (json.error||json.message) ? (": " + (json.error||json.message)) : "");
          }
        } catch(e){
          if (hint) hint.textContent = "Ã— é€šä¿¡ã‚¨ãƒ©ãƒ¼";
        }
        setTimeout(()=>{ if(hint) hint.textContent = ""; }, 1500);
      });
    });
  })();
</script>

<!-- æ™‚ä¾¡å•†å“ã®ä¾¡æ ¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="market-price-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:white; padding:30px; border-radius:8px; max-width:500px; width:90%;">
    <h3 style="margin-top:0">æ™‚ä¾¡å•†å“ã®ä¾¡æ ¼è¨­å®š</h3>
    <p id="market-price-item-name" style="font-weight:bold; margin-bottom:20px;"></p>
    
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px;">ä¾¡æ ¼å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰:</label>
      <label style="margin-right:15px;"><input type="radio" name="detail_price_mode" value="excl" checked> ç¨æŠœä¾¡æ ¼ã§å…¥åŠ›</label>
      <label><input type="radio" name="detail_price_mode" value="incl"> ç¨è¾¼ä¾¡æ ¼ã§å…¥åŠ›</label>
    </div>
    
    <div style="margin-bottom:20px;">
      <label style="display:block; margin-bottom:5px;">ä¾¡æ ¼ï¼ˆå††ï¼‰:</label>
      <input type="number" id="market-price-input" style="width:100%; padding:8px; font-size:1.1em;" min="0" step="1" />
    </div>
    
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button class="btn" onclick="closeMarketPriceModal()" style="background:#6b7280;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn" onclick="saveMarketPrice()" style="background:#059669; color:white;">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ä¾¡æ ¼ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="edit-price-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:white; padding:30px; border-radius:8px; max-width:500px; width:90%;">
    <h3 style="margin-top:0">ä¾¡æ ¼ã®ä¿®æ­£</h3>
    <p id="edit-price-item-name" style="font-weight:bold; margin-bottom:20px;"></p>
    
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px;">ä¾¡æ ¼å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰:</label>
      <label style="margin-right:15px;"><input type="radio" name="edit_price_mode" value="excl"> ç¨æŠœä¾¡æ ¼ã§å…¥åŠ›</label>
      <label><input type="radio" name="edit_price_mode" value="incl" checked> ç¨è¾¼ä¾¡æ ¼ã§å…¥åŠ›</label>
    </div>
    
    <div style="margin-bottom:20px;">
      <label style="display:block; margin-bottom:5px;">ä¾¡æ ¼ï¼ˆå††ï¼‰:</label>
      <input type="number" id="edit-price-input" style="width:100%; padding:8px; font-size:1.1em;" min="0" step="1" />
    </div>
    
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button class="btn" onclick="closeEditPriceModal()" style="background:#6b7280;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn" onclick="saveEditPrice()" style="background:#3b82f6; color:white;">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
  let _marketPriceContext = null;
  
  function openMarketPriceModal(itemId, itemName, orderId) {
    _marketPriceContext = { itemId, itemName, orderId };
    document.getElementById('market-price-item-name').textContent = itemName;
    document.getElementById('market-price-input').value = '';
    document.getElementById('market-price-modal').style.display = 'flex';
  }
  
  function closeMarketPriceModal() {
    document.getElementById('market-price-modal').style.display = 'none';
    _marketPriceContext = null;
  }
  
  async function saveMarketPrice() {
    if (!_marketPriceContext) return;
    
    const price = parseInt(document.getElementById('market-price-input').value);
    if (!price || price <= 0) {
      alert('æœ‰åŠ¹ãªä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    const mode = document.querySelector('input[name="detail_price_mode"]:checked').value;
    
    try {
      const res = await fetch(`/admin/order_item/${_marketPriceContext.itemId}/set_price`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ price, mode })
      });
      
      const json = await res.json();
      if (json.ok) {
        alert('ä¾¡æ ¼ã‚’è¨­å®šã—ã¾ã—ãŸã€‚');
        closeMarketPriceModal();
        location.reload();
      } else {
        alert('ã‚¨ãƒ©ãƒ¼: ' + (json.error || 'ä¾¡æ ¼è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚'));
      }
    } catch (e) {
      alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
  }
  
  // ä¾¡æ ¼ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®é–¢æ•°
  let _editPriceContext = null;
  
  function openEditPriceModal(itemId, itemName, orderId, currentExcl, currentIncl) {
    _editPriceContext = { itemId, itemName, orderId, currentExcl, currentIncl };
    document.getElementById('edit-price-item-name').textContent = itemName;
    document.getElementById('edit-price-input').value = currentIncl; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç¨è¾¼ä¾¡æ ¼ã‚’è¡¨ç¤º
    document.getElementById('edit-price-modal').style.display = 'flex';
  }
  
  function closeEditPriceModal() {
    document.getElementById('edit-price-modal').style.display = 'none';
    _editPriceContext = null;
  }
  
  async function saveEditPrice() {
    if (!_editPriceContext) return;
    
    const price = parseInt(document.getElementById('edit-price-input').value);
    if (!price || price <= 0) {
      alert('æœ‰åŠ¹ãªä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    const mode = document.querySelector('input[name="edit_price_mode"]:checked').value;
    
    try {
      const res = await fetch(`/admin/order_item/${_editPriceContext.itemId}/set_price`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ price, mode })
      });
      
      const json = await res.json();
      if (json.ok) {
        alert('ä¾¡æ ¼ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚');
        closeEditPriceModal();
        location.reload();
      } else {
        alert('ã‚¨ãƒ©ãƒ¼: ' + (json.error || 'ä¾¡æ ¼ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'));
      }
    } catch (e) {
      alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
  }
  
  /* ============ æ³¨æ–‡ä¼ç¥¨å°åˆ· ============ */
  // æ³¨: æ³¨æ–‡ä¼ç¥¨å°åˆ·ã¯/bill/<order_id>ã¸ã®ãƒªãƒ³ã‚¯ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã«ç§»è¡Œã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸ

  /* ============ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¸æŠæ©Ÿèƒ½ ============ */
  function updateSelectedCount(orderId) {
    const checkboxes = document.querySelectorAll(`.item-checkbox[data-order-id="${orderId}"]:checked`);
    const count = checkboxes.length;
    const selectedCountEl = document.querySelector(`.selected-count[data-order-id="${orderId}"]`);
    const bulkActionsEl = document.getElementById(`bulk-actions-${orderId}`);
    
    if (selectedCountEl) selectedCountEl.textContent = count;
    if (bulkActionsEl) bulkActionsEl.style.display = count > 0 ? 'block' : 'none';
  }

  function getSelectedItemIds(orderId) {
    const checkboxes = document.querySelectorAll(`.item-checkbox[data-order-id="${orderId}"]:checked`);
    return Array.from(checkboxes).map(cb => cb.dataset.itemId);
  }

  async function bulkChangeStatusInDetail(orderId, status) {
    console.log('[BULK-DETAIL] Starting bulkChangeStatusInDetail, orderId:', orderId, 'status:', status);
    const itemIds = getSelectedItemIds(orderId);
    console.log('[BULK-DETAIL] Selected itemIds:', itemIds);
    if (itemIds.length === 0) {
      alert('æ˜ç´°ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    const confirmMsg = `é¸æŠã—ãŸ${itemIds.length}ä»¶ã®æ˜ç´°ã‚’ã€Œ${status}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`;
    if (!confirm(confirmMsg)) {
      console.log('[BULK-DETAIL] User cancelled');
      return;
    }
    
    try {
      for (const itemId of itemIds) {
        console.log('[BULK-DETAIL] Processing itemId:', itemId);
        // æ˜ç´°è¡Œã‹ã‚‰æ•°é‡ã‚’å–å¾—
        const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
        console.log('[BULK-DETAIL] Found row:', !!row);
        let count = 1;
        if (row) {
          const qtyCell = row.querySelector('td:nth-child(4)');
          console.log('[BULK-DETAIL] Found qtyCell:', !!qtyCell, 'textContent:', qtyCell?.textContent);
          if (qtyCell) {
            const qty = Math.abs(Number(qtyCell.textContent || 0));
            console.log('[BULK-DETAIL] Parsed qty:', qty);
            if (qty > 0) count = qty;
          }
        }
        console.log('[BULK-DETAIL] Final count:', count);
        
        const payload = { status: status, count: count };
        console.log('[BULK-DETAIL] Sending request to /staff/api/order_item/' + itemId + '/status with payload:', payload);
        const res = await fetch(`/staff/api/order_item/${itemId}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        console.log('[BULK-DETAIL] Response status:', res.status, 'ok:', res.ok);
        if (!res.ok) {
          throw new Error(`æ˜ç´°ID ${itemId} ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ`);
        }
      }
      alert(`${itemIds.length}ä»¶ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã—ã¾ã—ãŸ`);
      
      // å…¨é¸æŠã‚’è§£é™¤
      const selectAllCheckbox = document.getElementById(`select-all-${orderId}`);
      if (selectAllCheckbox) selectAllCheckbox.checked = false;
      document.querySelectorAll(`.item-checkbox[data-order-id="${orderId}"]`).forEach(cb => cb.checked = false);
      updateSelectedCount(orderId);
      
      // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°ã•ã‚ŒãŸçŠ¶æ…‹ã‚’è¡¨ç¤º
      location.reload();
    } catch(e) {
      console.error('bulkChangeStatusInDetail error:', e);
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
    }
  }

  // â˜… å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  document.addEventListener('change', (e) => {
    if (e.target && e.target.classList.contains('select-all-checkbox')) {
      const orderId = e.target.dataset.orderId;
      const isChecked = e.target.checked;
      document.querySelectorAll(`.item-checkbox[data-order-id="${orderId}"]`).forEach(cb => {
        cb.checked = isChecked;
      });
      updateSelectedCount(orderId);
    }
  });

  // â˜… å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  document.addEventListener('change', (e) => {
    if (e.target && e.target.classList.contains('item-checkbox')) {
      const orderId = e.target.dataset.orderId;
      updateSelectedCount(orderId);
      
      // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
      const allCheckboxes = document.querySelectorAll(`.item-checkbox[data-order-id="${orderId}"]`);
      const checkedCheckboxes = document.querySelectorAll(`.item-checkbox[data-order-id="${orderId}"]:checked`);
      const selectAllCheckbox = document.getElementById(`select-all-${orderId}`);
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;
      }
    }
  });

  // â˜… ä¸€æ‹¬æ“ä½œãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  document.addEventListener('click', (e) => {
    if (e.target && e.target.classList.contains('bulk-btn')) {
      const orderId = e.target.dataset.orderId;
      let status = '';
      if (e.target.classList.contains('bulk-new')) status = 'æ–°è¦';
      else if (e.target.classList.contains('bulk-cooking')) status = 'èª¿ç†ä¸­';
      else if (e.target.classList.contains('bulk-served')) status = 'æä¾›æ¸ˆ';
      else if (e.target.classList.contains('bulk-cancel')) status = 'å–æ¶ˆ';
      if (status) bulkChangeStatusInDetail(orderId, status);
    }
  });
</script>

{% endblock %}
