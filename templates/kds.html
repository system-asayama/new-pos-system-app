{% extends "base.html" %}
{% block content %}
<h2>KDSï¼ˆã‚­ãƒƒãƒãƒ³ãƒ»ãƒ‰ãƒªãƒ³ã‚«ãƒ¼ï¼‰</h2>

<!-- â–¼ åº—å“¡å‘¼ã³å‡ºã—è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆãƒªã‚¹ãƒˆå½¢å¼ï¼‰ -->
<div id="staff-call-alert" style="display:none; background:#fef3c7; border:2px solid #f59e0b; border-radius:8px; padding:12px 16px; margin:12px 0; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
  <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
    <span style="font-size:32px;">ğŸ””</span>
    <div style="font-size:18px; font-weight:700; color:#92400e;">åº—å“¡å‘¼ã³å‡ºã—</div>
  </div>
  <div id="staff-call-list" style="display:flex; flex-direction:column; gap:8px;"></div>
</div>

<!-- â–¼ ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæœ€åˆã¯å…¨ã¦æœªé¸æŠï¼‰ -->
<div id="cat-bar" style="display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 12px; align-items:center;">
  <button type="button" id="btn-all" class="cat-btn all" data-id="__ALL__">ã™ã¹ã¦</button>
  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <label style="margin:0; display:flex; align-items:center; gap:4px; font-size:14px;">
      <input type="checkbox" id="sound-toggle" checked>
      <span>é€šçŸ¥éŸ³</span>
    </label>
  </div>
</div>
<style>
  /* â˜… KDSç”»é¢å…¨ä½“ã‚’ä½¿ã†ã‚¹ã‚¿ã‚¤ãƒ« */
  body { font-size: 18px; }
  main { max-width: 100% !important; margin: 12px !important; padding: 0 12px !important; }
  h2 { font-size: 28px; margin-bottom: 16px; }
  
  .cat-btn{ padding:10px 16px; border:1px solid #d1d5db; border-radius:8px; background:#fff; cursor:pointer; font-size:16px; }
  .cat-btn.active{ background:#2563eb; color:#fff; border-color:#1d4ed8; }
  .cat-btn.all{ font-weight:600; }

  /* â˜… ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤§ãã */
  #kds-table { width: 100%; font-size: 18px; }
  #kds-table th { font-size: 20px; padding: 14px 12px; background: #f3f4f6; font-weight: 700; }
  #kds-table td { padding: 16px 12px; font-size: 18px; }
  #kds-table tbody tr:hover { background: #f9fafb; }
  
  /* â˜… KDS è¡Œã®æ“ä½œUI */
  .ops{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .ops button { padding: 12px 18px; font-size: 16px; border: 1px solid #d1d5db; border-radius: 8px; background: #fff; cursor: pointer; font-weight: 600; }
  .ops button:hover { background: #f3f4f6; }
  .ops .count-wrap{ display:inline-flex; gap:8px; align-items:center; }
  .ops .count-input{ width:80px; padding:8px 10px; font-size:16px; }
  .ops .small { font-size: 14px; }
</style>
<!-- â–² -->

<table id="kds-table">
  <thead>
    <!-- â˜… ã€Œæ™‚åˆ»ã€åˆ—ã‚’è¿½åŠ ï¼ˆå“ã®æ¬¡ï¼‰ -->
    <tr><th>#</th><th>å“</th><th>æ™‚åˆ»</th><th>å“å</th><th>æ•°</th><th>ãƒ¡ãƒ¢</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th></tr>
  </thead>
  <tbody id="tbody"><!-- åˆæœŸã¯ç©º --></tbody>
</table>

<script>
const KDS_API_URL = "{{ url_for('kds_api_get_items') }}";
const API_CATS    = "{{ url_for('api_kds_categories') }}";

/* ====== ãƒ‡ãƒãƒƒã‚°è¨­å®š ====== */
const DEBUG_KDS = true;

/* ====== è‡ªå‹•æ›´æ–°ã®â€œç·¨é›†ãƒ­ãƒƒã‚¯â€ ====== */
const EDIT_LOCK_MS = 5000;
let refreshPauseUntil = 0;
function pauseRefresh(ms){ refreshPauseUntil = Math.max(refreshPauseUntil, Date.now() + (ms||EDIT_LOCK_MS)); }
function canRefresh(){ return Date.now() >= refreshPauseUntil; }

/* ====== ä¸€æ‹¬æ“ä½œé–¢æ•° ====== */
async function bulkCooking(itemIdsStr) {
  if (!confirm('é¸æŠã—ãŸæ³¨æ–‡ã‚’ä¸€æ‹¬ã§ã€Œèª¿ç†ä¸­ã€ã«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const itemIds = itemIdsStr.split(',').map(id => parseInt(id, 10));
  for (const itemId of itemIds) {
    // å„å•†å“ã®æ•°é‡ã‚’ç”»é¢ã‹ã‚‰å–å¾—
    const tr = document.querySelector(`tr[data-key="${itemId}"]`);
    let count = 1;
    if (tr) {
      const qtyCell = tr.children[4]; // 5ç•ªç›®ã®ã‚»ãƒ«ãŒæ•°é‡
      if (qtyCell) {
        const qty = Math.abs(Number(qtyCell.textContent || 0));
        if (qty > 0) count = qty;
      }
    }
    await chgById(itemId, 'èª¿ç†ä¸­', count);
  }
  fetchAndUpdateKds(false);
}

async function bulkServed(itemIdsStr) {
  if (!confirm('é¸æŠã—ãŸæ³¨æ–‡ã‚’ä¸€æ‹¬ã§ã€Œæä¾›æ¸ˆã€ã«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const itemIds = itemIdsStr.split(',').map(id => parseInt(id, 10));
  for (const itemId of itemIds) {
    // å„å•†å“ã®æ•°é‡ã‚’ç”»é¢ã‹ã‚‰å–å¾—
    const tr = document.querySelector(`tr[data-key="${itemId}"]`);
    let count = 1;
    if (tr) {
      const qtyCell = tr.children[4]; // 5ç•ªç›®ã®ã‚»ãƒ«ãŒæ•°é‡
      if (qtyCell) {
        const qty = Math.abs(Number(qtyCell.textContent || 0));
        if (qty > 0) count = qty;
      }
    }
    await chgById(itemId, 'æä¾›æ¸ˆ', count);
  }
  fetchAndUpdateKds(false);
}

async function bulkCancel(itemIdsStr) {
  if (!confirm('é¸æŠã—ãŸæ³¨æ–‡ã‚’ä¸€æ‹¬ã§ã€Œå–æ¶ˆã€ã«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const itemIds = itemIdsStr.split(',').map(id => parseInt(id, 10));
  for (const itemId of itemIds) {
    // å„å•†å“ã®æ•°é‡ã‚’ç”»é¢ã‹ã‚‰å–å¾—
    const tr = document.querySelector(`tr[data-key="${itemId}"]`);
    let count = 1;
    if (DEBUG_KDS) console.log(`[BULK CANCEL] itemId=${itemId}, tr found:`, !!tr);
    if (tr) {
      const qtyCell = tr.children[4]; // 5ç•ªç›®ã®ã‚»ãƒ«ãŒæ•°é‡
      if (DEBUG_KDS) console.log(`[BULK CANCEL] qtyCell:`, qtyCell, 'textContent:', qtyCell?.textContent);
      if (qtyCell) {
        const qty = Math.abs(Number(qtyCell.textContent || 0));
        if (DEBUG_KDS) console.log(`[BULK CANCEL] qty=${qty}`);
        if (qty > 0) count = qty;
      }
    }
    if (DEBUG_KDS) console.log(`[BULK CANCEL] final count=${count}`);
    await chgById(itemId, 'å–æ¶ˆ', count);
  }
  fetchAndUpdateKds(false);
}

async function chgById(itemId, st, count) {
  try {
    const url = `/api/order_item/${itemId}/status`;
    const body = JSON.stringify({ status: st, count: count });
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: body
    });
    const data = await response.json();
    if (DEBUG_KDS) console.log(`[KDS CHG] id=${itemId} st=${st} count=${count}`, data);
    if (!response.ok || !data.ok) {
      console.error('KDS change status failed', data);
    }
  } catch (e) {
    console.error('chgById failed:', e);
  }
}

/* ====== çŠ¶æ…‹å¤‰æ›´ï¼ˆcount å¯¾å¿œï¼‰ ====== */
async function chg(key, itemId, st){
  try{
    const row  = document.querySelector(`tr[data-key="${CSS.escape(key)}"]`);
    const btns = row ? row.querySelectorAll('button') : [];
    btns.forEach(b => b.disabled = true);

    // è¡¨ç¤ºå€¤ã‚’å‚ç…§ï¼ˆå“ãƒ»å“åãƒ»æ®‹æ•°ï¼‰
    const tds = row ? row.querySelectorAll('td') : [];
    const tableNo   = tds[1]?.textContent?.trim() ?? "";
    const itemName  = tds[3]?.textContent?.trim() ?? ""; // â˜…ã€Œæ™‚åˆ»ã€åˆ—ã‚’æŒ¿å…¥ã—ãŸã®ã§ index ã‚’ãšã‚‰ã™
    const qtyRemain = Number(tds[4]?.textContent ?? 0);  // â˜… ã“ã“ã‚‚ +1

    // æ•°é‡ï¼ˆå…¥åŠ›ã‚¨ãƒªã‚¢ãŒã‚ã‚Œã°å°Šé‡ï¼‰
    let count = 1;
    const countInput = row ? row.querySelector('.js-count') : null;
    if (countInput && countInput.value) {
      const v  = Number(countInput.value);
      const mx = Number(countInput.max || 1);
      const mn = Number(countInput.min || 1);
      count = Math.max(mn, Math.min(mx, isFinite(v) ? v : 1));
      if (String(count) !== String(countInput.value)) countInput.value = String(count);
    }

    // â˜…å–æ¶ˆ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° & éå‰°ãƒã‚§ãƒƒã‚¯
    const isCancel = /^(å–æ¶ˆ|ï½·ï½¬ï¾ï½¾ï¾™|ã‚­ãƒ£ãƒ³ã‚»ãƒ«|cancel|void)$/i.test(st);
    if (isCancel) {
      if (count > qtyRemain) {
        alert(`å–æ¶ˆå€‹æ•°(${count})ãŒæ®‹æ•°(${qtyRemain})ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
        btns.forEach(b => b.disabled = false);
        return;
      }
      const fullCancel = count >= qtyRemain;
      const head = fullCancel ? "â€»å…¨æ•°å–æ¶ˆã«ãªã‚Šã¾ã™â€»\n" : "";
      const msg  = `${head}å“:${tableNo} ã€${itemName}ã€ã‚’ ${count} å€‹ å–æ¶ˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
      if (!window.confirm(msg)) {
        btns.forEach(b => b.disabled = false);
        return;
      }
    }

    pauseRefresh(2000);

    const res = await fetch('/api/order_item/'+itemId+'/status', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ status: st, count })
    });
    const j = await res.json().catch(()=>({ok:false, error:'invalid json'}));

    if (DEBUG_KDS) console.log('[KDS POST]', {itemId, st, count, http:res.status, json:j});

    if(!res.ok || !j.ok){
      const msg = (j && j.error) ? j.error : (res.status + ' ' + res.statusText);
      alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + msg);
      btns.forEach(b => b.disabled = false);
      return;
    }
    refreshPauseUntil = 0;
    fetchAndUpdateKds(false);
  }catch(e){
    console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', e);
    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e);
  }
}

/* ====== ã‚«ãƒ†ã‚´ãƒªï¼ˆæœªé¸æŠï¼è¡¨ç¤ºãªã—ï¼‰ ====== */
const catBar = document.getElementById('cat-bar');
const btnAll = document.getElementById('btn-all');

function currentSelectedCatIds(){
  const active = Array.from(catBar.querySelectorAll('.cat-btn[data-id]:not(.all).active'));
  return active.map(b => parseInt(b.dataset.id,10)).filter(n => !isNaN(n));
}
function hasAnySelection(){
  return btnAll.classList.contains('active') || currentSelectedCatIds().length > 0;
}
function setAllActive(state){ btnAll.classList.toggle('active', state); }
function updateAllButtonState(){
  const cats = Array.from(catBar.querySelectorAll('.cat-btn[data-id]:not(.all)'));
  const allOn = cats.length>0 && cats.every(b => b.classList.contains('active'));
  setAllActive(allOn);
}
function attachCatHandlers(){
  catBar.querySelectorAll('.cat-btn[data-id]:not(.all)').forEach(btn => {
    btn.type = 'button';
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      btn.classList.toggle('active');
      updateAllButtonState();
      fetchAndUpdateKds(true);
    });
  });
  btnAll.type = 'button';
  btnAll.addEventListener('click', (e) => {
    e.preventDefault();
    const turnOnAll = !btnAll.classList.contains('active');
    const cats = catBar.querySelectorAll('.cat-btn[data-id]:not(.all)');
    cats.forEach(b => b.classList.toggle('active', turnOnAll));
    setAllActive(turnOnAll);
    fetchAndUpdateKds(true);
  });
}
async function loadCategories(){
  try{
    const r = await fetch(API_CATS, { cache:'no-store' });
    const j = await r.json();
    if (DEBUG_KDS) console.log('[KDS CATS]', j);
    if (!j || !j.ok) return;
    Array.from(catBar.querySelectorAll('.cat-btn[data-id]:not(.all)')).forEach(e => e.remove());
    (j.categories || []).forEach(c => {
      const b = document.createElement('button');
      b.className = 'cat-btn';
      b.dataset.id = String(c.id);
      b.textContent = c.name || c.åç§° || ('ã‚«ãƒ†ã‚´ãƒª#'+c.id);
      b.type = 'button';
      catBar.appendChild(b);
    });
    setAllActive(false);
    attachCatHandlers();
  }catch(e){ console.warn('loadCategories failed', e); }
}

function buildItemsUrl(){
  if (!hasAnySelection()) return null;
  const p = new URLSearchParams();
  if (!btnAll.classList.contains('active')) {
    const ids = currentSelectedCatIds();
    p.set('cat_ids', ids.join(','));
  }
  if (DEBUG_KDS) p.set('debug', '1'); // ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒãƒƒã‚°ON
  p.set('ts', String(Date.now()));
  return KDS_API_URL + '?' + p.toString();
}

/* ====== ä¸€è¦§å–å¾—ï¼ˆæœªé¸æŠãªã‚‰ã‚¯ãƒªã‚¢ï¼‰ ====== */
let initialized = false;
let knownIds = new Set();

/* å…¥åŠ›é€”ä¸­ã®å€¤ã‚’ä¿æŒï¼ˆkeyãƒ™ãƒ¼ã‚¹ï¼‰ */
function captureDraftCounts() {
  const map = new Map();
  document.querySelectorAll('#tbody tr').forEach(tr => {
    const key = tr.getAttribute('data-key');
    const inp = tr.querySelector('.js-count');
    if (key && inp && inp.value) map.set(key, String(inp.value));
  });
  return map;
}

async function fetchAndUpdateKds(triggerSoundOnNew = true){
  if (!canRefresh()) return;

  const url = buildItemsUrl();
  const tbody = document.getElementById('tbody');

  if (!url){
    tbody.innerHTML = '';
    knownIds = new Set();
    initialized = false;
    if (DEBUG_KDS) console.log('[KDS] no url (no selection)');
    return;
  }

  const draft = captureDraftCounts();

  try{
    const response = await fetch(url, { cache: 'no-store' });
    const data = await response.json();
    if (DEBUG_KDS) console.log('[KDS GET]', {url, http:response.status, data});

    if (!data || data.ok !== true) {
      console.warn('KDS API error', data);
      return;
    }

    tbody.innerHTML = '';
    const currentIds = new Set(data.items.map(it => it.id));

    let newIds = [];
    if (!initialized) {
      knownIds = new Set(currentIds);
      initialized = true;
    } else {
      currentIds.forEach(id => { if (!knownIds.has(id)) newIds.push(id); });
    }

    // â˜… order_idã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
    const orderGroups = new Map();
    data.items.forEach(item => {
      if (!orderGroups.has(item.order_id)) {
        orderGroups.set(item.order_id, []);
      }
      orderGroups.get(item.order_id).push(item);
    });

    // â˜… å„æ³¨æ–‡ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¡¨ç¤º
    let isFirstGroup = true;
    orderGroups.forEach((items, orderId) => {
      // åŒºåˆ‡ã‚Šè¡Œï¼ˆæœ€åˆã®ã‚°ãƒ«ãƒ¼ãƒ—ä»¥å¤–ï¼‰
      if (!isFirstGroup) {
        const spacerTr = document.createElement('tr');
        spacerTr.className = 'order-separator';
        spacerTr.innerHTML = '<td colspan="8" style="height:12px; background:#f3f4f6; border-top:2px solid #d1d5db; border-bottom:2px solid #d1d5db;"></td>';
        tbody.appendChild(spacerTr);
      }
      isFirstGroup = false;

      // â˜… ä¸€æ‹¬æ“ä½œãƒœã‚¿ãƒ³è¡Œã‚’æŒ¿å…¥
      const bulkTr = document.createElement('tr');
      bulkTr.style.cssText = 'background:#fef3c7; border-top:2px solid #f59e0b; border-bottom:1px solid #f59e0b;';
      const tableNo = items[0].table_no;
      const orderedTime = items[0].ordered_time || '';
      const itemIds = items.map(it => it.id).join(',');
      bulkTr.innerHTML = `
        <td colspan="3" style="font-weight:700; padding:12px;">
          ãƒ†ãƒ¼ãƒ–ãƒ«: ${tableNo} | æ³¨æ–‡æ™‚åˆ»: ${orderedTime}
        </td>
        <td colspan="5" style="padding:12px;">
          <div style="display:flex; gap:12px; align-items:center;">
            {% if use_cooking_status %}
            <button type="button" onclick="bulkCooking('${itemIds}')" 
                    style="padding:10px 20px; background:#3b82f6; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">
              ğŸ‘¨â€ğŸ³ ä¸€æ‹¬èª¿ç†ä¸­
            </button>
            {% endif %}
            <button type="button" onclick="bulkServed('${itemIds}')" 
                    style="padding:10px 20px; background:#10b981; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">
              âœ… ä¸€æ‹¬æä¾›æ¸ˆ
            </button>
            <button type="button" onclick="bulkCancel('${itemIds}')" 
                    style="padding:10px 20px; background:#ef4444; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">
              âŒ ä¸€æ‹¬å–æ¶ˆ
            </button>
            <span style="color:#92400e; font-size:14px;">${items.length}ä»¶</span>
          </div>
        </td>
      `;
      tbody.appendChild(bulkTr);

      // â˜… å„æ˜ç´°è¡Œ
      items.forEach((item, index) => {
        const rowKey = String(item.id);
        const tr = document.createElement('tr');
        tr.setAttribute('data-key', rowKey);

        const absQty = Math.abs(Number(item.qty || 0));
        const defaultCount = draft.has(rowKey) ? draft.get(rowKey) : String(absQty);

        tr.innerHTML = `
          <td>${item.id}</td>
          <td>${item.table_no}</td>
          <td>${item.ordered_time || ''}</td>
          <td>${item.name}</td>
          <td>${item.qty}</td>
          <td>${item.memo || ''}</td>
          <td>${item.status}</td>
          <td>
            <div class="ops">
              <button type="button" onclick="chg('${rowKey}', ${item.id}, 'èª¿ç†ä¸­')">èª¿ç†ä¸­</button>
              <button type="button" onclick="chg('${rowKey}', ${item.id}, 'æä¾›æ¸ˆ')">æä¾›æ¸ˆ</button>
              <button type="button" onclick="chg('${rowKey}', ${item.id}, 'å–æ¶ˆ')">å–æ¶ˆ</button>

              ${absQty >= 2 ? `
                <span class="count-wrap">
                  <span class="small muted">å€‹æ•°</span>
                  <input type="number" class="js-count count-input"
                         min="1" max="${absQty}" value="${defaultCount}">
                </span>
              ` : ''}
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    });

    knownIds = currentIds;

    if (triggerSoundOnNew && newIds.length > 0 && typeof window.playNotify === 'function') {
      window.playNotify();
    }

    // å…¥åŠ›/ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã§ç·¨é›†ãƒ­ãƒƒã‚¯
    tbody.addEventListener('focusin', (e) => {
      if (e.target && e.target.classList.contains('js-count')) pauseRefresh();
    });
    tbody.addEventListener('input', (e) => {
      if (e.target && e.target.classList.contains('js-count')) pauseRefresh();
    });
    tbody.addEventListener('focusout', (e) => {
      if (e.target && e.target.classList.contains('js-count')) pauseRefresh(1200);
    });

  }catch(e){
    console.error('Failed to fetch KDS items:', e);
  }
}

/* ====== éŸ³å£°è¨­å®š ====== */
let soundEnabled = true;
const soundToggle = document.getElementById('sound-toggle');
if (soundToggle) {
  soundToggle.addEventListener('change', (e) => {
    soundEnabled = e.target.checked;
    if (DEBUG_KDS) console.log('[KDS SOUND]', soundEnabled ? 'enabled' : 'disabled');
  });
}

/* ====== æ³¨æ–‡é€šçŸ¥éŸ³å£°å†ç”Ÿ ====== */
const notifyAudio = new Audio('{{ url_for("static", filename="sounds/customer_is_calling.mp3") }}');
notifyAudio.preload = 'auto';

window.playNotify = async function(){
  if (!soundEnabled) {
    if (DEBUG_KDS) console.log('[KDS SOUND] notify sound disabled');
    return;
  }
  try{
    notifyAudio.currentTime = 0;
    await notifyAudio.play();
    if (DEBUG_KDS) console.log('[KDS SOUND] notify played');
  }catch(err){
    console.warn('[KDS SOUND] playNotify failed:', err);
  }
};

/* ====== åº—å“¡å‘¼ã³å‡ºã—éŸ³å£°å†ç”Ÿ ====== */
const staffCallAudio = new Audio('{{ url_for("static", filename="sounds/customer_is_calling.mp3") }}');
staffCallAudio.preload = 'auto';

window.playStaffCall = async function(){
  if (!soundEnabled) {
    if (DEBUG_KDS) console.log('[KDS SOUND] staff call sound disabled');
    return;
  }
  try{
    staffCallAudio.currentTime = 0;
    await staffCallAudio.play();
    if (DEBUG_KDS) console.log('[KDS SOUND] staff call played');
  }catch(err){
    console.warn('[KDS SOUND] playStaffCall failed:', err);
  }
};

/* ====== åº—å“¡å‘¼ã³å‡ºã—ãƒãƒ¼ãƒªãƒ³ã‚° ====== */
let activeCalls = new Map(); // ç¾åœ¨è¡¨ç¤ºä¸­ã®å‘¼ã³å‡ºã— - key: table_no, value: {timestamp}

function updateStaffCallDisplay() {
  const alertEl = document.getElementById('staff-call-alert');
  const listEl = document.getElementById('staff-call-list');
  
  console.log('[updateStaffCallDisplay] activeCalls:', activeCalls, 'size:', activeCalls.size);
  
  if (activeCalls.size > 0) {
    const tableList = Array.from(activeCalls.keys()).sort((a, b) => {
      // æ•°å€¤ã¨ã—ã¦ã‚½ãƒ¼ãƒˆã‚’è©¦ã¿ã‚‹
      const numA = parseInt(a);
      const numB = parseInt(b);
      if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
      return a.localeCompare(b);
    });
    
    // ãƒªã‚¹ãƒˆã‚’å†æ§‹ç¯‰
    listEl.innerHTML = '';
    tableList.forEach(tableNo => {
      const callInfo = activeCalls.get(tableNo);
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'display:flex; align-items:center; justify-content:space-between; background:#fff; padding:8px 12px; border-radius:6px; border:1px solid #f59e0b;';
      
      const tableText = document.createElement('span');
      tableText.style.cssText = 'font-size:16px; font-weight:600; color:#92400e;';
      tableText.textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«: ${tableNo}`;
      
      const confirmBtn = document.createElement('button');
      confirmBtn.type = 'button';
      confirmBtn.style.cssText = 'padding:6px 12px; background:#10b981; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:600; font-size:14px;';
      confirmBtn.textContent = 'ç¢ºèª';
      confirmBtn.onclick = async () => {
        try {
          // ã‚µãƒ¼ãƒãƒ¼ã«ç¢ºèªã‚’é€šçŸ¥
          const res = await fetch('/api/staff_call/confirm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table_no: tableNo, timestamp: callInfo.timestamp })
          });
          const data = await res.json();
          if (data && data.ok) {
            console.log('[confirmStaffCall] Confirmed:', tableNo);
            activeCalls.delete(tableNo);
            updateStaffCallDisplay();
          } else {
            console.error('[confirmStaffCall] Failed:', data);
          }
        } catch (e) {
          console.error('[confirmStaffCall] Error:', e);
        }
      };
      
      itemDiv.appendChild(tableText);
      itemDiv.appendChild(confirmBtn);
      listEl.appendChild(itemDiv);
    });
    
    alertEl.style.display = 'block';
  } else {
    console.log('[updateStaffCallDisplay] No active calls');
    alertEl.style.display = 'none';
  }
}

async function checkStaffCalls(){
  try{
    const url = '/api/staff_call/poll';
    const res = await fetch(url, { cache: 'no-store' });
    const data = await res.json();
    
    if (DEBUG_KDS) console.log('[KDS STAFF_CALL]', data);
    
    if (data && data.ok) {
      const serverCalls = data.calls || [];
      
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã£ã¦ããŸå‘¼ã³å‡ºã—ã®Mapã‚’ä½œæˆ
      const serverCallsMap = new Map();
      serverCalls.forEach(call => {
        serverCallsMap.set(call.table_no, { timestamp: call.timestamp });
      });
      
      // æ–°ã—ã„å‘¼ã³å‡ºã—ã‚’æ¤œå‡ºã—ã¦éŸ³å£°å†ç”Ÿ
      serverCalls.forEach(call => {
        if (!activeCalls.has(call.table_no)) {
          console.log('[checkStaffCalls] New call from table:', call.table_no);
          // éŸ³å£°å†ç”Ÿ
          window.playStaffCall();
        }
      });
      
      // ã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ã«åŒæœŸï¼ˆç¢ºèªæ¸ˆã¿ã®å‘¼ã³å‡ºã—ã‚’å‰Šé™¤ï¼‰
      activeCalls = serverCallsMap;
      updateStaffCallDisplay();
    }
  }catch(e){
    console.error('[KDS] checkStaffCalls failed:', e);
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  await loadCategories();

  // åˆå›ã¯ã€Œã™ã¹ã¦ã€ã‚’è‡ªå‹•ONã—ã¦å³å–å¾—
  if (!btnAll.classList.contains('active')) {
    btnAll.classList.add('active');
  }
  fetchAndUpdateKds(true);

  setInterval(() => { if (hasAnySelection()) fetchAndUpdateKds(true); }, 3000);
  setInterval(checkStaffCalls, 3000); // åº—å“¡å‘¼ã³å‡ºã—ãƒã‚§ãƒƒã‚¯
});
</script>

{% endblock %}
