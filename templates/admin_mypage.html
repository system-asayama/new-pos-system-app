{% extends "base.html" %}
{% block content %}
<h2 style="margin:0 0 12px">ç®¡ç†è€…ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>

<div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:16px">

  <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆè¡¨ç¤ºï¼‰ -->
  <section class="card">
    <h3 style="margin:0 0 8px">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
    <table>
      <tr>
        <th style="width:140px">æ°å</th>
        <td>{{ me.name or me.get('åç§°') or me.get('æ°å') or 'â€”' }}</td>
      </tr>
      <tr>
        <th>ãƒ­ã‚°ã‚¤ãƒ³ID</th>
        <td><code>{{ me.login_id or me.get('ãƒ­ã‚°ã‚¤ãƒ³ID') or me.get('login_id') or 'â€”' }}</code></td>
      </tr>
      <tr>
        <th>åº—èˆ—</th>
        <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç¾åœ¨åº—èˆ—åã‚’æœ€å„ªå…ˆã§è¡¨ç¤º -->
        <td>{{ session.get('store_name') or (store and (store.name or store.get('åç§°') or store.get('åº—èˆ—å'))) or '-' }}</td>
      </tr>
      <tr>
        <th>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th>
        <td>{{ me.last_login or me.get('æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³') or me.get('last_login_at') or 'â€”' }}</td>
      </tr>
      <tr>
        <th>ä½œæˆæ—¥æ™‚</th>
        <td>{{ me.created_at or me.get('ä½œæˆæ—¥æ™‚') or me.get('ç™»éŒ²æ—¥æ™‚') or me.get('created_at') or 'â€”' }}</td>
      </tr>
      <tr>
        <th>æ›´æ–°æ—¥æ™‚</th>
        <td>{{ me.updated_at or me.get('æ›´æ–°æ—¥æ™‚') or me.get('updated_at') or 'â€”' }}</td>
      </tr>
    </table>
  </section>

  <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›† -->
  <section class="card">
    <h3 style="margin:0 0 8px">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h3>
    <form method="post" action="{{ url_for('admin_mypage') }}" autocomplete="off">
      <!-- ğŸ”’ CSRF -->
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="hidden" name="action" value="profile">

      <label>æ°å</label>
      <input
        name="name"
        required
        maxlength="100"
        value="{{ me.name or me.get('åç§°') or me.get('æ°å') or '' }}"
        autocomplete="name"
        autocapitalize="none"
        spellcheck="false"
      >

      <label>ãƒ­ã‚°ã‚¤ãƒ³IDï¼ˆè‹±æ•°å­—ã¨ . _ - ï¼3ã€œ64æ–‡å­—ï¼‰</label>
      <input
        name="login_id"
        required
        minlength="3"
        maxlength="64"
        pattern="[A-Za-z0-9._-]+"
        value="{{ me.login_id or me.get('ãƒ­ã‚°ã‚¤ãƒ³ID') or me.get('login_id') or '' }}"
        autocomplete="username"
        autocapitalize="none"
        spellcheck="false"
      >
      <div class="small" style="color:var(--muted);margin-top:6px">
        â€» å¤‰æ›´å¾Œã¯æ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³ã‹ã‚‰æ–°ã—ã„ãƒ­ã‚°ã‚¤ãƒ³IDãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn" type="submit">æ›´æ–°ã™ã‚‹</button>
      </div>
    </form>
  </section>

  <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ -->
  <section class="card">
    <h3 style="margin:0 0 8px">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
    <form method="post" action="{{ url_for('admin_mypage') }}" autocomplete="off">
      <!-- ğŸ”’ CSRF -->
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="hidden" name="action" value="password">

      <label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input name="current_password" type="password" required autocomplete="current-password">

      <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰</label>
      <input name="new_password" type="password" minlength="8" required autocomplete="new-password">

      <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
      <input name="confirm_password" type="password" minlength="8" required autocomplete="new-password">

      <div class="actions" style="margin-top:12px">
        <button class="btn" type="submit">å¤‰æ›´ã™ã‚‹</button>
      </div>
    </form>
  </section>

  <!-- æ‰€å±åº—èˆ—ï¼ˆç¾åœ¨åº—èˆ— + ãã®ä»–ï¼‰ -->
  <section class="card">
    <h3 style="margin:0 0 8px">æ‰€å±åº—èˆ—</h3>

    {% set current_store_id = session.get('store_id')|int %}
    {% set store_list = (stores|default([])) %}

    {% if store_list and store_list|length > 0 %}
      <table>
        <thead>
          <tr><th style="width:60%">åº—èˆ—å</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody>
          {% for s in store_list %}
            {% set sid = (s.id if 'id' in s else s.get('id'))|int %}
            <tr>
              <td>{{ s.name or s.get('name') }}</td>
              <td>
                {% if sid == current_store_id %}
                  <span class="badge">ç¾åœ¨ã®åº—èˆ—</span>
                {% else %}
                  <span class="small" style="color:var(--muted)">åˆ¥åº—èˆ—</span>
                {% endif %}
              </td>
              <td>
                {% if sid != current_store_id %}
                  <a class="btn sub"
                     href="{{ url_for('switch_store', store_id=sid, next=request.full_path) }}">
                    ã“ã®åº—èˆ—ã«åˆ‡ã‚Šæ›¿ãˆ
                  </a>
                {% else %}
                  <span class="small" style="color:var(--muted)">â€”</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      {% if session.get('store_name') %}
        <!-- stores ãŒæœªæ¸¡ã—ã§ã‚‚ã€ç¾åœ¨åº—èˆ—ã ã‘ã¯1è¡Œè¡¨ç¤º -->
        <table>
          <thead>
            <tr><th style="width:60%">åº—èˆ—å</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>{{ session.get('store_name') }}</td>
              <td><span class="badge">ç¾åœ¨ã®åº—èˆ—</span></td>
              <td><span class="small" style="color:var(--muted)">â€”</span></td>
            </tr>
          </tbody>
        </table>
      {% else %}
        <div class="small" style="color:var(--muted)">æ‰€å±åº—èˆ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
      {% endif %}
    {% endif %}
  </section>

</div>
{% endblock %}
