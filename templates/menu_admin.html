{% extends "base.html" %}
{% block content %}
<h2>メニュー管理</h2>

<!-- ▼ 入力モードトグル（cookie保存：/admin/price-mode POST） -->
<form action="{{ url_for('set_price_mode') }}" method="post" style="margin:8px 0 16px 0; display:flex; gap:10px; align-items:center">
  <input type="hidden" name="mode" value="{{ 'excl' if price_input_mode=='incl' else 'incl' }}">
  <button type="submit" class="btn sub">
    価格入力: {{ '税込入力' if price_input_mode=='incl' else '税抜入力' }} → 切替
  </button>
  <span class="small muted">
    現在: <strong>{{ '税込入力' if price_input_mode=='incl' else '税抜入力' }}</strong>（ブラウザ単位）
  </span>
</form>

<div class="grid" style="grid-template-columns:320px 1fr">
  <!-- 左：新規登録 -->
  <div class="card">
    <h3>新規登録</h3>
    <form id="menu-create-form" method="post" action="{{ url_for('admin_menu_new') }}" enctype="multipart/form-data">
      <!-- 基本情報 -->
      <label>名称</label>
      <input name="名称" required placeholder="例：唐揚げ">

      <label>
        価格
        <span class="small" style="margin-left:6px;color:var(--muted)">
          （現在の入力モード: {{ '税抜' if price_input_mode == 'excl' else '税込' }}）
        </span>
      </label>
      <input id="price-input" name="価格" type="number" required
             placeholder="{{ '税抜価格' if price_input_mode == 'excl' else '税込価格' }}"
             inputmode="numeric" min="0" step="1">

      <!-- ライブ換算表示（※フロントは整数演算で1円ズレ防止） -->
      <div class="small" style="margin:6px 0 10px;color:var(--muted)">
        保存時の換算:
        <span id="live-excl" class="badge">—</span>
        ／ 表示用税込:
        <span id="live-incl" class="badge">—</span>
        <span class="small" style="margin-left:8px">（実効税率: <span id="live-rate">—</span>）</span>
        <div style="margin-top:4px">
          <small>※DBには常に<strong>税抜</strong>で保存します。<br>
          ※税込入力モードのときは「税抜 = 税込 − floor( 税込 × 税率 / (1 + 税率) )」で自動換算します（前面表示も整数演算）。</small>
        </div>
      </div>

      <!-- 画像はファイル優先、未指定ならURLを利用 -->
      <label>写真ファイル（推奨）</label>
      <input type="file" name="写真ファイル" accept="image/*">

      <label>写真URL（任意）</label>
      <input name="写真URL" placeholder="公開URL（Dropbox / Cloudinary / 直リンク可能なストレージ等）">

      <label>説明</label>
      <textarea name="説明" rows="3" placeholder="メモや特徴など（任意）"></textarea>

      <!-- 基本税率 / 一覧全体の並び -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px">
        <div>
          <label>（参考）基本税率</label>
          <input id="menu-base-rate" name="税率" type="number" value="0.10" step="0.01" min="0" inputmode="decimal">
          <div class="small" style="color:var(--muted);margin-top:4px">
            ※カテゴリ別税率が設定されている場合はそちらが優先されます。
          </div>
        </div>
        <div>
          <label>（メニュー全体の）表示順</label>
          <input name="表示順" type="number" value="0" inputmode="numeric">
        </div>
      </div>

      <!-- カテゴリ（複数可・必須）＋カテゴリ別税率・カテゴリ別表示順 -->
      <label style="margin-top:12px">
        カテゴリ（必須・複数可）
        <span class="small" style="margin-left:6px;color:var(--muted)">
          ※少なくとも1つ選択してください
        </span>
      </label>
      <div id="cat-rows">
        <div class="cat-row" style="display:flex; gap:8px; align-items:center; margin-bottom:6px; flex-wrap:wrap">
          <select name="cat_id[]">
            <option value="">（未選択）</option>
            {% for c in cats %}
              {% set indent = '&nbsp;&nbsp;&nbsp;&nbsp;' * (c.depth - 1) %}
              <option value="{{ c.id }}">{{ indent|safe }}{{ c.name }}</option>
            {% endfor %}
          </select>
          <input name="cat_tax[]" type="number" value="0.10" step="0.01" min="0" inputmode="decimal" style="width:120px" placeholder="税率(例 0.10)">
          <input name="cat_order[]" type="number" value="0" style="width:120px" placeholder="カテゴリ内表示順" inputmode="numeric">
          <button type="button" class="btn sub" onclick="removeCatRow(this)">－</button>
        </div>
      </div>
      <div class="small" style="color:var(--muted);margin-top:-2px;margin-bottom:6px">
        ・税率はカテゴリごとに設定できます（例：10% は <code>0.10</code>、軽減8% は <code>0.08</code>）。<br>
        ・実効税率は <strong>カテゴリ行を表示順（cat_order）で昇順</strong>に並べた際に、最初に指定された税率を採用します。未指定なら「（参考）基本税率」を使用します。<br>
        ・「カテゴリ内表示順」は、そのカテゴリ内での並び順です（小さいほど上）。
      </div>
      <button type="button" class="btn sub" onclick="addCatRow()">＋ カテゴリ行を追加</button>

      <div style="margin-top:12px">
        <button class="btn" type="submit">登録</button>
      </div>

      <p class="small" style="margin-top:8px">
        写真ファイルが指定されている場合はそちらを保存します。<br>
        写真URLは <code>https://...</code> の公開直リンクをご利用ください（ログイン不要のもの）。
      </p>
    </form>
  </div>

  <!-- 右：一覧 -->
  <div class="card">
    <h3>一覧</h3>
    <table>
      <thead>
        <tr>
          <th style="width:56px">#</th>
          <th style="width:96px">写真</th>
          <th>名称 / 説明</th>
          <th style="width:260px">カテゴリ（階層すべて）</th>
          <th style="width:200px">価格（左=税抜 / 右=税込）</th>
          <th style="width:72px">提供</th>
          <th style="width:300px">操作</th>
        </tr>
      </thead>
      <tbody>
        {% for m in menu %}
        <tr>
          <td>{{ m['id'] }}</td>
          <td>
            <div class="thumbbox">
              <img
                class="thumb" width="72" height="72" style="object-fit:cover;display:block"
                src="{{ m['写真URL'] or '' }}"
                alt="{{ m['名称'] }}"
                onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,\
                  <svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2272%22 height=%2272%22 viewBox=%220 0 72 72%22>\
                    <rect width=%2272%22 height=%2272%22 fill=%22%23eef2f7%22/>\
                    <text x=%2236%22 y=%2239%22 font-size=%2210%22 text-anchor=%22middle%22 fill=%22%239aa3af%22>NO IMAGE</text>\
                  </svg>';"
              />
            </div>
          </td>
          <td>
            <div class="row-main">
              <div>
                <div class="row-title">{{ m['名称'] }}</div>
                {% if m['説明'] %}
                  <div class="row-desc">{{ m['説明'] }}</div>
                {% endif %}
              </div>
            </div>
          </td>
          <td>
            <div class="cat-paths" style="display:flex;flex-wrap:wrap;gap:6px">
              {% set paths = m.get('カテゴリパス一覧', []) %}
              {% if paths and paths|length > 0 %}
                {% for p in paths %}
                  {% if p is string %}
                    <span class="badge">{{ p }}</span>
                  {% else %}
                    <span class="badge">{{ p|join(' › ') }}</span>
                  {% endif %}
                {% endfor %}
              {% else %}
                <span class="small" style="color:var(--muted)">未設定</span>
              {% endif %}
            </div>
          </td>
          <td>
            <div style="display:flex; align-items:baseline; gap:10px; flex-wrap:wrap">
              <span class="badge price">¥{{ m['価格_税抜'] }}</span>
              <span class="small" style="color:var(--muted)">→</span>
              <span class="badge">¥{{ m['価格_税込'] }} <span class="small">税込</span></span>
            </div>
          </td>
          <td>{{ '◯' if m['提供可否']==1 else '×' }}</td>
          <td>
            <div class="actions">
              <a class="btn sub" href="{{ url_for('admin_menu_edit', mid=m['id']) }}">編集</a>
              <a class="btn sub" href="{{ url_for('admin_menu_toggle', mid=m['id']) }}">
                提供切替{{ '（停止）' if m['提供可否']==1 else '（開始）' }}
              </a>
              <!-- 削除（POST + 確認） -->
              <form
                method="post"
                action="{{ url_for('admin_menu_delete', mid=m['id']) }}"
                style="display:inline"
                onsubmit="return confirm('削除しますか？このメニューに紐付くカテゴリ付与は削除されますが、注文履歴は残ります。');"
              >
                <button class="btn sub" type="submit">削除</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% if not menu %}
        <tr>
          <td colspan="7" class="small">まだメニューがありません。左の「新規登録」から追加してください。</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- ===== 行の追加・削除／バリデーション + ライブ換算（整数演算） ===== -->
<script>
function addCatRow(){
  const wrap = document.getElementById('cat-rows');
  const first = wrap.querySelector('.cat-row');
  const clone = first.cloneNode(true);

  // 初期化
  const sel = clone.querySelector('select[name="cat_id[]"]');
  const tax = clone.querySelector('input[name="cat_tax[]"]');
  const ord = clone.querySelector('input[name="cat_order[]"]');
  if (sel) sel.selectedIndex = 0;
  if (tax) tax.value = '0.10';
  if (ord) ord.value = 0;

  wrap.appendChild(clone);
  // ★ 追加行だけにイベントをバインド（重複防止）
  bindLiveHandlers(clone);
  computeLive();      // 即時再計算
}

function removeCatRow(btn){
  const row = btn.closest('.cat-row');
  const wrap = document.getElementById('cat-rows');
  if (!row || !wrap) return;
  const rows = wrap.querySelectorAll('.cat-row');
  if (rows.length > 1){
    row.remove();
  } else {
    // 最低1行は残す：値だけクリア
    const sel = row.querySelector('select[name="cat_id[]"]');
    const tax = row.querySelector('input[name="cat_tax[]"]');
    const ord = row.querySelector('input[name="cat_order[]"]');
    if (sel) sel.selectedIndex = 0;
    if (tax) tax.value = '0.10';
    if (ord) ord.value = 0;
  }
  computeLive();
}

// カテゴリ必須の検証（少なくとも1つ選択 & 重複禁止 & 税率の数値性）
document.getElementById('menu-create-form').addEventListener('submit', function(ev){
  const wrap = document.getElementById('cat-rows');
  const sels = Array.from(wrap.querySelectorAll('select[name="cat_id[]"]'));
  const taxes = Array.from(wrap.querySelectorAll('input[name="cat_tax[]"]'));
  let chosen = sels.map(s => s.value).filter(v => v !== '');
  if (chosen.length === 0){
    alert('少なくとも1つはカテゴリを選択してください。');
    ev.preventDefault();
    return false;
  }
  // 重複チェック
  const set = new Set(chosen);
  if (set.size !== chosen.length){
    alert('同じカテゴリが重複しています。1カテゴリにつき1行にしてください。');
    ev.preventDefault();
    return false;
  }
  // 税率チェック
  for (let i = 0; i < taxes.length; i++){
    const v = taxes[i].value.trim();
    if (sels[i].value !== ''){ // 選択されている行のみ
      if (v === '' || isNaN(Number(v)) || Number(v) < 0){
        alert('選択されたカテゴリの税率は0以上の数値で入力してください（例：10%→0.10）。');
        ev.preventDefault();
        return false;
      }
    }
  }
  return true;
});

// ======= ライブ換算：浮動小数を使わず整数演算 =======
function rateToFrac(rateStr){
  // "0.10" → {n:10, d:100}, "0" → {n:0, d:1}
  const s = String(rateStr ?? "0").trim();
  if (s === "") return {n:0, d:1};
  const p = s.indexOf(".");
  if (p === -1) {
    // "1" → 1/1 だが、税率入力は 0.10 形式を想定。安全のため。
    return {n: parseInt(s,10)||0, d: 1};
  }
  const digits = s.length - p - 1;
  const n = parseInt(s.replace(".", ""), 10) || 0;
  const d = 10 ** digits;
  return {n, d};
}

// 実効税率（文字列）
function getEffectiveRateStr(){
  const wrap = document.getElementById('cat-rows');
  const rows = Array.from(wrap.querySelectorAll('.cat-row'))
    .map(r => {
      const sel = r.querySelector('select[name="cat_id[]"]');
      const tax = r.querySelector('input[name="cat_tax[]"]');
      const ord = r.querySelector('input[name="cat_order[]"]');
      return {
        hasCat: !!sel && sel.value !== '',
        taxStr: tax ? tax.value.trim() : '',
        ord: ord && ord.value.trim() !== '' ? Number(ord.value) : 0
      };
    })
    .sort((a,b) => (a.ord||0) - (b.ord||0));

  for (const r of rows){
    if (r.hasCat && r.taxStr !== '') return r.taxStr;
  }
  const base = document.getElementById('menu-base-rate');
  return (base && base.value.trim() !== '') ? base.value.trim() : '0.10';
}

function computeLive(){
  const mode = "{{ price_input_mode }}"; // "incl" or "excl"
  const priceEl = document.getElementById('price-input');
  const liveEx = document.getElementById('live-excl');
  const liveIn = document.getElementById('live-incl');
  const liveRt = document.getElementById('live-rate');

  // 価格は整数として扱う
  const raw = priceEl && priceEl.value.trim() !== '' ? Math.max(0, parseInt(priceEl.value,10) || 0) : 0;

  const rateStr = getEffectiveRateStr();  // 例 "0.10"
  const {n, d} = rateToFrac(rateStr);     // 税率 n/d（整数）
  let excl = 0, incl = 0;

  if (mode === 'incl'){
    // 税額 = floor( 税込 × n / (d + n) )  → 整数演算
    const taxFromIncl = Math.floor(raw * n / (d + n));
    excl = raw - taxFromIncl;
    // 検証のため税込も再計算
    incl = excl + Math.floor(excl * n / d);
  } else {
    // 税抜 → 税込
    excl = raw;
    incl = excl + Math.floor(excl * n / d);
  }

  liveEx.textContent = '税抜 ¥' + excl.toLocaleString();
  liveIn.textContent = '税込 ¥' + incl.toLocaleString();
  // 表示用の%は小数演算でOK（見た目だけ）
  liveRt.textContent = (d ? (n * 100 / d) : 0).toFixed(2) + '%';
}

// 入力イベントに反応（重複バインド防止）
function bindLiveHandlers(root){
  (root.querySelectorAll
    ? root.querySelectorAll('select[name="cat_id[]"], input[name="cat_tax[]"], input[name="cat_order[]"]')
    : []
  ).forEach(el=>{
    el.addEventListener('input', computeLive);
    el.addEventListener('change', computeLive);
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('price-input')?.addEventListener('input', computeLive);
  document.getElementById('menu-base-rate')?.addEventListener('input', computeLive);
  bindLiveHandlers(document); // 初期1回だけ
  computeLive();
});
</script>
{% endblock %}
