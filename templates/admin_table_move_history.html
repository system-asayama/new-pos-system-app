<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }} - {{ store_name }}</title>

  {# ✅ CSRF をメタに埋め込む（未定義/空に強い） #}
  {% set token = (
    get_csrf() if get_csrf is defined
    else (csrf_token() if (csrf_token is defined and csrf_token is callable) else (csrf_token if csrf_token is defined else ''))
  ) %}
  <meta name="csrf-token" content="{{ token }}">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 24px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 8px;
      color: #333;
    }
    .subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 24px;
    }
    .filter-section {
      background: #f9f9f9;
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 24px;
    }
    .filter-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .filter-group label {
      font-size: 13px;
      font-weight: 500;
      color: #555;
    }
    .filter-group input,
    .filter-group select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .filter-group select {
      min-width: 150px;
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-primary {
      background: #2563eb;
      color: white;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    .btn-secondary:hover {
      background: #4b5563;
    }
    .stats {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      flex: 1;
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 6px;
      padding: 16px;
    }
    .stat-label {
      font-size: 13px;
      color: #0369a1;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #0c4a6e;
    }
    .table-wrapper {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead {
      background: #f9fafb;
      border-bottom: 2px solid #e5e7eb;
    }
    th {
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }
    td {
      padding: 12px 8px;
      border-bottom: 1px solid #f3f4f6;
    }
    tbody tr:hover {
      background: #f9fafb;
    }
    .mode-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .mode-merge { background: #dbeafe; color: #1e40af; }
    .mode-merge_new { background: #d1fae5; color: #065f46; }
    .mode-swap { background: #fef3c7; color: #92400e; }
    .mode-deny { background: #fee2e2; color: #991b1b; }
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-新規 { background: #dbeafe; color: #1e40af; }
    .status-調理中 { background: #fef3c7; color: #92400e; }
    .status-提供済 { background: #d1fae5; color: #065f46; }
    .status-会計済 { background: #e0e7ff; color: #3730a3; }
    .money { text-align: right; font-family: 'Courier New', monospace; }
    .number { text-align: center; }
    .arrow { color: #6b7280; font-size: 16px; }
    .no-data {
      text-align: center;
      padding: 48px;
      color: #9ca3af;
    }
    .error {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 24px;
    }
    .people-detail {
      font-size: 12px;
      color: #6b7280;
    }
    .btn-cancel {
      background: #dc2626;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-cancel:hover {
      background: #b91c1c;
    }
    .btn-cancel:disabled {
      background: #d1d5db;
      cursor: not-allowed;
    }
    .cancelled-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      background: #f3f4f6;
      color: #6b7280;
    }
    .cancelled-row {
      opacity: 0.6;
      background: #fafafa;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: white;
      margin: 15% auto;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .modal-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #333;
    }
    .modal-body {
      margin-bottom: 24px;
      color: #666;
      line-height: 1.6;
    }
    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .error-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    /* ✅ デバッグUI */
    .debug-toggle { margin-top: 20px; font-size: 13px; color:#6b7280; display:flex; gap:8px; align-items:center; }
    #debugBox { display:none; margin-top:8px; background:#111827; color:#e5e7eb; padding:12px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; max-height:260px; overflow:auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>{{ title }}</h1>
    <div class="subtitle">店舗: {{ store_name }}</div>

    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}

    <!-- フィルター -->
    <div class="filter-section">
      <form method="GET" action="{{ url_for('admin_table_move_history') }}">
        <div class="filter-row">
          <div class="filter-group">
            <label for="from_date">開始日</label>
            <input type="date" id="from_date" name="from_date" value="{{ from_date }}">
          </div>
          <div class="filter-group">
            <label for="to_date">終了日</label>
            <input type="date" id="to_date" name="to_date" value="{{ to_date }}">
          </div>
          <div class="filter-group">
            <label for="table_id">テーブル</label>
            <select id="table_id" name="table_id">
              <option value="">全テーブル</option>
              {% for t in tables %}
              <option value="{{ t.id }}" {% if current_table_id == t.id %}selected{% endif %}>
                {{ t.table_no or t.テーブル番号 or t.id }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <button type="submit" class="btn btn-primary">絞り込み</button>
          </div>
          <div class="filter-group">
            <a href="{{ url_for('admin_table_move_history') }}" class="btn btn-secondary">クリア</a>
          </div>
        </div>
      </form>
    </div>

    <!-- 統計 -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">移動回数</div>
        <div class="stat-value">{{ total_moves }}</div>
      </div>
    </div>

    <!-- 履歴テーブル -->
    <div class="table-wrapper">
      {% if histories and histories|length > 0 %}
      <table>
        <thead>
          <tr>
            <th>日時</th>
            <th>移動元</th>
            <th></th>
            <th>移動先</th>
            <th>モード</th>
            <th>注文ID</th>
            <th>状態</th>
            <th>明細数</th>
            <th>人数</th>
            <th class="money">合計</th>
            <th class="money">既払</th>
            <th class="money">残額</th>
            <th>実行者</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for h in histories %}
          <tr class="{% if h.is_cancelled == 1 %}cancelled-row{% endif %}">
            <td>{{ h.moved_at_local.strftime('%Y-%m-%d %H:%M:%S') if h.moved_at_local else '-' }}</td>
            <td><strong>{{ h.from_table_no }}</strong></td>
            <td class="arrow">→</td>
            <td><strong>{{ h.to_table_no }}</strong></td>
            <td>
              <span class="mode-badge mode-{{ h.mode }}">{{ h.mode }}</span>
            </td>
            <td class="number">{{ h.order_id or '-' }}</td>
            <td>
              {% if h.order_status %}
              <span class="status-badge status-{{ h.order_status }}">{{ h.order_status }}</span>
              {% else %}
              -
              {% endif %}
            </td>
            <td class="number">{{ h.item_count or 0 }}</td>
            <td class="number">
              {% if h.total_people > 0 %}
              <strong>{{ h.total_people }}</strong>
              <div class="people-detail">
                {% if h.adult_male %}男{{ h.adult_male }}{% endif %}
                {% if h.adult_female %}女{{ h.adult_female }}{% endif %}
                {% if h.child_male %}子男{{ h.child_male }}{% endif %}
                {% if h.child_female %}子女{{ h.child_female }}{% endif %}
              </div>
              {% else %}
              -
              {% endif %}
            </td>
            <td class="money">{{ '¥{:,}'.format(h.total) if h.total else '-' }}</td>
            <td class="money">{{ '¥{:,}'.format(h.paid) if h.paid else '-' }}</td>
            <td class="money">{{ '¥{:,}'.format(h.remaining) if h.remaining else '-' }}</td>
            <td>{{ h.staff_name or '-' }}</td>
            <td>
              {% if h.is_cancelled == 1 %}
              <span class="cancelled-badge">取消済</span>
              <div class="people-detail">
                {{ h.cancelled_at_local.strftime('%m/%d %H:%M') if h.cancelled_at_local else '' }}<br>
                {{ h.cancelled_by_staff_name or '' }}
              </div>
              {% else %}
              <button class="btn-cancel" onclick="showCancelModal({{ h.id }}, '{{ h.from_table_no }}', '{{ h.to_table_no }}', '{{ h.mode }}')">取消</button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="no-data">
        移動履歴がありません。
      </div>
      {% endif %}
    </div>

    <!-- ✅ デバッグトグル -->
    <label class="debug-toggle"><input type="checkbox" id="debugToggle"> デバッグを表示</label>
    <pre id="debugBox"></pre>
  </div>

  <!-- 取消確認モーダル -->
  <div id="cancelModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">テーブル移動の取消</div>
      <div id="modalError" class="error-message" style="display: none;"></div>
      <div class="modal-body">
        <p id="cancelMessage"></p>
        <p style="margin-top: 12px; font-size: 13px; color: #dc2626;">
          <strong>注意:</strong> この操作は元に戻せません。
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCancelModal()">キャンセル</button>
        <button id="confirmCancelBtn" class="btn-cancel" onclick="confirmCancel()">取消実行</button>
      </div>
    </div>
  </div>

  <script>
    let currentHistoryId = null;

    // ===== Helpers =====
    function getCSRF() {
      const m = document.querySelector('meta[name="csrf-token"]');
      return (m && m.content) ? m.content : '';
    }
    function setDebug(text){
      const on = document.getElementById('debugToggle').checked;
      const box = document.getElementById('debugBox');
      if(on){
        box.style.display='block';
        box.textContent = (box.textContent + '\n' + text).slice(-8000);
      }else{
        box.style.display='none';
      }
      console.debug('[debug]', text);
    }
    async function fetchJSON(url, opts={}) {
      const res = await fetch(url, Object.assign({ credentials: 'same-origin' }, opts));
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      setDebug(`HTTP ${res.status} ${res.statusText}  ${url}\ncontent-type: ${ct}`);
      if (ct.includes('application/json')) {
        const data = await res.json();
        setDebug('JSON: ' + JSON.stringify(data).slice(0,600));
        return { ok: true, status: res.status, data };
      } else {
        const text = await res.text();
        setDebug('HTML/TEXT: ' + text.slice(0,600));
        return { ok: false, status: res.status, html: text };
      }
    }

    // ===== モーダル制御 =====
    function showCancelModal(historyId, fromTable, toTable, mode) {
      currentHistoryId = historyId;

      // モード名を日本語に変換
      const modeNames = {
        'move': '通常移動',
        'merge': '統合',
        'merge_new': '新伝票統合',
        'swap': '交換',
        'deny': '拒否'
      };
      const modeName = modeNames[mode] || mode;

      document.getElementById('cancelMessage').innerHTML =
        `<strong>テーブル ${fromTable} → ${toTable}</strong> の移動（${modeName}）を取り消しますか？`;

      document.getElementById('modalError').style.display = 'none';
      document.getElementById('cancelModal').style.display = 'block';

      // 取消可能かチェック
      checkCancelable(historyId);
    }

    function closeCancelModal() {
      document.getElementById('cancelModal').style.display = 'none';
      currentHistoryId = null;
    }

    // ===== API呼び出し =====
    function checkCancelable(historyId) {
      fetchJSON(`/admin/table/move/cancel_check/${historyId}`)
        .then(res => {
          if (!res.ok) {
            const err = document.getElementById('modalError');
            err.innerHTML = '<strong>取消チェックに失敗:</strong><br>HTMLが返りました（未ログイン/権限/CSRF/例外の可能性）。Network→Responseを確認してください。';
            err.style.display = 'block';
            document.getElementById('confirmCancelBtn').disabled = true;
            return;
          }
          const data = res.data;
          if (data.ok && !data.can_cancel) {
            const errorDiv = document.getElementById('modalError');
            errorDiv.innerHTML = '<strong>取消できません:</strong><br>' + (data.reasons || []).join('<br>');
            errorDiv.style.display = 'block';
            document.getElementById('confirmCancelBtn').disabled = true;
          } else {
            document.getElementById('confirmCancelBtn').disabled = false;
          }
        })
        .catch(error => {
          setDebug('checkCancelable error: ' + (error && error.message));
          console.error('Error checking cancelable:', error);
        });
    }

    function confirmCancel() {
      if (!currentHistoryId) return;

      const btn = document.getElementById('confirmCancelBtn');
      btn.disabled = true;
      btn.textContent = '処理中...';

      const csrf = getCSRF();

      fetchJSON('/admin/table/move/cancel', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          // ✅ サーバ実装に合わせて。まずは X-CSRFToken
          'X-CSRFToken': csrf
        },
        body: JSON.stringify({ history_id: currentHistoryId })
      })
      .then(res => {
        if (!res.ok) {
          // HTML(=リダイレクト/エラー)が返っている
          const errorDiv = document.getElementById('modalError');
          const snippet = (res.html || '').slice(0, 400).replace(/</g, '&lt;');
          errorDiv.innerHTML =
            '<strong>エラー:</strong> サーバがJSONを返しませんでした。<br>' +
            '認証/権限/CSRF/例外の可能性があります。<br><br>' +
            '<code style="white-space:pre-wrap">' + snippet + '</code>';
          errorDiv.style.display = 'block';
          btn.disabled = false;
          btn.textContent = '取消実行';
          return;
        }
        const data = res.data;
        if (data.ok) {
          alert('テーブル移動を取り消しました。');
          location.reload();
        } else {
          const errorDiv = document.getElementById('modalError');
          errorDiv.innerHTML = '<strong>エラー:</strong> ' + (data.error || '取消に失敗しました');
          errorDiv.style.display = 'block';
          btn.disabled = false;
          btn.textContent = '取消実行';
        }
      })
      .catch(error => {
        setDebug('confirmCancel catch: ' + (error && error.message));
        alert('エラーが発生しました: ' + error.message);
        btn.disabled = false;
        btn.textContent = '取消実行';
      });
    }

    // モーダル外クリックで閉じる
    window.onclick = function(event) {
      const modal = document.getElementById('cancelModal');
      if (event.target == modal) {
        closeCancelModal();
      }
    };

    // デバッグトグル
    document.getElementById('debugToggle').addEventListener('change', () => setDebug('--- debug toggled ---'));
  </script>
</body>
</html>
