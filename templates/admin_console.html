{% extends "base.html" %}
{% block content %}
<h2 style="margin-bottom:12px;">åº—èˆ—ç®¡ç†ãƒšãƒ¼ã‚¸</h2>
<p class="small" style="color:#666; margin-top:0;">
  {% if store_name %}åº—èˆ—: <strong>{{ store_name }}</strong>{% endif %}
  {% if sid %}ï¼ˆID: {{ sid }}ï¼‰{% endif %}
</p>

<div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));">

  <!-- â–¼ KDSç®¡ç†ã‚«ãƒ¼ãƒ‰ï¼ˆãƒœã‚¿ãƒ³æ–‡è¨€ã‚’ã€Œé–‹ãã€ã«å¤‰æ›´ï¼‰ -->
  <div class="card">
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
      <div style="font-size:22px;">ğŸ³</div>
      <div style="font-weight:600; font-size:16px;">KDSç®¡ç†</div>
    </div>
    <div class="small" style="color:#666; margin-bottom:12px;">
      KDSã®ã‚«ãƒ†ã‚´ãƒªä½œæˆã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‰²å½“
    </div>
    <div class="actions">
      {% if has_endpoint('admin_kds_home') %}
        <a class="btn" href="{{ url_for('admin_kds_home') }}">é–‹ã</a>
      {% else %}
        <span class="btn sub" aria-disabled="true" title="æœªå®Ÿè£…">é–‹ã</span>
      {% endif %}
    </div>
  </div>
  <!-- â–² ã“ã“ã¾ã§ -->

  <!-- â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«å£²ä¸Šå±¥æ­´ï¼ˆæ–°è¦ã‚«ãƒ¼ãƒ‰ï¼‰ -->
  <div class="card">
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
      <div style="font-size:22px;">ğŸ§¾</div>
      <div style="font-weight:600; font-size:16px;">ãƒ†ãƒ¼ãƒ–ãƒ«å£²ä¸Šå±¥æ­´</div>
    </div>
    <div class="small" style="color:#666; margin-bottom:12px;">
      ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã®å£²ä¸Šãƒ»ä¼ç¥¨å±¥æ­´ã‚’æœŸé–“æŒ‡å®šã§ç¢ºèªã§ãã¾ã™
    </div>
    <div class="actions">
      {% if has_endpoint('admin_table_sales') %}
        <a class="btn" href="{{ url_for('admin_table_sales') }}">é–‹ã</a>
      {% else %}
        <span class="btn sub" aria-disabled="true" title="æœªå®Ÿè£…">é–‹ã</span>
      {% endif %}
    </div>
  </div>
  <!-- â–² ã“ã“ã¾ã§ -->

  <!-- â˜… åˆæµPINè¨­å®šã‚«ãƒ¼ãƒ‰ -->
  <div class="card">
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
      <div style="font-size:22px;">ğŸ”</div>
      <div style="font-weight:600; font-size:16px;">åˆæµPINè¨­å®š</div>
    </div>
    <div class="small" style="color:#666; margin-bottom:12px;">
      ãŠå®¢æ§˜ãŒæ—¢å­˜ã®æ³¨æ–‡ã«åˆæµã™ã‚‹ã¨ãã« PIN ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã‚’å¿…é ˆã«ã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
    </div>

    {# require_join_pin ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã¨ã—ã¦æ¸¡ã•ã‚Œã¦ã„ã‚‹æƒ³å®šã€‚ç„¡ã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1(å¿…é ˆ) #}
    {% set require_join_pin_val = require_join_pin if require_join_pin is defined else 1 %}

    <form method="post"
          action="{{ url_for('admin_toggle_join_pin') }}"
          id="join-pin-form">

      {# CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ã“ã“ã« hidden ã‚’å…¥ã‚Œã‚‹ï¼ˆä¾‹: csrf_token å¤‰æ•°ãŒã‚ã‚‹ã¨ãï¼‰ #}
      {% if csrf_token is defined and csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      {% endif %}

      {# å¤‰æ›´å‰ã®çŠ¶æ…‹ã‚’JSå´ã§åˆ¤å®šã™ã‚‹ãŸã‚ã«ä¿æŒ #}
      <input type="hidden" id="join-pin-current" value="{{ require_join_pin_val }}">

      <div class="small" style="margin-bottom:8px;">
        <label>
          <input type="checkbox" name="require_join_pin" value="1"
                 {% if require_join_pin_val %}checked{% endif %}>
          åˆæµPINã‚’å¿…é ˆã«ã™ã‚‹
        </label>
      </div>

      <!-- â˜… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦³ç‚¹ã‹ã‚‰ã®æ³¨æ„ã‚³ãƒ¡ãƒ³ãƒˆ -->
      <div class="small" style="color:#b91c1c; margin-bottom:12px;">
        ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¦³ç‚¹ã‹ã‚‰ã€åˆæµPINã‚’<strong>ã€Œå¿…é ˆã€ã®ã¾ã¾é‹ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨</strong>ã—ã¾ã™ã€‚<br>
        åˆæµPINã‚’å¿…é ˆã«ã—ãªã„å ´åˆã€QRã‚³ãƒ¼ãƒ‰ã‚„ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’çŸ¥ã£ã¦ã„ã‚‹ç¬¬ä¸‰è€…ãŒã€
        æœ¬äººã«ãªã‚Šã™ã¾ã—ã¦æ³¨æ–‡ã«åˆæµã§ãã‚‹ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚Šã¾ã™ã€‚
      </div>

      <div class="actions">
        <button type="submit" class="btn">ä¿å­˜</button>
      </div>
    </form>
  </div>
  <!-- â˜… ã“ã“ã¾ã§ åˆæµPINè¨­å®šã‚«ãƒ¼ãƒ‰ -->

  {% for t in tiles %}
  <div class="card">
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
      <div style="font-size:22px;">{{ t.emoji }}</div>
      <div style="font-weight:600; font-size:16px;">{{ t.title }}</div>
    </div>

    {% if t.desc %}
      <div class="small" style="color:#666; margin-bottom:12px;">{{ t.desc }}</div>
    {% endif %}

    <div class="actions">
      {% if t.actions %}
        {% for a in t.actions %}
          {% set ep = a.endpoint %}
          {% set label = a.label or 'é–‹ã' %}
          {% set variant = a.variant or '' %}
          {% if ep and has_endpoint(ep) %}
            <a class="btn {{ 'sub' if variant=='sub' else '' }}" href="{{ url_for(ep) }}">{{ label }}</a>
          {% else %}
            <span class="btn sub" aria-disabled="true" title="æœªå®Ÿè£…">{{ label }}</span>
          {% endif %}
        {% endfor %}
      {% else %}
        {% if t.endpoint and has_endpoint(t.endpoint) %}
          <a class="btn" href="{{ url_for(t.endpoint) }}">{{ t.cta or 'é–‹ã' }}</a>
        {% else %}
          <span class="small" style="color:#9ca3af">ãƒªãƒ³ã‚¯æœªè¨­å®šï¼ˆã¾ãŸã¯æœªå®Ÿè£…ï¼‰</span>
        {% endif %}
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

{# â˜… åˆæµPINã‚’ã€Œå¿…é ˆ â†’ éå¿…é ˆã€ã«å¤‰æ›´ã™ã‚‹ã¨ãã ã‘ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã™ #}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('join-pin-form');
  if (!form) return;

  const checkbox = form.querySelector('input[name="require_join_pin"]');
  const currentValEl = document.getElementById('join-pin-current');

  form.addEventListener('submit', function (e) {
    if (!checkbox) return;

    const wasRequired = currentValEl ? (currentValEl.value === '1') : true;  // æ—§çŠ¶æ…‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿…é ˆï¼‰
    const willRequired = checkbox.checked;  // ä¿å­˜å¾ŒçŠ¶æ…‹

    // ã€Œå¿…é ˆ(1) â†’ éå¿…é ˆ(0)ã€ã«å¤‰æ›´ã—ã‚ˆã†ã¨ã—ãŸã¨ãã ã‘è­¦å‘Šã‚’å‡ºã™
    if (wasRequired && !willRequired) {
      const ok = window.confirm(
        'åˆæµPINã‚’ã€Œå¿…é ˆã«ã—ãªã„ã€è¨­å®šã«å¤‰æ›´ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚\n' +
        'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ãƒªã‚¹ã‚¯ï¼ˆãªã‚Šã™ã¾ã—ã«ã‚ˆã‚‹ä¸æ­£æ³¨æ–‡ãªã©ï¼‰ãŒé«˜ã¾ã‚Šã¾ã™ãŒã€\n' +
        'æœ¬å½“ã«å¤‰æ›´ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
      );
      if (!ok) {
        e.preventDefault();
      }
    }
  });
});
</script>

{% endblock %}
