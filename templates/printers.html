{% extends "base.html" %}
{% block content %}
<h2>ãƒ—ãƒªãƒ³ã‚¿è¨­å®š</h2>

<!-- printer-serverãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ -->
<div class="card" style="background:#f0f8ff; border:2px solid #4a90e2; margin-bottom:16px">
  <h3 style="margin-top:0; color:#2c5aa0">ğŸ“¦ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã‚µãƒ¼ãƒãƒ¼</h3>
  <p style="margin:8px 0">
    ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒ—ãƒªãƒ³ã‚¿ã¸å°åˆ·ã™ã‚‹ãŸã‚ã«ã¯ã€<strong>ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ­ãƒ¼ã‚«ãƒ«PCã§èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</strong>ã€‚
  </p>
  <div class="row" style="gap:12px; align-items:center; margin-top:12px">
    <a href="{{ url_for('download_printer_server') }}" class="btn primary" style="text-decoration:none">
      â¬‡ï¸ printer-server.zip ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    </a>
    <span class="muted">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€è§£å‡ã—ã¦ <code>start.bat</code> ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</span>
  </div>
  <details style="margin-top:12px">
    <summary style="cursor:pointer; color:#2c5aa0">â„¹ï¸ è©³ã—ã„æ‰‹é †</summary>
    <ol style="margin:8px 0; padding-left:20px; line-height:1.8">
      <li>ä¸Šè¨˜ãƒœã‚¿ãƒ³ã‹ã‚‰ <code>printer-server.zip</code> ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
      <li>ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»»æ„ã®å ´æ‰€ã«è§£å‡</li>
      <li><code>printer-server</code> ãƒ•ã‚©ãƒ«ãƒ€å†…ã® <code>start.bat</code> ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯</li>
      <li>ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒé–‹ãã€ã€ŒServer running on http://localhost:3001ã€ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸ</li>
      <li>ä¸‹è¨˜ã®ã€Œæ–°è¦ãƒ—ãƒªãƒ³ã‚¿ã€ã§ç¨®åˆ¥ã‚’ <code>printer_server</code> ã«ã—ã¦ç™»éŒ²</li>
    </ol>
  </details>
</div>

<div class="grid" style="grid-template-columns:1fr 1fr; gap:16px">
  <!-- å·¦ï¼šæ‰‹å‹•ç™»éŒ² -->
  <div class="card">
    <h3>æ–°è¦ãƒ—ãƒªãƒ³ã‚¿</h3>
    <form method="post" action="{{ url_for('admin_printers_new') }}">
      <label>åç§°</label>
      <input name="åç§°" required>
      <label>ç¨®åˆ¥</label>
      <select name="ç¨®åˆ¥">
        <option value="escpos_tcp">escpos_tcp (tcp://IP:9100)</option>
        <option value="cups">cups (ipp(s):// / cups://PrinterName)</option>
        <option value="windows">windows (win://PrinterName)</option>
        <option value="printer_server">printer_server (http://IP:3001)</option>
      </select>
      <label>æ¥ç¶šæƒ…å ±</label>
      <input name="æ¥ç¶šæƒ…å ±" placeholder="tcp://192.168.1.60:9100 ãªã©" required>
      <label>å¹…æ–‡å­—</label>
      <input name="å¹…æ–‡å­—" type="number" value="42" min="24" max="64">
      <button class="btn" type="submit">è¿½åŠ </button>
    </form>
  </div>

  <!-- å³ï¼šè‡ªå‹•æ¤œå‡º -->
  <div class="card">
    <h3>åŒä¸€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰è‡ªå‹•æ¤œå‡º</h3>

    <div class="row" style="gap:8px; flex-wrap:wrap; align-items:flex-end">
      <div>
        <label>æ–¹å¼</label>
        <select id="discover-mode">
          <option value="auto">autoï¼ˆmDNS + ã‚¹ã‚­ãƒ£ãƒ³ï¼‰</option>
          <option value="mdns">mDNS/Bonjour</option>
          <option value="scan">ARP/ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³</option>
        </select>
      </div>
      <div>
        <label>CIDRï¼ˆä»»æ„ãƒ»scanæ™‚ï¼‰</label>
        <input id="discover-cidr" placeholder="ä¾‹: 192.168.1.0/24">
      </div>
      <div>
        <label>ãƒãƒ¼ãƒˆï¼ˆä»»æ„ãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
        <input id="discover-ports" value="9100,631,3001">
      </div>
      <div>
        <button class="btn sub" id="btn-discover" type="button">æ¤œå‡ºé–‹å§‹</button>
      </div>
    </div>

    <div class="muted" style="margin-top:8px">
      {% if discover_info and discover_info.mdns %}
        mDNSåˆ©ç”¨å¯
      {% else %}
        mDNSæœªã‚µãƒãƒ¼ãƒˆï¼ˆzeroconfæœªå°å…¥ï¼‰ã€‚<code>auto</code>ã§ã‚‚ã‚¹ã‚­ãƒ£ãƒ³ã¯å‹•ä½œã—ã¾ã™ã€‚
      {% endif %}
    </div>

    <div id="discover-msg" class="muted" style="margin:8px 0;"></div>

    <div style="overflow:auto; max-height:360px; border:1px solid var(--border); border-radius:8px;">
      <table style="width:100%; border-collapse:collapse">
        <thead>
          <tr>
            <th style="padding:8px; border-bottom:1px solid var(--border)"><input type="checkbox" id="chk-all"></th>
            <th style="padding:8px; border-bottom:1px solid var(--border)">åç§°</th>
            <th style="padding:8px; border-bottom:1px solid var(--border)">ç¨®åˆ¥</th>
            <th style="padding:8px; border-bottom:1px solid var(--border)">æ¥ç¶šæƒ…å ±</th>
            <th style="padding:8px; border-bottom:1px solid var(--border); width:90px">å¹…æ–‡å­—</th>
            <th style="padding:8px; border-bottom:1px solid var(--border)">æ¤œå‡ºå…ƒ</th>
          </tr>
        </thead>
        <tbody id="discover-body">
          <tr><td colspan="6" class="muted" style="padding:8px">æœªæ¤œå‡º</td></tr>
        </tbody>
      </table>
    </div>

    <div style="margin-top:8px" class="row">
      <button class="btn primary" id="btn-import" type="button" disabled>é¸æŠã‚’ç™»éŒ²</button>
      <span id="import-msg" class="muted"></span>
    </div>

    <details class="debug" id="discover-debug" style="display:none; margin-top:8px">
      <summary>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</summary>
      <pre id="discover-debug-pre" class="debug-pre"></pre>
    </details>
  </div>
</div>

<!-- ä¸‹ï¼šä¸€è¦§ -->
<div class="card" style="margin-top:16px">
  <h3>ç™»éŒ²æ¸ˆã¿ä¸€è¦§</h3>
  <table style="width:100%; border-collapse:collapse">
    <thead>
      <tr>
        <th style="padding:8px; border-bottom:1px solid var(--border)">#</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">åç§°</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">ç¨®åˆ¥</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">æ¥ç¶š</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">å¹…</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">æœ‰åŠ¹</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      {% for p in printers %}
      <tr>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ p['id'] }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ p['åç§°'] }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ p['ç¨®åˆ¥'] }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ p['æ¥ç¶šæƒ…å ±'] }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ p['å¹…æ–‡å­—'] }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ 'â—¯' if p['æœ‰åŠ¹']==1 else 'Ã—' }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <form method="post" action="{{ url_for('admin_printers_toggle', pid=p['id']) }}" style="display:inline">
            <button class="btn sub" type="submit">æœ‰åŠ¹åˆ‡æ›¿</button>
          </form>
          <button class="btn sub" onclick="editPrinter({{ p['id'] }}, '{{ p['åç§°'] }}', '{{ p['ç¨®åˆ¥'] }}', '{{ p['æ¥ç¶šæƒ…å ±'] }}', {{ p['å¹…æ–‡å­—'] }})">ç·¨é›†</button>
          <form method="post" action="{{ url_for('admin_printers_delete', pid=p['id']) }}" style="display:inline" onsubmit="return confirm('{% if p['ä½¿ç”¨ä¸­'] %}ã“ã®ãƒ—ãƒªãƒ³ã‚¿ã¯{{ p['ãƒ«ãƒ¼ãƒ«æ•°'] }}ä»¶ã®å°åˆ·ãƒ«ãƒ¼ãƒ«ã§ä½¿ç”¨ä¸­ã§ã™ã€‚\nå‰Šé™¤ã™ã‚‹ã¨é–¢é€£ã™ã‚‹å°åˆ·ãƒ«ãƒ¼ãƒ«ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\n{% endif %}ãƒ—ãƒªãƒ³ã‚¿ã€Œ{{ p['åç§°'] }}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
            <button class="btn sub" type="submit" style="background:#dc3545; color:white">å‰Šé™¤</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      {% if not printers %}
      <tr><td colspan="7" class="muted" style="padding:8px">ç™»éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
(() => {
  const DISCOVER_URL = "{{ url_for('admin_printers_discover') }}";
  const IMPORT_URL   = "{{ url_for('admin_printers_import') }}";

  const $ = (sel) => document.querySelector(sel);
  const bodyEl   = $("#discover-body");
  const msgEl    = $("#discover-msg");
  const btnDiscover = $("#btn-discover");
  const btnImport   = $("#btn-import");
  const chkAll      = $("#chk-all");
  const dbgBox      = $("#discover-debug");
  const dbgPre      = $("#discover-debug-pre");
  const importMsg   = $("#import-msg");

  const KIND_OPTIONS = [
    {value: "escpos_tcp", label: "escpos_tcp"},
    {value: "cups",       label: "cups"},
    {value: "windows",    label: "windows"},
    {value: "printer_server", label: "printer_server"},
  ];

  function deduceKindFromCandidate(c){
    // ã‚µãƒ¼ãƒå´ kind ã¯ "ESC_POS" or "IPP" ã‚’è¿”ã™æƒ³å®š
    const k = (c.kind||"").toUpperCase();
    if (k.includes("ESC") || (c.port === 9100) || (c.connection||"").startsWith("tcp://")) return "escpos_tcp";
    if (k.includes("IPP")  || (c.port === 631)  || (c.connection||"").startsWith("ipp"))   return "cups";
    return "escpos_tcp";
  }

  function setLoading(loading){
    btnDiscover.disabled = loading;
    msgEl.textContent = loading ? "æ¤œå‡ºä¸­..." : "";
  }

  function renderCandidates(list){
    if (!Array.isArray(list) || !list.length){
      bodyEl.innerHTML = '<tr><td colspan="6" class="muted" style="padding:8px">å€™è£œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</td></tr>';
      btnImport.disabled = true;
      return;
    }
    bodyEl.innerHTML = "";
    list.forEach((c, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <input type="checkbox" class="cand-check">
        </td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <input class="cand-name" value="${(c.name||`Printer-${c.ip||""}`)}" style="width:180px">
        </td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <select class="cand-kind" style="min-width:140px"></select>
        </td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <input class="cand-conn" value="${(c.connection||"")}" style="width:260px">
        </td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <input type="number" class="cand-width" value="${parseInt(c.width||42)}" min="24" max="64" style="width:80px">
        </td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <span class="muted">${c.source||"-"}</span>
        </td>
      `;
      // ç¨®åˆ¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const sel = tr.querySelector(".cand-kind");
      KIND_OPTIONS.forEach(opt=>{
        const o = document.createElement("option");
        o.value = opt.value; o.textContent = opt.label;
        sel.appendChild(o);
      });
      sel.value = deduceKindFromCandidate(c);

      bodyEl.appendChild(tr);
    });
    btnImport.disabled = false;
  }

  function getSelectedItems(){
    const rows = [...bodyEl.querySelectorAll("tr")];
    const items = [];
    rows.forEach(r=>{
      const chk = r.querySelector(".cand-check");
      if (chk && chk.checked){
        const name  = r.querySelector(".cand-name")?.value?.trim();
        const kind  = r.querySelector(".cand-kind")?.value;
        const conn  = r.querySelector(".cand-conn")?.value?.trim();
        const width = parseInt(r.querySelector(".cand-width")?.value||"42", 10);
        if (conn){
          items.push({name, kind, connection: conn, width});
        }
      }
    });
    return items;
  }

  chkAll?.addEventListener("change", (e)=>{
    const on = e.target.checked;
    bodyEl.querySelectorAll(".cand-check").forEach(c => c.checked = on);
  });

  btnDiscover.addEventListener("click", async ()=>{
    const mode  = document.getElementById("discover-mode").value;
    const cidr  = document.getElementById("discover-cidr").value.trim();
    const ports = document.getElementById("discover-ports").value.trim();

    setLoading(true);
    dbgBox.style.display = "none"; dbgPre.textContent = "";
    importMsg.textContent = "";

    try{
      const url = new URL(DISCOVER_URL, location.origin);
      url.searchParams.set("mode", mode || "auto");
      if (cidr)  url.searchParams.set("cidr", cidr);
      if (ports) url.searchParams.set("ports", ports);

      const res = await fetch(url.toString(), {credentials:"same-origin"});
      const text = await res.text();
      let j;
      try{ j = JSON.parse(text); }catch(e){ j = {ok:false, error:"JSON parse error", raw:text}; }
      if (j.debug){ dbgBox.style.display = "block"; dbgPre.textContent = JSON.stringify(j.debug, null, 2); }

      if (!res.ok || !j.ok){
        msgEl.textContent = "æ¤œå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: " + (j.error || res.status);
        bodyEl.innerHTML = '<tr><td colspan="6" class="muted" style="padding:8px">ã‚¨ãƒ©ãƒ¼</td></tr>';
        btnImport.disabled = true;
        return;
      }
      msgEl.textContent = `å€™è£œ ${j.count} ä»¶`;
      renderCandidates(j.candidates||[]);
    }catch(e){
      msgEl.textContent = "æ¤œå‡ºä¸­ã«ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e;
      bodyEl.innerHTML = '<tr><td colspan="6" class="muted" style="padding:8px">ã‚¨ãƒ©ãƒ¼</td></tr>';
      btnImport.disabled = true;
    }finally{
      setLoading(false);
    }
  });

  btnImport.addEventListener("click", async ()=>{
    const items = getSelectedItems();
    if (!items.length){
      importMsg.textContent = "ç™»éŒ²å¯¾è±¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
      return;
    }
    btnImport.disabled = true;
    importMsg.textContent = "ç™»éŒ²ä¸­...";

    try{
      const res = await fetch(IMPORT_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json", "Accept":"application/json"},
        credentials: "same-origin",
        body: JSON.stringify({items})
      });
      const j = await res.json().catch(()=>({ok:false, error:"JSON parse error"}));
      if (!res.ok || !j.ok){
        importMsg.textContent = "ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (j.error || res.status);
        btnImport.disabled = false;
        return;
      }
      importMsg.textContent = `ç™»éŒ²å®Œäº†: ${j.created} ä»¶`;
      // å†èª­ã¿è¾¼ã¿ã—ã¦ä¸€è¦§ã‚’æœ€æ–°åŒ–
      setTimeout(()=> location.reload(), 600);
    }catch(e){
      importMsg.textContent = "ç™»éŒ²æ™‚ã‚¨ãƒ©ãƒ¼: " + e;
      btnImport.disabled = false;
    }
  });
})();

// ç·¨é›†æ©Ÿèƒ½
window.editPrinter = function(id, name, kind, conn, width) {
  const form = document.querySelector('form[action*="/new"]');
  if (!form) return;
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
  form.querySelector('input[name="åç§°"]').value = name;
  form.querySelector('select[name="ç¨®åˆ¥"]').value = kind;
  form.querySelector('input[name="æ¥ç¶šæƒ…å ±"]').value = conn;
  form.querySelector('input[name="å¹…æ–‡å­—"]').value = width;
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã®actionã‚’ç·¨é›†ç”¨ã«å¤‰æ›´
  form.action = `/admin/printers/${id}/edit`;
  
  // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
  const btn = form.querySelector('button[type="submit"]');
  btn.textContent = 'æ›´æ–°';
  btn.style.background = '#28a745';
  
  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
  if (!form.querySelector('.cancel-edit')) {
    const cancelBtn = document.createElement('button');
    cancelBtn.type = 'button';
    cancelBtn.className = 'btn sub cancel-edit';
    cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    cancelBtn.onclick = function() {
      form.reset();
      form.action = form.dataset.originalAction || '/admin/printers/new';
      btn.textContent = 'è¿½åŠ ';
      btn.style.background = '';
      cancelBtn.remove();
    };
    btn.parentNode.insertBefore(cancelBtn, btn.nextSibling);
  }
  
  // å…ƒã®actionã‚’ä¿å­˜
  if (!form.dataset.originalAction) {
    form.dataset.originalAction = '/admin/printers/new';
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  form.scrollIntoView({ behavior: 'smooth', block: 'center' });
};
</script>
{% endblock %}
