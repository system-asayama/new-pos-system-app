{% extends "base.html" %}
{% block content %}
<h2>プリンタ設定</h2>

<div class="grid" style="grid-template-columns:1fr 1fr; gap:16px">
  <!-- 左：手動登録 -->
  <div class="card">
    <h3>新規プリンタ</h3>
    <form method="post" action="{{ url_for('admin_printers_new') }}">
      <label>名称</label>
      <input name="名称" required>
      <label>種別</label>
      <select name="種別">
        <option value="escpos_tcp">escpos_tcp (tcp://IP:9100)</option>
        <option value="cups">cups (ipp(s):// / cups://PrinterName)</option>
        <option value="windows">windows (win://PrinterName)</option>
        <option value="printer_server">printer_server (http://IP:3001)</option>
      </select>
      <label>接続情報</label>
      <input name="接続情報" placeholder="tcp://192.168.1.60:9100 など" required>
      <label>幅文字</label>
      <input name="幅文字" type="number" value="42" min="24" max="64">
      <button class="btn" type="submit">追加</button>
    </form>
  </div>

  <!-- 右：自動検出 -->
  <div class="card">
    <h3>同一ネットワークから自動検出</h3>

    <div class="row" style="gap:8px; flex-wrap:wrap; align-items:flex-end">
      <div>
        <label>方式</label>
        <select id="discover-mode">
          <option value="auto">auto（mDNS + スキャン）</option>
          <option value="mdns">mDNS/Bonjour</option>
          <option value="scan">ARP/ポートスキャン</option>
        </select>
      </div>
      <div>
        <label>CIDR（任意・scan時）</label>
        <input id="discover-cidr" placeholder="例: 192.168.1.0/24">
      </div>
      <div>
        <label>ポート（任意・カンマ区切り）</label>
        <input id="discover-ports" value="9100,631,3001">
      </div>
      <div>
        <button class="btn sub" id="btn-discover" type="button">検出開始</button>
      </div>
    </div>

    <div class="muted" style="margin-top:8px">
      {% if discover_info and discover_info.mdns %}
        mDNS利用可
      {% else %}
        mDNS未サポート（zeroconf未導入）。<code>auto</code>でもスキャンは動作します。
      {% endif %}
    </div>

    <div id="discover-msg" class="muted" style="margin:8px 0;"></div>

    <div style="overflow:auto; max-height:360px; border:1px solid var(--border); border-radius:8px;">
      <table style="width:100%; border-collapse:collapse">
        <thead>
          <tr>
            <th style="padding:8px; border-bottom:1px solid var(--border)"><input type="checkbox" id="chk-all"></th>
            <th style="padding:8px; border-bottom:1px solid var(--border)">名称</th>
            <th style="padding:8px; border-bottom:1px solid var(--border)">種別</th>
            <th style="padding:8px; border-bottom:1px solid var(--border)">接続情報</th>
            <th style="padding:8px; border-bottom:1px solid var(--border); width:90px">幅文字</th>
            <th style="padding:8px; border-bottom:1px solid var(--border)">検出元</th>
          </tr>
        </thead>
        <tbody id="discover-body">
          <tr><td colspan="6" class="muted" style="padding:8px">未検出</td></tr>
        </tbody>
      </table>
    </div>

    <div style="margin-top:8px" class="row">
      <button class="btn primary" id="btn-import" type="button" disabled>選択を登録</button>
      <span id="import-msg" class="muted"></span>
    </div>

    <details class="debug" id="discover-debug" style="display:none; margin-top:8px">
      <summary>デバッグ情報</summary>
      <pre id="discover-debug-pre" class="debug-pre"></pre>
    </details>
  </div>
</div>

<!-- 下：一覧 -->
<div class="card" style="margin-top:16px">
  <h3>登録済み一覧</h3>
  <table style="width:100%; border-collapse:collapse">
    <thead>
      <tr>
        <th style="padding:8px; border-bottom:1px solid var(--border)">#</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">名称</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">種別</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">接続</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">幅</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">有効</th>
        <th style="padding:8px; border-bottom:1px solid var(--border)">操作</th>
      </tr>
    </thead>
    <tbody>
      {% for p in printers %}
      <tr>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ p['id'] }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ p['名称'] }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ p['種別'] }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ p['接続情報'] }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ p['幅文字'] }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">{{ '◯' if p['有効']==1 else '×' }}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <form method="post" action="{{ url_for('admin_printers_toggle', pid=p['id']) }}" style="display:inline">
            <button class="btn sub" type="submit">有効切替</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      {% if not printers %}
      <tr><td colspan="7" class="muted" style="padding:8px">登録はまだありません</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
(() => {
  const DISCOVER_URL = "{{ url_for('admin_printers_discover') }}";
  const IMPORT_URL   = "{{ url_for('admin_printers_import') }}";

  const $ = (sel) => document.querySelector(sel);
  const bodyEl   = $("#discover-body");
  const msgEl    = $("#discover-msg");
  const btnDiscover = $("#btn-discover");
  const btnImport   = $("#btn-import");
  const chkAll      = $("#chk-all");
  const dbgBox      = $("#discover-debug");
  const dbgPre      = $("#discover-debug-pre");
  const importMsg   = $("#import-msg");

  const KIND_OPTIONS = [
    {value: "escpos_tcp", label: "escpos_tcp"},
    {value: "cups",       label: "cups"},
    {value: "windows",    label: "windows"},
    {value: "printer_server", label: "printer_server"},
  ];

  function deduceKindFromCandidate(c){
    // サーバ側 kind は "ESC_POS" or "IPP" を返す想定
    const k = (c.kind||"").toUpperCase();
    if (k.includes("ESC") || (c.port === 9100) || (c.connection||"").startsWith("tcp://")) return "escpos_tcp";
    if (k.includes("IPP")  || (c.port === 631)  || (c.connection||"").startsWith("ipp"))   return "cups";
    return "escpos_tcp";
  }

  function setLoading(loading){
    btnDiscover.disabled = loading;
    msgEl.textContent = loading ? "検出中..." : "";
  }

  function renderCandidates(list){
    if (!Array.isArray(list) || !list.length){
      bodyEl.innerHTML = '<tr><td colspan="6" class="muted" style="padding:8px">候補は見つかりませんでした</td></tr>';
      btnImport.disabled = true;
      return;
    }
    bodyEl.innerHTML = "";
    list.forEach((c, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <input type="checkbox" class="cand-check">
        </td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <input class="cand-name" value="${(c.name||`Printer-${c.ip||""}`)}" style="width:180px">
        </td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <select class="cand-kind" style="min-width:140px"></select>
        </td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <input class="cand-conn" value="${(c.connection||"")}" style="width:260px">
        </td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <input type="number" class="cand-width" value="${parseInt(c.width||42)}" min="24" max="64" style="width:80px">
        </td>
        <td style="padding:8px; border-bottom:1px solid var(--border)">
          <span class="muted">${c.source||"-"}</span>
        </td>
      `;
      // 種別オプション
      const sel = tr.querySelector(".cand-kind");
      KIND_OPTIONS.forEach(opt=>{
        const o = document.createElement("option");
        o.value = opt.value; o.textContent = opt.label;
        sel.appendChild(o);
      });
      sel.value = deduceKindFromCandidate(c);

      bodyEl.appendChild(tr);
    });
    btnImport.disabled = false;
  }

  function getSelectedItems(){
    const rows = [...bodyEl.querySelectorAll("tr")];
    const items = [];
    rows.forEach(r=>{
      const chk = r.querySelector(".cand-check");
      if (chk && chk.checked){
        const name  = r.querySelector(".cand-name")?.value?.trim();
        const kind  = r.querySelector(".cand-kind")?.value;
        const conn  = r.querySelector(".cand-conn")?.value?.trim();
        const width = parseInt(r.querySelector(".cand-width")?.value||"42", 10);
        if (conn){
          items.push({name, kind, connection: conn, width});
        }
      }
    });
    return items;
  }

  chkAll?.addEventListener("change", (e)=>{
    const on = e.target.checked;
    bodyEl.querySelectorAll(".cand-check").forEach(c => c.checked = on);
  });

  btnDiscover.addEventListener("click", async ()=>{
    const mode  = document.getElementById("discover-mode").value;
    const cidr  = document.getElementById("discover-cidr").value.trim();
    const ports = document.getElementById("discover-ports").value.trim();

    setLoading(true);
    dbgBox.style.display = "none"; dbgPre.textContent = "";
    importMsg.textContent = "";

    try{
      const url = new URL(DISCOVER_URL, location.origin);
      url.searchParams.set("mode", mode || "auto");
      if (cidr)  url.searchParams.set("cidr", cidr);
      if (ports) url.searchParams.set("ports", ports);

      const res = await fetch(url.toString(), {credentials:"same-origin"});
      const text = await res.text();
      let j;
      try{ j = JSON.parse(text); }catch(e){ j = {ok:false, error:"JSON parse error", raw:text}; }
      if (j.debug){ dbgBox.style.display = "block"; dbgPre.textContent = JSON.stringify(j.debug, null, 2); }

      if (!res.ok || !j.ok){
        msgEl.textContent = "検出に失敗しました: " + (j.error || res.status);
        bodyEl.innerHTML = '<tr><td colspan="6" class="muted" style="padding:8px">エラー</td></tr>';
        btnImport.disabled = true;
        return;
      }
      msgEl.textContent = `候補 ${j.count} 件`;
      renderCandidates(j.candidates||[]);
    }catch(e){
      msgEl.textContent = "検出中に例外が発生しました: " + e;
      bodyEl.innerHTML = '<tr><td colspan="6" class="muted" style="padding:8px">エラー</td></tr>';
      btnImport.disabled = true;
    }finally{
      setLoading(false);
    }
  });

  btnImport.addEventListener("click", async ()=>{
    const items = getSelectedItems();
    if (!items.length){
      importMsg.textContent = "登録対象が選択されていません。";
      return;
    }
    btnImport.disabled = true;
    importMsg.textContent = "登録中...";

    try{
      const res = await fetch(IMPORT_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json", "Accept":"application/json"},
        credentials: "same-origin",
        body: JSON.stringify({items})
      });
      const j = await res.json().catch(()=>({ok:false, error:"JSON parse error"}));
      if (!res.ok || !j.ok){
        importMsg.textContent = "登録に失敗しました: " + (j.error || res.status);
        btnImport.disabled = false;
        return;
      }
      importMsg.textContent = `登録完了: ${j.created} 件`;
      // 再読み込みして一覧を最新化
      setTimeout(()=> location.reload(), 600);
    }catch(e){
      importMsg.textContent = "登録時エラー: " + e;
      btnImport.disabled = false;
    }
  });
})();
</script>
{% endblock %}
