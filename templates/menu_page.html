<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ title or APP_TITLE or "ãƒ¡ãƒ‹ãƒ¥ãƒ¼" }}</title>

  <!-- CSRFï¼ˆã‚¹ã‚¿ãƒƒãƒ•å´ãƒ«ãƒ¼ãƒˆç”¨ï¼‰ -->
  {% set token = (
    get_csrf() if get_csrf is defined
    else (csrf_token() if csrf_token is callable else (csrf_token or ''))
  ) %}
  <meta name="csrf-token" content="{{ token }}">

  <style>
    :root{--bg:#f3f4f6;--card:#fff;--text-base:#1f2937;--text-muted:#6b7280;--primary:#4f46e5;--primary-light:#818cf8;--border:#e5e7eb;--ring-color:rgba(79,70,229,.5);--shadow-sm:0 1px 2px rgba(0,0,0,.05);--shadow-md:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--text-base)}
    header{background:var(--card);border-bottom:1px solid var(--border);padding:16px;box-shadow:var(--shadow-sm)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .layout{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯ãƒ¢ãƒã‚¤ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’éè¡¨ç¤º */
    .cart-title-mobile{display:none}
    @media (max-width:900px){
      .layout{grid-template-columns:1fr}
      /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¿ã‚¤ãƒˆãƒ«ã‚’éè¡¨ç¤ºã€ãƒ¢ãƒã‚¤ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º */
      .cart-title-desktop{display:none}
      .cart-title-mobile{display:inline}
      /* æ³¨æ–‡ã‚«ã‚´ã‚’ç”»é¢ä¸‹éƒ¨ã«å›ºå®š */
      #cart-container{
        position:fixed;
        bottom:0;
        left:0;
        right:0;
        z-index:100;
        max-height:50vh;
        overflow-y:auto;
        box-shadow:0 -4px 12px rgba(0,0,0,0.15);
        margin:0;
        border-radius:12px 12px 0 0;
      }
      /* æ³¨æ–‡ã‚«ã‚´ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¿ãƒƒãƒ—å¯èƒ½ã« */
      #cart-container h2{
        cursor:pointer;
        user-select:none;
        padding:8px;
        margin:-8px -8px 12px -8px;
        border-bottom:1px solid var(--border);
      }
      #cart-container h2::after{
        content:'â–¼';
        float:right;
        transition:transform 0.3s;
      }
      #cart-container.collapsed h2::after{
        transform:rotate(180deg);
      }
      #cart-container.collapsed > *:not(h2){
        display:none;
      }
      #cart-container.collapsed{
        max-height:60px;
      }
      /* æ³¨æ–‡ã‚«ã‚´ã®åˆ†ã ã‘ä¸‹éƒ¨ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ  */
      body{padding-bottom:10vh}
      /* ç¾åœ¨ã®æ˜ç´°ã‚’éè¡¨ç¤º */
      #current-detail{display:none !important}
    }
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:var(--shadow-sm);transition:.2s}
    .card:hover{box-shadow:var(--shadow-md);transform:translateY(-2px)}
    h1{font-size:24px;font-weight:700;margin:0}
    h2{font-size:18px;font-weight:600;margin:0 0 12px}
    h3{font-size:16px;font-weight:600;margin:8px 0 4px}
    .muted{color:var(--text-muted);font-size:14px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 16px;border-radius:8px;border:none;cursor:pointer;text-decoration:none;font-weight:500;transition:.2s}
    .btn.primary{background:var(--primary);color:#fff}.btn.primary:hover{background:var(--primary-light)}
    .btn.sub{background:#eef2ff;color:#3730a3}
    .btn[disabled]{opacity:.6;cursor:not-allowed;pointer-events:none}
    .pill{display:inline-flex;align-items:center;padding:6px 12px;border:1px solid var(--border);border-radius:9999px;font-size:14px;background:#f9fafb;cursor:pointer}
    .pill:hover{border-color:var(--primary);background:#eff6ff;color:var(--primary)}
    .pill.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    img{max-width:100%;border-radius:8px;height:150px;object-fit:cover}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .message-card{padding:16px;border-radius:8px;border:1px solid;margin-bottom:24px;background:#fffbeb;border-color:#fde68a;color:#92400e;font-weight:500}
    #category-list{display:block;margin-top:12px}
    .cat-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;padding-top:8px;border-top:1px dashed var(--border)}
    .cat-row[data-depth="0"]{border-top:none;padding-top:0;margin-top:0}
    .loading{text-align:center;font-size:1.25rem;color:var(--text-muted);padding:3rem 0}
    .price-box{display:block}.price-incl{font-weight:700;color:var(--primary);font-size:18px;line-height:1.25}.price-excl{color:var(--text-muted);font-size:14px;line-height:1.25}
    #cart-table,#detail-table{width:100%;border-collapse:collapse}
    /* â–¼ ä¿®æ­£ï¼š#detail-table ã® td ã‚’æ­£ã—ãæŒ‡å®š */
    #cart-table th,#cart-table td,#detail-table th,#detail-table td{border-bottom:1px solid var(--border);padding:8px}
    .totals{margin-top:10px}.totals div{display:flex;justify-content:space-between;margin-top:4px}.totals strong{font-size:16px}
    .qty-input{width:70px;height:36px;border:1px solid var(--border);border-radius:8px;padding:0 8px}
    .text-right{text-align:right}
    .small{font-size:12px}
    .muted-row{color:#6b7280}
    details.debug{margin-top:8px;border:1px dashed var(--border);border-radius:8px;padding:8px;background:#f9fafb}
    details.debug summary{cursor:pointer;font-weight:600}
    pre.debug-pre{white-space:pre-wrap;overflow:auto;max-height:280px;margin:6px 0 0}
    /* ãŠå®¢æ§˜è©³ç´° */
    .cust-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .cust-field{display:flex;flex-direction:column;gap:4px}
    .cust-input{height:36px;border:1px solid var(--border);border-radius:8px;padding:0 8px}
    .ok-badge{display:inline-block;background:#10b981;color:#fff;border-radius:9999px;font-size:12px;padding:3px 10px;margin-left:8px}
    .warn{color:#b45309}
    /* æ¤œç´¢ãƒãƒ¼ */
    .search-bar{display:flex;gap:8px;align-items:center;margin-top:12px}
    .search-input{flex:1;height:36px;border:1px solid var(--border);border-radius:8px;padding:0 10px}
    /* è¿½åŠ : æ³¨æ–‡æ˜ç´°å³å´ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸¦ã³ */
    .inline-actions{display:inline-flex;gap:8px;align-items:center;margin-left:8px}

    /* â–¼ æä¾›åœæ­¢ã®è¦‹ãŸç›® */
    .card.stopped{opacity:.55;filter:grayscale(.5)}
    .card.stopped .btn.primary{opacity:.6;pointer-events:none;cursor:not-allowed}
    .badge-stopped{
      display:inline-block;background:#9CA3AF;color:#fff;
      font-size:12px;border-radius:9999px;padding:2px 8px;margin-left:8px
    }
  </style>
</head>

<body
  data-order-id="{{ (order.id if order is defined and order else '') }}"
  data-table-id="{{ (table.id if table is defined and table else '') }}"
  data-order-table-id="{{ (order.table_id if (order is defined and order) else '') }}"
  data-table-no="{{ (
    table.ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå· if (table is defined and table and (table.ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå· is not none))
    else (table.table_no if (table is defined and table and (table.table_no is not none))
    else (order.table_no if (order is defined and order) else request.args.get('table_no','')))
  ) }}"
  data-is-public="{{ 'true' if is_public else 'false' }}"
  data-user-role="{{ session.get('role', '') }}"
>
  <header>
    <div class="row">
      <h1>{{ store.åç§° if store is defined and store else (store_name if store_name is defined else "ãƒ¡ãƒ‹ãƒ¥ãƒ¼") }}</h1>
      <span class="pill">æ³¨æ–‡ #{{ order.id if order is defined and order else "-" }}</span>
    </div>

    {# â–¼ æ³¨æ–‡æ˜ç´° +ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ä»¥ä¸Š ã‹ã¤ å…¬é–‹URLã§ãªã„ã¨ãã ã‘ï¼‰ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ #}
    {% set _tid = (
      table.id if (table is defined and table and (table.id is not none))
      else (order.table_id if (order is defined and order and (order.table_id is not none))
      else (request.args.get('table_id') if request.args is defined else None))
    ) %}
    {% set role = session.get('role') or '' %}
    {% set is_staff_or_higher = role in [
      'staff','store_staff','store_admin','tenant_admin','sysadmin','admin','manager'
    ] %}
    {# QRå…¬é–‹åˆ¤å®šï¼š?token=... ã¾ãŸã¯ /m/<token> ã‹ã¤ ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³ã§ã¯ãªã„ #}
    {% set is_public = (request.args.get('token') or request.path.startswith('/m/')) and not is_staff_or_higher %}

    <div class="muted" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      ãƒ†ãƒ¼ãƒ–ãƒ«: <span id="table-label">-</span>
      <a class="btn sub" id="btn-detail"
         href="{{ url_for('table_detail', table_id=_tid, token=qr_token) if _tid and qr_token else (url_for('table_detail', table_id=_tid) if _tid else '#') }}"
         {% if not _tid %}aria-disabled="true" role="button"{% endif %}>
        æ³¨æ–‡æ˜ç´°
      </a>

      {# â˜… Jinja: && â†’ and ã«ä¿®æ­£ #}
      {% if is_staff_or_higher and not is_public %}
        <span class="inline-actions">
          <a class="btn sub" href="{{ url_for('staff_floor') }}">ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã¸</a>
        </span>
      {% endif %}

      {# â˜…â˜…â˜… è¿½åŠ ï¼šã‚¹ã‚¿ãƒƒãƒ•ä»¥ä¸Šãªã‚‰â€œã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–â€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆç©ºæ³¨æ–‡ã®ã¿æœ‰åŠ¹ï¼‰ â˜…â˜…â˜… #}
      {% if is_staff_or_higher and order and order.id %}
      <form method="post"
            action="{{ url_for('reset_order_session', order_id=order.id) }}"
            onsubmit="return confirm('ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœªæ³¨æ–‡ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–ã—ã¾ã™ï¼ˆç©ºã®æ³¨æ–‡ãƒ˜ãƒƒãƒ€ã®ã¿å‰Šé™¤ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');"
            style="display:inline;">
        <input type="hidden" name="csrf_token" value="{{ token }}">
        <button class="btn sub" type="submit" title="ç©ºã®æ³¨æ–‡ï¼ˆæ˜ç´°0ä»¶ï¼‰ã®ã¨ãã ã‘å‰Šé™¤ã—ã¾ã™">ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–</button>
      </form>
      {% endif %}
      {# â˜…â˜…â˜… è¿½åŠ ã“ã“ã¾ã§ â˜…â˜…â˜… #}

      <!-- â˜…â˜…â˜… åˆæµPINã®è¡¨ç¤ºæ ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ â˜…â˜…â˜… -->
      <span id="pin-pill" class="pill" style="display:none; gap:6px;">
        åˆæµPINï¼š<strong id="pin-code"></strong>
        <small id="pin-exp" class="muted"></small>
        <button type="button" class="btn sub" id="pin-copy" style="padding:4px 8px">ã‚³ãƒ”ãƒ¼</button>
      </span>
      <!-- â˜…â˜…â˜… è¿½åŠ ã“ã“ã¾ã§ â˜…â˜…â˜… -->
    </div>
  </header>

  <div class="wrap">
    {% if message is defined and message %}
      <div class="message-card">ğŸ”” {{ message }}</div>
    {% endif %}

    <div class="layout">
      <!-- å·¦ï¼šã‚«ãƒ†ã‚´ãƒªï¼‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <div>
        <div class="card">
          <h2>ã‚«ãƒ†ã‚´ãƒª</h2>

          <!-- ã™ã¹ã¦ãƒœã‚¿ãƒ³ï¼ˆä»–ã‚«ãƒ†ã‚´ãƒªã¯æ¶ˆã•ãªã„ï¼‰ -->
          <div id="all-row" class="cat-row" data-depth="-1" style="margin-top:0;padding-top:0;border-top:none">
            <span class="pill category-pill active" data-category-id="0" data-depth="-1">ã™ã¹ã¦</span>
          </div>

          <div id="category-list"></div>

          <!-- â–¼ æ¤œç´¢ãƒãƒ¼ -->
          <div class="search-bar">
            <input id="menu-q" class="search-input" placeholder="ãƒ¡ãƒ‹ãƒ¥ãƒ¼åãƒ»èª¬æ˜ã§æ¤œç´¢">
            <button id="menu-search" class="btn sub" type="button">æ¤œç´¢</button>
            <button id="menu-clear" class="btn sub" type="button">ã‚¯ãƒªã‚¢</button>
          </div>
        </div>

        <h2 style="margin:24px 0 16px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
        <div id="menu-grid" class="grid"></div>
      </div>

      <!-- å³ï¼šæ³¨æ–‡ã‚«ã‚´ï¼ˆãŠå®¢æ§˜è©³ç´°ã‚’å«ã‚€ï¼‰ + ç¾åœ¨ã®æ˜ç´° -->
      <div>
        <div class="card" id="cart-container">
          <h2><span class="cart-title-desktop">æ³¨æ–‡ã‚«ã‚´</span><span class="cart-title-mobile">ãŠå®¢æ§˜è©³ç´°ãƒ»æ³¨æ–‡ã‚«ã‚´</span></h2>
          
          <!-- â–¼ ãŠå®¢æ§˜è©³ç´°ï¼ˆæ³¨æ–‡ã‚«ã‚´å†…ã«ç§»å‹•ï¼‰ -->
          <div id="customer-card" style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border)">
            <div class="row">
              <h3 style="margin:0">ãŠå®¢æ§˜è©³ç´°</h3>
              <div style="display:flex;align-items:center;gap:8px">
                <span id="cust-ok" class="ok-badge" style="display:none">ç™»éŒ²æ¸ˆ</span>
                <button class="btn sub" id="cust-edit" type="button" style="display:none">ç·¨é›†ã™ã‚‹</button>
              </div>
            </div>
            <div class="muted" style="margin-bottom:8px">â€» ç”·å­ãƒ»å¥³å­ã¯<strong>å°å­¦ç”Ÿä»¥ä¸‹</strong></div>
            <div class="cust-grid">
              <div class="cust-field">
                <label>ç”·æ€§ï¼ˆå¤§äººï¼‰</label>
                <input id="cust-men" class="cust-input" type="number" min="0" step="1" value="0" inputmode="numeric">
              </div>
              <div class="cust-field">
                <label>å¥³æ€§ï¼ˆå¤§äººï¼‰</label>
                <input id="cust-women" class="cust-input" type="number" min="0" step="1" value="0" inputmode="numeric">
              </div>
              <div class="cust-field">
                <label>ç”·å­ï¼ˆå°å­¦ç”Ÿä»¥ä¸‹ï¼‰</label>
                <input id="cust-boys" class="cust-input" type="number" min="0" step="1" value="0" inputmode="numeric">
              </div>
              <div class="cust-field">
                <label>å¥³å­ï¼ˆå°å­¦ç”Ÿä»¥ä¸‹ï¼‰</label>
                <input id="cust-girls" class="cust-input" type="number" min="0" step="1" value="0" inputmode="numeric">
              </div>
            </div>
            <button class="btn primary" style="margin-top:12px" id="cust-submit">ãŠå®¢æ§˜è©³ç´°ã‚’é€ä¿¡</button>
            <div class="muted warn" id="cust-msg" style="margin-top:8px"></div>
          </div>
          <table id="cart-table">
            <thead>
              <tr><th>å“ç›®</th><th style="width:90px">æ•°é‡</th><th style="width:130px">å˜ä¾¡</th><th style="width:90px">æ“ä½œ</th></tr>
            </thead>
            <tbody id="cart-body">
              <tr id="empty-row"><td colspan="4" class="muted">ã¾ã ã‚ã‚Šã¾ã›ã‚“</td></tr>
            </tbody>
          </table>

          <div class="totals">
            <div><span>åˆè¨ˆï¼ˆç¨æŠœï¼‰</span><strong id="subtotal-excl">Â¥0</strong></div>
            <div><span>åˆè¨ˆï¼ˆç¨è¾¼ï¼‰</span><strong id="total-incl">Â¥0</strong></div>
          </div>

          <div style="margin-top:10px">
            <label class="muted">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <input id="memo-global" placeholder="ä¾‹ï¼šã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç­‰" style="width:100%;height:36px;border:1px solid var(--border);border-radius:8px;padding:0 8px">
          </div>

          <button class="btn primary" style="margin-top:12px" id="submit-btn">ã“ã®å†…å®¹ã§é€ä¿¡</button>
          <div class="muted" id="submit-msg" style="margin-top:8px;"></div>
          
          <!-- â–¼ åº—å“¡å‘¼ã³å‡ºã—ãƒœã‚¿ãƒ³ï¼ˆãŠå®¢æ§˜ã®ã¿è¡¨ç¤ºï¼‰ -->
          <button class="btn" style="margin-top:12px;background:#f59e0b;color:#fff;width:100%;font-size:16px;font-weight:600;display:none" id="call-staff-btn" type="button">
            ğŸ”” åº—å“¡ã‚’å‘¼ã¶
          </button>
          <div class="muted" id="call-staff-msg" style="margin-top:8px;"></div>
        </div>

        <!-- â–¼ ç¾åœ¨ã®æ˜ç´° -->
        <div class="card" id="current-detail" style="margin-top:16px; display:none">
          <div class="row" style="margin-bottom:6px">
            <h2 style="margin:0">ç¾åœ¨ã®æ˜ç´°</h2>
            <button class="btn sub" id="detail-reload" type="button">æ›´æ–°</button>
          </div>
          <div class="muted" id="detail-header" style="margin-bottom:6px"></div>
          <div class="small muted" id="detail-meta" style="margin-bottom:8px;display:none"></div>
          <table id="detail-table">
            <thead>
              <tr>
                <th>å“å</th>
                <th class="text-right" style="width:70px">æ•°é‡</th>
                <th style="width:160px">å˜ä¾¡</th>
                <th style="width:160px">å°è¨ˆ</th>
                <th style="width:80px">çŠ¶æ…‹</th>
                <th style="width:120px">ãƒ¡ãƒ¢</th>
              </tr>
            </thead>
            <tbody id="detail-body">
              <tr><td colspan="6" class="muted">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
            </tbody>
          </table>
          <details class="debug" id="detail-debug" style="display:none">
            <summary>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</summary>
            <pre class="debug-pre" id="detail-debug-pre"></pre>
          </details>
        </div>
      </div>
    </div>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  // ============== å…±é€šï¼šJSONå°‚ç”¨ãƒ•ã‚§ãƒƒãƒï¼ˆHTMLæ··å…¥é˜²æ­¢ï¼‰ ==============
  async function fetchJSON(url, options = {}) {
    const opts = {
      headers: { 'Accept': 'application/json', ...(options.headers || {}) },
      credentials: 'same-origin',
      redirect: 'follow',
      ...options,
    };
    const res  = await fetch(url, opts);
    const text = await res.text();
    const ct   = res.headers.get('content-type') || '';

    // HTMLãŒè¿”ã£ã¦ããŸï¼æœªãƒ­ã‚°ã‚¤ãƒ³/CSRF/500ãƒšãƒ¼ã‚¸ãªã©
    if (ct.includes('text/html') || /^\s*<!doctype/i.test(text)) {
      if (res.redirected && res.url) {
        location.href = res.url; // ãƒ­ã‚°ã‚¤ãƒ³ãªã©ã«èª˜å°
        return;
      }
      throw new Error(`Non-JSON response (${res.status})`);
    }

    let data;
    try { data = text ? JSON.parse(text) : {}; }
    catch { throw new Error(`JSON parse failed (${res.status})`); }

    if (!res.ok || data?.ok === false) {
      throw new Error(data?.message || data?.error || `HTTP ${res.status}`);
    }
    return data;
  }

  // ===================== â˜…â˜…â˜… åˆæµPIN è¡¨ç¤ºç”¨ â˜…â˜…â˜… =====================
  const pinPill   = document.getElementById('pin-pill');
  const pinCodeEl = document.getElementById('pin-code');
  const pinExpEl  = document.getElementById('pin-exp');
  const pinCopy   = document.getElementById('pin-copy');

  function renderPin(pin, exp) {
    if (!pinPill || !pin) return;
    pinCodeEl.textContent = String(pin).padStart(4, '0');
    pinExpEl.textContent  = exp ? `(æœ‰åŠ¹: ${new Date(exp).toLocaleString('ja-JP')})` : '';
    pinPill.style.display = 'inline-flex';
  }

  pinCopy?.addEventListener('click', () => {
    if (!pinCodeEl?.textContent) return;
    navigator.clipboard?.writeText(pinCodeEl.textContent).then(() => {
      const old = pinCopy.textContent;
      pinCopy.textContent = 'ã‚³ãƒ”ãƒ¼æ¸ˆ';
      setTimeout(() => pinCopy.textContent = old || 'ã‚³ãƒ”ãƒ¼', 1200);
    });
  });
  // ===================== â˜…â˜…â˜… åˆæµPIN ã“ã“ã¾ã§ â˜…â˜…â˜… =====================

  // ===================== åŸºæœ¬å‚ç…§ =====================
  const categoryList = document.getElementById('category-list');
  const menuGrid = document.getElementById('menu-grid');

  // ===== è¨­å®šãƒ•ãƒ©ã‚°ï¼ˆåˆæœŸè¡¨ç¤ºæŒ™å‹•ï¼‰ =====
  const AUTO_SHOW_ALL = true;

  // ===== IDãƒ»ãƒˆãƒ¼ã‚¯ãƒ³å–å¾— =====
  const normId = (v)=>{ const s=(v??'').toString().trim(); if(!s) return null; const bad=['none','null','undefined','nan']; if(bad.includes(s.toLowerCase())) return null; const n=Number(s); return Number.isFinite(n)? n:null; };
  const ds = document.body.dataset;
  let orderId  = normId(ds.orderId);
  let tableId  = normId(ds.tableId) ?? normId(ds.orderTableId);
  const qs = new URLSearchParams(location.search);
  if (orderId == null) orderId = normId(qs.get('order_id'));
  if (tableId == null) tableId = normId(qs.get('table_id'));

  const urlToken  = qs.get('token');
  const pathToken = ((location.pathname.match(/\/m\/([^\/]+)/)||[])[1]) || null;
  const token     = urlToken || pathToken || null;
  // ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã¯å¸¸ã«ãƒ‘ãƒ–ãƒªãƒƒã‚¯APIã‚’ä½¿ç”¨ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšï¼‰
  const IS_PUBLIC = !!token;

  // ãƒ‡ãƒãƒƒã‚°
  const DEBUG = ['1','true','yes','on'].includes((qs.get('debug')||'').toLowerCase());
  const dbg = (...a)=>{ if (DEBUG) console.log('[DETAIL]', ...a); };

  // è¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·
  const tableLabel = document.getElementById('table-label');
  const tableNoInit = (ds.tableNo || qs.get('table_no') || '').trim();
  tableLabel.textContent = tableNoInit ? tableNoInit : (tableId != null ? String(tableId) : '-');
  if (!tableNoInit && tableId != null) {
    fetchJSON(`/api/tables/${tableId}/label`)
      .then(j => { if (j && j.ok && j.table_no && String(j.table_no).trim()) tableLabel.textContent = String(j.table_no).trim(); })
      .catch(()=>{});
  }

  // ===== ä¾¡æ ¼ utils =====
  const priceFmt=v=>(Number.isFinite(Number(v))? Number(v).toLocaleString('ja-JP'): v);
  const toRate=val=>{ const n=Number(val); if(!Number.isFinite(n))return .10; if(n<0)return 0; if(n>1)return Math.min(n/100,1); return n; };
  const inclFromExcl=(excl,rate)=> excl + Math.floor(excl*rate + 1e-9);
  const exclFromIncl=(incl,rate)=>{ let e=Math.floor(incl/(1+rate)+1e-9),i2=inclFromExcl(e,rate); while(i2<incl){e++;i2=inclFromExcl(e,rate);} while(i2>incl&&e>0){e--;i2=inclFromExcl(e,rate);} return e; };
  const computePrices=(menu)=>{ const rate=toRate(menu.rate); let excl=Number(menu.price_excl), incl=Number(menu.price_incl);
    if(!Number.isFinite(excl)||excl<=0){ if(Number.isFinite(incl)&&incl>0) excl=exclFromIncl(incl,rate); else if(Number.isFinite(Number(menu.price))&&Number(menu.price)>0){ incl=Number(menu.price); excl=exclFromIncl(incl,rate);} else excl=0; }
    if(!Number.isFinite(incl)||incl<=0) incl=inclFromExcl(excl,rate);
    return {rate,excl,incl}; };
  const yen = n => 'Â¥' + Number(n||0).toLocaleString('ja-JP');

  // ===== ç¾åœ¨ã®æ˜ç´° =====
  const detailCard=document.getElementById('current-detail');
  const detailHeader=document.getElementById('detail-header');
  const detailMeta=document.getElementById('detail-meta');
  const detailBody=document.getElementById('detail-body');
  const debugBox=document.getElementById('detail-debug');
  const debugPre=document.getElementById('detail-debug-pre');
  const showDebug=(obj)=>{ if(!DEBUG) return; debugBox.style.display='block'; try{ debugPre.textContent=(typeof obj==='string')? obj: JSON.stringify(obj,null,2);}catch(e){ debugPre.textContent=String(obj);} };

  function normalizeItem(it){
    const name=it.name ?? it['åç§°'] ?? '';
    const qty=Number(it.qty ?? it['æ•°é‡'] ?? 0) || 0;
    const uIncl=Number(it.unit_incl ?? it['ç¨è¾¼å˜ä¾¡'] ?? it['ç¨è¾¼'] ?? it['å˜ä¾¡ç¨è¾¼'] ?? 0) || 0;
    const uExcl=Number(it.unit_excl ?? it['ç¨æŠœå˜ä¾¡'] ?? it['ç¨æŠœ'] ?? it['å˜ä¾¡ç¨æŠœ'] ?? 0) || 0;
    const sIncl=Number(it.sub_incl ?? it['ç¨è¾¼å°è¨ˆ'] ?? 0) || (uIncl*qty);
    const sExcl=Number(it.sub_excl ?? it['ç¨æŠœå°è¨ˆ'] ?? 0) || (uExcl*qty);
    const status=(it.status ?? it['çŠ¶æ…‹'] ?? '').toString();
    const memo=it.memo ?? it['ãƒ¡ãƒ¢'] ?? '';
    return {name, qty, unit_incl:uIncl, unit_excl:uExcl, sub_incl:sIncl, sub_excl:sExcl, status, memo};
  }
  const isCancelStatus=s=>{ const ss=(s||'').toLowerCase(); return ss.includes('å–æ¶ˆ')||ss.includes('ï½·ï½¬ï¾ï½¾ï¾™')||ss.includes('cancel')||ss.includes('void'); };

  async function loadCurrentDetail(){
    if (orderId == null){ detailCard.style.display='none'; return; }
    detailCard.style.display='block';
    detailBody.innerHTML='<tr><td colspan="6" class="muted">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
    const apiUrl = IS_PUBLIC ? `/public/order/${orderId}/detail/json?token=${encodeURIComponent(token)}` : `/admin/order/${orderId}/detail/json`;
    detailMeta.style.display = DEBUG ? 'block':'none';
    if (DEBUG) detailMeta.textContent = `mode=${IS_PUBLIC?'public':'admin'} / orderId=${orderId} / tableId=${tableId??'-'} / API=${apiUrl}`;
    try{
      const j = await fetchJSON(apiUrl);
      const tableNoFromJson = (j.table_no) || (j.order && (j.order.table_no || j.order.tableNo)) || (j.table && (j.table.table_no || j.table.tableNo));
      if (tableNoFromJson && String(tableNoFromJson).trim()) tableLabel.textContent = String(tableNoFromJson).trim();

      const od=j.order||{};
      // â˜…â˜…â˜… è¿½åŠ ï¼šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«PINãŒã‚ã‚Œã°è¡¨ç¤º â˜…â˜…â˜…
      renderPin(od.join_pin ?? od['åˆæµPIN'], od.join_pin_expires_at ?? od['PINæœ‰åŠ¹æœŸé™']);

      const items=(j.items||[]).map(normalizeItem);
      let totalIncl=Number(od.total_incl ?? od.total ?? NaN);
      if(!Number.isFinite(totalIncl)) totalIncl=items.filter(x=>!isCancelStatus(x.status)).reduce((a,x)=>a+Number(x.sub_incl||0),0);
      const openedRaw=od.opened_at ?? od.opened; const opened=openedRaw? new Date(openedRaw).toLocaleString('ja-JP'):'-';
      detailHeader.innerHTML=`åˆè¨ˆ: <strong>${yen(totalIncl)}</strong> ï¼ é–‹å§‹: <strong>${opened}</strong>`;
      if(!items.length){ detailBody.innerHTML='<tr><td colspan="6" class="muted">ã“ã®æ³¨æ–‡ã«æ˜ç´°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>'; return; }
      detailBody.innerHTML='';
      items.forEach(it=>{
        const tr=document.createElement('tr'); if(isCancelStatus(it.status)) tr.classList.add('muted-row');
        const memo = it.memo || it.ãƒ¡ãƒ¢ || '';
        const memoHtml = memo ? `<span class="small muted">${memo}</span>` : '';
        tr.innerHTML=`<td>${it.name}</td><td class="text-right">${it.qty}</td><td><div>ç¨è¾¼ ${yen(it.unit_incl)}</div><div class="small muted">ç¨æŠœ ${yen(it.unit_excl)}</div></td><td><div>ç¨è¾¼ ${yen(it.sub_incl)}</div><div class="small muted">ç¨æŠœ ${yen(it.sub_excl)}</div></td><td>${it.status}</td><td>${memoHtml}</td>`;
        detailBody.appendChild(tr);
      });

      // â˜…â˜…â˜… ä»»æ„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šPINæœªå–å¾—æ™‚ã¯ /pin ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§è£œå®Œ â˜…â˜…â˜…
      if (!od.join_pin && orderId != null) {
        try {
          const url = IS_PUBLIC
            ? `/public/order/${orderId}/pin?token=${encodeURIComponent(token)}`
            : `/admin/order/${orderId}/pin`;
          const pj = await fetchJSON(url);
          if (pj?.pin) renderPin(pj.pin, pj.expires_at);
        } catch (e) { /* ç„¡è¦– */ }
      }
      // â˜…â˜…â˜… è¿½åŠ ã“ã“ã¾ã§ â˜…â˜…â˜…

    }catch(e){
      detailBody.innerHTML='<tr><td colspan="6" class="muted">æ˜ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td></tr>';
    }
  }
  document.getElementById('detail-reload')?.addEventListener('click', loadCurrentDetail);

  // ===== ã‚«ã‚´ =====
  const cart=[];
  function upsertCartItem(menu, qtyDelta=1){
    const {rate,excl,incl}=computePrices(menu);
    const idx=cart.findIndex(x=>x.menu_id===menu.id && !x.memo);
    if(idx>=0){ cart[idx].qty += qtyDelta; if(cart[idx].qty<1) cart[idx].qty=1; }
    else { cart.push({menu_id:menu.id,name:menu.name,qty:qtyDelta,rate,price_excl:excl,price_incl:incl}); }
    renderCart();
  }
  function renderCart(){
    const body=document.getElementById('cart-body'); if(!body) return;
    body.innerHTML='';
    if(!cart.length){ body.innerHTML=`<tr id="empty-row"><td colspan="4" class="muted">ã¾ã ã‚ã‚Šã¾ã›ã‚“</td></tr>`; updateTotals(); return; }
    cart.forEach((it,i)=>{ 
      const tr=document.createElement('tr');
      const memoHtml = it.memo ? `<div class="small muted" style="white-space:pre-wrap; margin-top:4px;">${it.memo}</div>` : '';
      tr.innerHTML=`<td>${it.name}${memoHtml}</td><td><input class="qty-input" type="number" min="1" step="1" value="${it.qty}" onchange="window.__chgQty(${i}, this.value)"></td><td><div>ç¨è¾¼ Â¥${priceFmt(it.price_incl)}</div><div class="muted" style="font-size:12px">ç¨æŠœ Â¥${priceFmt(it.price_excl)}</div></td><td><button class="btn sub" onclick="window.__rm(${i})">å‰Šé™¤</button></td>`;
      body.appendChild(tr); 
    }); 
    updateTotals();
  }
  function updateTotals(){ const subtotalExcl=cart.reduce((s,it)=>s+it.price_excl*it.qty,0); const totalIncl=cart.reduce((s,it)=>s+it.price_incl*it.qty,0);
    document.getElementById('subtotal-excl').textContent='Â¥'+priceFmt(subtotalExcl);
    document.getElementById('total-incl').textContent='Â¥'+priceFmt(totalIncl); }
  window.__chgQty=(i,v)=>{ cart[i].qty=Math.max(1,parseInt(v||'1',10)); renderCart(); };
  window.__rm=(i)=>{ cart.splice(i,1); renderCart(); };
  
  // windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç™»éŒ²ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‹ã‚‰ä½¿ç”¨ã™ã‚‹ãŸã‚ï¼‰
  window.__cart = cart;
  window.__computePrices = computePrices;
  window.__renderCart = renderCart;
  window.__upsertCartItem = upsertCartItem;

  // ===== ã‚«ãƒ†ã‚´ãƒª UI =====
  const categoryTree={{ category_tree | tojson | safe }};
  const qrToken="{{ qr_token or '' }}";
  const hasChildrenOf=id=>Array.isArray(categoryTree[String(id)]) && categoryTree[String(id)].length>0;

  const clearActiveFromDepth=(depth)=>{
    document.querySelectorAll('.category-pill').forEach(p=>{
      const d=Number(p.dataset.depth || 0);
      if (d >= depth) p.classList.remove('active');
    });
  };
  const removeRowsFromDepth=(depth)=>{
    [...categoryList?.querySelectorAll('.cat-row')||[]].forEach(row=>{
      const d=Number(row.dataset.depth || 0);
      if(d >= depth) row.remove();
    });
  };
  function renderRow(parentId, depth){
    if (!categoryList) return;
    removeRowsFromDepth(depth);
    const cats=categoryTree[String(parentId)] || [];
    if(!cats.length) return;
    const row=document.createElement('div'); row.className='cat-row'; row.dataset.depth=depth;
    cats.forEach(c=>{
      const pill=document.createElement('span');
      pill.className='pill category-pill'; if(hasChildrenOf(c.id)) pill.classList.add('parent-category');
      pill.dataset.categoryId=c.id; pill.dataset.depth=depth; pill.textContent=c.name;
      row.appendChild(pill);
    });
    categoryList.appendChild(row);
  }

  // â–¼ è¿½åŠ ï¼šã‚«ãƒ†ã‚´ãƒªé †ï¼ˆãƒ„ãƒªãƒ¼é †ï¼‰ã«â€œè‘‰ã‚«ãƒ†ã‚´ãƒªIDâ€ã‚’å¹³å¦åŒ–
  function getOrderedLeafCategoryIds(){
    const out=[];
    const walk=(pid)=>{
      const children = categoryTree[String(pid)] || [];
      if (!children.length) return;
      for (const c of children){
        if (hasChildrenOf(c.id)) walk(c.id); // å­ãŒã‚ã‚Œã°æ½œã‚‹
        else out.push(c.id);                 // è‘‰ã®ã¿åé›†
      }
    };
    walk('root');
    return out;
  }

  // â–¼ è¿½åŠ ï¼šæŒ‡å®šã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªä»¥ä¸‹ã®â€œè‘‰ã‚«ãƒ†ã‚´ãƒªIDâ€ã‚’åé›†
  function getDescendantLeafIds(parentId){
    const out = [];
    const walk = (cid) => {
      const children = categoryTree[String(cid)] || [];
      if (!children.length){ out.push(cid); return; }
      for (const c of children){
        if (hasChildrenOf(c.id)) walk(c.id);
        else out.push(c.id);
      }
    };
    walk(parentId);
    return out;
  }

  // â–¼ è¦ªã‚«ãƒ†ã‚´ãƒªé…ä¸‹ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼çµ±åˆï¼ˆå…¬é–‹ã§ã‚‚éè¡¨ç¤ºã«ã—ãªã„ï¼‰
  async function loadMenusForParent(parentId){
    if (!menuGrid) return;
    const leafIds = [parentId, ...getDescendantLeafIds(parentId)];
    if (!leafIds.length) return;
    menuGrid.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
    const seen = new Set();
       const merged = [];
    for (const cid of leafIds){
      try{
        const data = await fetchJSON(`/api/menus/by_category/${cid}${qrToken ? '?token=' + qrToken : ''}`);
        const arr = Array.isArray(data?.menus) ? data.menus : [];
        for (const m of arr){
          if (seen.has(m.id)) continue;
          seen.add(m.id);
          merged.push(m); // available=0 ã‚‚å«ã‚ã¦æ¸¡ã™
        }
      }catch(e){
        console.warn('load category failed', cid, e);
      }
    }
    if (!merged.length){
      menuGrid.innerHTML = '<div class="card">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
      return;
    }
    renderMenus(merged);
  }

  // â–¼ ã€Œã™ã¹ã¦ã€è¡¨ç¤ºï¼ˆå…¬é–‹ã§ã‚‚éè¡¨ç¤ºã«ã—ãªã„ï¼‰
  async function loadAllMenusByCategoryOrder(){
    if (!menuGrid) return;
    menuGrid.innerHTML='<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';

    const leafIds = getOrderedLeafCategoryIds();
    const seen = new Set();
    const merged = [];

    for (const cid of leafIds){
      try{
        const data = await fetchJSON(`/api/menus/by_category/${cid}${qrToken ? '?token=' + qrToken : ''}`);
        const arr = Array.isArray(data?.menus) ? data.menus : [];
        for (const m of arr){
          if (seen.has(m.id)) continue;
          seen.add(m.id);
          merged.push(m); // available=0 ã‚‚å«ã‚ã¦æ¸¡ã™
        }
      }catch(e){
        console.warn('load category failed', cid, e);
      }
    }

    if (!merged.length){
      menuGrid.innerHTML='<div class="card">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
      return;
    }
    renderMenus(merged);
  }

  // â€œã™ã¹ã¦â€ã®pillã¯æ®‹ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã¯ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§å‡¦ç†
  document.addEventListener('click', (ev)=>{
    const pill=ev.target.closest('.category-pill'); if(!pill) return;
    const categoryId=pill.dataset.categoryId; const depth=Number(pill.dataset.depth || 0);

    clearActiveFromDepth(-1);
    pill.classList.add('active');

    if(categoryId === '0'){
      if(categoryList && !categoryList.querySelector('.cat-row[data-depth="0"]')){
        renderRow('root', 0);
      }
      if (AUTO_SHOW_ALL) loadAllMenusByCategoryOrder();
      else menuGrid && (menuGrid.innerHTML='<div class="card">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>');
      return;
    }

    if(hasChildrenOf(categoryId)){
      renderRow(categoryId, depth+1);
      loadMenusForParent(categoryId);
    }else{
      removeRowsFromDepth(depth+1);
      loadMenus(categoryId);
    }
  });

  // ===== ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—ï¼ˆAbortController + fetchJSONï¼‰ =====
  let menusAbortCtrl = null;
  const __menuMap = new Map();
  window.__menuMap = __menuMap;  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š

  async function loadMenus(categoryId){
    if (!menuGrid) return;

    // ã€Œã™ã¹ã¦ã€ã¯å°‚ç”¨ãƒ­ã‚¸ãƒƒã‚¯
    if (String(categoryId) === '0'){
      return loadAllMenusByCategoryOrder();
    }

    if (menusAbortCtrl) menusAbortCtrl.abort();
    menusAbortCtrl = new AbortController();
    const { signal } = menusAbortCtrl;

    menuGrid.innerHTML='<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
    try{
      const data = await fetchJSON(`/api/menus/by_category/${categoryId}${qrToken ? '?token=' + qrToken : ''}`, { signal });
      if (signal.aborted) return;
      const list = (data?.menus || []); // available=0 ã‚‚å«ã‚ã¦æ¸¡ã™
      list.length ? renderMenus(list)
                  : (menuGrid.innerHTML='<div class="card">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>');
    }catch(e){
      if (signal.aborted) return;
      console.error(e);
      menuGrid.innerHTML='<div class="loading">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div>';
    }
  }

  // è¿½åŠ ãƒœã‚¿ãƒ³ã¯ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  menuGrid?.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-role="add"]');
    if(!btn || btn.disabled) return;
    const id = Number(btn.dataset.id);
    const menu = __menuMap.get(id);
    if(menu) await openOptionModal(menu);
  });

  function renderMenus(menus){
    if (!menuGrid) return;

    // ã“ã“ã§ã¯ available ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã—ãªã„ã€‚åœæ­¢ã¯ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼†è¿½åŠ ä¸å¯ã«ã™ã‚‹
    menus = (menus || []);

    __menuMap.clear();
    menuGrid.innerHTML='';
    if(!menus || !menus.length){ menuGrid.innerHTML='<div class="card">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return; }
    menus.forEach(menu=>{
      const card=document.createElement('div'); card.classList.add('card');
      const imgHtml = menu.photo_url ? `<img src="${menu.photo_url}" alt="" loading="lazy">` : '';
      const {excl,incl}=computePrices(menu);

      card.innerHTML=`
        ${imgHtml}
        <h3 style="margin:6px 0 4px"></h3>
        <div class="muted"></div>
        <div class="row" style="margin-top:16px;">
          <div class="price-box">
            <div class="price-incl"></div>
            <div class="price-excl"></div>
          </div>
          <div><button class="btn primary" data-role="add" data-id="${menu.id}">è¿½åŠ </button></div>
        </div>`;

      const titleEl = card.querySelector('h3');
      titleEl.textContent = menu.name || '';
      card.querySelector('.muted').textContent = menu.description || '';
      
      // æ™‚ä¾¡å•†å“ã®å ´åˆã¯ã€Œæ™‚ä¾¡ã€ã¨è¡¨ç¤º
      if (menu.is_market_price) {
        card.querySelector('.price-incl').innerHTML = `<strong style="color:#e11d48">æ™‚ä¾¡</strong>`;
        card.querySelector('.price-excl').innerHTML = `<small class="muted">ä¾¡æ ¼ã¯ä¼šè¨ˆæ™‚ã«ç¢ºå®š</small>`;
      } else {
        card.querySelector('.price-incl').innerHTML = `Â¥${priceFmt(incl)} <small class="muted">(ç¨è¾¼)</small>`;
        card.querySelector('.price-excl').innerHTML = `<small class="muted">ç¨æŠœ</small> Â¥${priceFmt(excl)}`;
      }

      // â–¼ æä¾›åœæ­¢ã®è¦‹ãŸç›®ã¨ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
      const stopped = Number(menu.available||0) !== 1;
      if (stopped){
        card.classList.add('stopped');
        const badge = document.createElement('span');
        badge.className = 'badge-stopped';
        badge.textContent = 'æä¾›åœæ­¢ä¸­';
        titleEl.appendChild(badge);
        const addBtn = card.querySelector('button[data-role="add"]');
        if (addBtn){
          addBtn.disabled = true;
          addBtn.classList.remove('primary');
          addBtn.classList.add('sub');
          addBtn.textContent = 'åœæ­¢ä¸­';
        }
      }

      __menuMap.set(menu.id, menu);
      menuGrid.appendChild(card);
    });
  }

  // ===== æ¤œç´¢ =====
  const inputQ=document.getElementById('menu-q');
  const btnSearch=document.getElementById('menu-search');
  const btnClear=document.getElementById('menu-clear');

  btnSearch?.addEventListener('click', ()=> doSearch());
  btnClear?.addEventListener('click', ()=>{
    if (inputQ) inputQ.value='';
    const active=document.querySelector('.category-pill.active');
    const cid=active ? active.dataset.categoryId : (AUTO_SHOW_ALL ? '0' : null);
    if (cid) loadMenus(cid);
    else menuGrid && (menuGrid.innerHTML='<div class="card">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>');
    inputQ?.focus();
  });
  inputQ?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ doSearch(); }});

  function kanaFold(s){
    if(!s) return '';
    let t = s.normalize('NFKC').toLowerCase();
    let out = '';
    for (const ch of t){
      const code = ch.charCodeAt(0);
      if (code >= 0x3041 && code <= 0x3096){ out += String.fromCharCode(code + 0x60); }
      else if (code === 0x309D){ out += String.fromCharCode(0x30FD); }
      else if (code === 0x309E){ out += String.fromCharCode(0x30FE); }
      else { out += ch; }
    }
    return out.replace(/\s+/g,'');
  }

  async function doSearch(){
    const q=(inputQ && inputQ.value || '').trim();
    if(!q){
      const active=document.querySelector('.category-pill.active');
      const cid=active ? active.dataset.categoryId : (AUTO_SHOW_ALL ? '0' : null);
      if (cid) loadMenus(cid);
      else menuGrid && (menuGrid.innerHTML='<div class="card">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>');
      return;
    }
    if (!menuGrid) return;
    menuGrid.innerHTML='<div class="loading">æ¤œç´¢ä¸­...</div>';

    try{
      const j = await fetchJSON(`/api/menus/by_category/0${qrToken ? '?token=' + qrToken : ''}`);
      const kw=kanaFold(q);
      const filtered=(j.menus||[]) // available=0 ã‚‚å«ã‚ã‚‹ï¼ˆè¦‹ãŸç›®ã¯ renderMenus ã§åˆ¶å¾¡ï¼‰
        .filter(m=>{
          const nameF=kanaFold(m.name||'');
          const descF=kanaFold(m.description||'');
          return nameF.includes(kw)||descF.includes(kw);
        });
      renderMenus(filtered);
    }catch(e){
      console.error(e);
      menuGrid.innerHTML='<div class="loading">æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
    }
  }

  // ===== ãŠå®¢æ§˜è©³ç´° =====
  let customerDetailOK=false, customerDetailId=null;
  const okBadge=document.getElementById('cust-ok');
  const btnEdit=document.getElementById('cust-edit');
  const btnSubmit=document.getElementById('cust-submit');
  const msgCust=document.getElementById('cust-msg');
  const inputMen=document.getElementById('cust-men');
  const inputWomen=document.getElementById('cust-women');
  const inputBoys=document.getElementById('cust-boys');
  const inputGirls=document.getElementById('cust-girls');

  function setCustLocked(locked){
    [inputMen,inputWomen,inputBoys,inputGirls].forEach(el=> el && (el.disabled=locked));
    okBadge && (okBadge.style.display = locked ? 'inline-block':'none');
    btnEdit && (btnEdit.style.display  = (locked && customerDetailOK) ? 'inline-flex':'none');
    if (btnSubmit) btnSubmit.textContent  = locked ? 'ãŠå®¢æ§˜è©³ç´°ã‚’é€ä¿¡' : (customerDetailOK ? 'å¤‰æ›´ã‚’ä¿å­˜' : 'ãŠå®¢æ§˜è©³ç´°ã‚’é€ä¿¡');
  }

  async function fetchCustStatus(){
    const params=new URLSearchParams();
    if (IS_PUBLIC && token) params.set('token', token);
    if (!IS_PUBLIC){
      if (orderId != null) params.set('order_id', String(orderId));
      if (tableId != null) params.set('table_id', String(tableId));
    }
    try{
      const j = await fetchJSON(`/api/customer_detail/status?`+params.toString());
      if(!j.ok) return;

      if(j.exists){
        customerDetailOK=true; customerDetailId=j.detail?.id ?? null;
        if(j.detail){
          if (inputMen)   inputMen.value   = j.detail.å¤§äººç”·æ€§ ?? 0;
          if (inputWomen) inputWomen.value = j.detail.å¤§äººå¥³æ€§ ?? 0;
          if (inputBoys)  inputBoys.value  = j.detail.å­ã©ã‚‚ç”· ?? 0;
          if (inputGirls) inputGirls.value = j.detail.å­ã©ã‚‚å¥³ ?? 0;
        }
        msgCust.textContent='ãŠå®¢æ§˜è©³ç´°ã¯ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚ç·¨é›†ã™ã‚‹å ´åˆã¯ã€Œç·¨é›†ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        setCustLocked(true);
      }else{
        customerDetailOK=false; customerDetailId=null;
        msgCust.textContent='â€» ãŠå®¢æ§˜è©³ç´°ã®ç™»éŒ²ãŒå®Œäº†ã™ã‚‹ã¾ã§æ³¨æ–‡ã¯é€ä¿¡ã§ãã¾ã›ã‚“ã€‚';
        setCustLocked(false);
      }
    }catch(e){ /* ç„¡è¦– */ }
  }
  btnEdit?.addEventListener('click', ()=>{ setCustLocked(false); msgCust.textContent='äººæ•°ã‚’ç·¨é›†ã—ã¦ã€Œå¤‰æ›´ã‚’ä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'; });

  btnSubmit?.addEventListener('click', async ()=>{
    const men=Math.max(0, parseInt(inputMen?.value||'0',10)||0);
    const women=Math.max(0, parseInt(inputWomen?.value||'0',10)||0);
    const boys=Math.max(0, parseInt(inputBoys?.value||'0',10)||0);
    const girls=Math.max(0, parseInt(inputGirls?.value||'0',10)||0);

    const payload={men,women,boys,girls};
    let method= customerDetailOK ? 'PUT' : 'POST';
    if(IS_PUBLIC){
      if(!token){ msgCust.textContent='token ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚'; return; }
      payload.token=token;
    }else{
      if(tableId==null && orderId==null){ msgCust.textContent='table_id ã¾ãŸã¯ order_id ãŒå¿…è¦ã§ã™ã€‚'; return; }
      if(tableId!=null) payload.table_id=tableId;
      if(orderId!=null) payload.order_id=orderId;
    }

    if (btnSubmit.disabled) return;
    const old = btnSubmit.textContent;
    btnSubmit.disabled = true; btnSubmit.textContent = (method==='POST'?'é€ä¿¡ä¸­...':'æ›´æ–°ä¸­...');

    try{
      const j = await fetchJSON('/api/customer_detail',{
        method,
        headers:{
          'Content-Type':'application/json',
          'X-CSRF-Token': getCSRF(),
        },
        body: JSON.stringify(payload)
      });
      customerDetailOK=true; customerDetailId=j.id ?? customerDetailId;
      setCustLocked(true);
      msgCust.textContent=(method==='POST')?'ãŠå®¢æ§˜è©³ç´°ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚':'ãŠå®¢æ§˜è©³ç´°ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚';
    }catch(e){ msgCust.textContent='é€šä¿¡ã‚¨ãƒ©ãƒ¼: '+e.message; }
    finally{
      btnSubmit.disabled = false; btnSubmit.textContent = old;
    }
  });

  // ===== æ³¨æ–‡é€ä¿¡ =====
  function getCSRF(){
    const m=document.querySelector('meta[name="csrf-token"]');
    return m?.content || '';
  }
  let submitting = false;
  async function submitOrder(){
    const msgEl=document.getElementById('submit-msg');
    const btn = document.getElementById('submit-btn');
    if(!customerDetailOK){ msgEl.textContent='ãŠå®¢æ§˜è©³ç´°ã‚’å…ˆã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚'; document.getElementById('customer-card')?.scrollIntoView({behavior:'smooth', block:'center'}); return; }
    if(!cart.length){ msgEl.textContent='ã‚«ã‚´ãŒç©ºã§ã™ã€‚'; return; }
    if (submitting) return;

    const items=cart.map(x=>{
      const item = {menu_id:x.menu_id, qty:x.qty, memo:x.memo||''};
      // æ™‚ä¾¡å•†å“ã®å ´åˆã¯ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹
      if (x.actual_price !== undefined && x.actual_price !== null) {
        item.actual_price = x.actual_price;
        item.price_mode = x.price_mode || 'excl';
      }
      return item;
    });
    const memo=(document.getElementById('memo-global')?.value||'').trim();

    let endpoint=''; let payload={};
    if(IS_PUBLIC){
      if(!token){ msgEl.textContent='token ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚'; return; }
      endpoint='/api/order'; payload={ token, items, memo };
    }else{
      if(tableId==null){ msgEl.textContent='table_id ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚URL ã« ?table_id= ã¾ãŸã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŸ‹ã‚è¾¼ã¿ãŒå¿…è¦ã§ã™ã€‚'; return; }
      endpoint='/admin/api/order';
      payload={ items, memo, table_id:tableId }; if(orderId!=null) payload.order_id=orderId;
    }

    submitting = true;
    const old = btn.textContent;
    btn.disabled = true; btn.textContent = 'é€ä¿¡ä¸­...';

    try{
      const data = await fetchJSON(endpoint,{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'X-CSRF-Token': getCSRF(),
        },
        body: JSON.stringify(payload)
      });
      msgEl.textContent='é€ä¿¡ã—ã¾ã—ãŸï¼ˆæ³¨æ–‡ç•ªå·: '+(data.order_id||'-')+'ï¼‰';
      if(orderId==null && data.order_id){ orderId=Number(data.order_id) || data.order_id; document.body.dataset.orderId=String(orderId); }
      cart.splice(0); renderCart(); loadCurrentDetail();
    }catch(e){ 
      if(e.message && (e.message.includes('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯çµ‚äº†') || e.message.includes('session closed'))){
        alert('ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
        location.reload();
      }else{
        msgEl.textContent='é€šä¿¡ã‚¨ãƒ©ãƒ¼: '+e.message;
      }
    }
    finally{
      submitting = false;
      btn.disabled = false; btn.textContent = old;
    }
  }
  document.getElementById('submit-btn')?.addEventListener('click', submitOrder);

  // ===== åº—å“¡å‘¼ã³å‡ºã— =====
  const callStaffBtn = document.getElementById('call-staff-btn');
  const callStaffMsg = document.getElementById('call-staff-msg');
  let callingStaff = false;
  
  async function callStaff() {
    if (callingStaff) return;
    callingStaff = true;
    callStaffMsg.textContent = '';
    
    const oldText = callStaffBtn.textContent;
    callStaffBtn.disabled = true;
    callStaffBtn.textContent = 'å‘¼ã³å‡ºã—ä¸­...';
    
    try {
      // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã‚’å–å¾—ï¼ˆbodyã®dataå±æ€§ã¾ãŸã¯ç”»é¢è¡¨ç¤ºã‹ã‚‰ï¼‰
      const tableNoFromData = document.body.dataset.tableNo || '';
      const tableNoFromLabel = document.getElementById('table-label')?.textContent || '';
      const finalTableNo = tableNoFromData || tableNoFromLabel || 'ä¸æ˜';
      
      const payload = {
        token: token || '',
        table_no: finalTableNo
      };
      
      const res = await fetch('/api/staff_call', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      const data = await res.json();
      
      if (data && data.ok) {
        callStaffMsg.textContent = 'åº—å“¡ã‚’å‘¼ã³å‡ºã—ã¾ã—ãŸã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚';
        callStaffMsg.style.color = '#059669';
      } else {
        callStaffMsg.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        callStaffMsg.style.color = '#dc2626';
      }
    } catch (e) {
      callStaffMsg.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e;
      callStaffMsg.style.color = '#dc2626';
    } finally {
      callStaffBtn.disabled = false;
      callStaffBtn.textContent = oldText;
      callingStaff = false;
    }
  }
  
  // ãŠå®¢æ§˜ï¼ˆå…¬é–‹URLï¼‰ã‹ã¤ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³ã§ã¯ãªã„å ´åˆã®ã¿åº—å“¡å‘¼ã³å‡ºã—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  const userRole = ds.userRole || '';
  const isStaff = ['staff','store_staff','store_admin','tenant_admin','sysadmin','admin','manager'].includes(userRole);
  console.log('[callStaffBtn] IS_PUBLIC:', IS_PUBLIC, 'userRole:', userRole, 'isStaff:', isStaff);
  if (IS_PUBLIC && !isStaff && callStaffBtn) {
    console.log('[callStaffBtn] ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã™');
    callStaffBtn.style.display = 'block';
    callStaffBtn.addEventListener('click', callStaff);
  } else {
    console.log('[callStaffBtn] ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã™ï¼ˆIS_PUBLIC:', IS_PUBLIC, ', isStaff:', isStaff, 'ï¼‰');
  }

  // ===== åˆæœŸåŒ– =====
  if (categoryList && menuGrid) {
    renderRow('root', 0);
    if (AUTO_SHOW_ALL) loadAllMenusByCategoryOrder();
    else menuGrid.innerHTML = '<div class="card">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>';
  }
  fetchCustStatus();
  loadCurrentDetail();
  
  // ===== ã‚¹ãƒãƒ›è¡¨ç¤ºï¼šæ³¨æ–‡ã‚«ã‚´ã®æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½ =====
  if (window.innerWidth <= 900) {
    const cartContainer = document.getElementById('cart-container');
    const cartHeader = cartContainer?.querySelector('h2');
    if (cartHeader) {
      cartHeader.addEventListener('click', () => {
        cartContainer.classList.toggle('collapsed');
      });
      cartContainer.classList.add('collapsed');
    }
  }
});

// ===== å•†å“ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠæ©Ÿèƒ½ =====
let currentMenuForOptions = null;
let selectedOptions = {};

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
async function fetchMenuOptions(menuId) {
  try {
    const response = await fetch(`/api/menu/${menuId}/options`);
    if (!response.ok) {
      console.error('ã‚ªãƒ—ã‚·ãƒ§ãƒ³å–å¾—å¤±æ•—:', response.status);
      return [];
    }
    const data = await response.json();
    if (data && data.ok && Array.isArray(data.options)) {
      return data.options;
    }
    return [];
  } catch (e) {
    console.error('ã‚ªãƒ—ã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
    return [];
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
async function openOptionModal(menu) {
  currentMenuForOptions = menu;
  selectedOptions = {};
  
  // æ™‚ä¾¡å•†å“ã®å ´åˆã¯ä¾¡æ ¼å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  if (menu.is_market_price) {
    openMarketPriceModal(menu);
    return;
  }
  
  const options = await fetchMenuOptions(menu.id);
  if (!options || options.length === 0) {
    if (window.__upsertCartItem) {
      window.__upsertCartItem(menu, 1);
    }
    return;
  }
  
  const modal = document.getElementById('option-modal');
  const title = document.getElementById('option-modal-title');
  const content = document.getElementById('option-modal-content');
  
  title.textContent = `${menu.name} - ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠ`;
  content.innerHTML = '';
  
  options.forEach(opt => {
    const optDiv = document.createElement('div');
    optDiv.style.marginBottom = '20px';
    
    const optTitle = document.createElement('h3');
    optTitle.textContent = (opt.option_name || opt.name || 'ã‚ªãƒ—ã‚·ãƒ§ãƒ³') + (opt.required ? ' *' : '');
    optTitle.style.fontSize = '16px';
    optTitle.style.marginBottom = '8px';
    optDiv.appendChild(optTitle);
    
    const choices = Array.isArray(opt.choices) ? opt.choices : [];
    if (choices.length === 0) {
      const noChoiceDiv = document.createElement('div');
      noChoiceDiv.textContent = 'é¸æŠè‚¢ãŒã‚ã‚Šã¾ã›ã‚“';
      noChoiceDiv.style.color = '#999';
      optDiv.appendChild(noChoiceDiv);
    } else {
      choices.forEach(choice => {
        const choiceDiv = document.createElement('div');
        choiceDiv.style.marginBottom = '8px';
        
        const inputType = opt.multiple ? 'checkbox' : 'radio';
        const inputName = `option_${opt.id}`;
        const inputId = `choice_${choice.id}`;
        
        const input = document.createElement('input');
        input.type = inputType;
        input.name = inputName;
        input.id = inputId;
        input.value = choice.id;
        input.dataset.optionId = String(opt.id);
        input.dataset.choiceName = choice.choice_name || choice.name || 'é¸æŠè‚¢';
        input.dataset.additionalPrice = String(choice.additional_price || 0);
        input.dataset.required = opt.required ? 'true' : 'false';
        input.dataset.optionName = opt.option_name || opt.name || 'ã‚ªãƒ—ã‚·ãƒ§ãƒ³';
        
        input.addEventListener('change', () => {
          updateSelectedOptions(opt, choice, input.checked);
        });
        
        const label = document.createElement('label');
        label.htmlFor = inputId;
        label.style.marginLeft = '8px';
        label.style.cursor = 'pointer';
        
        const choiceName = choice.choice_name || choice.name || 'é¸æŠè‚¢';
        const priceText = choice.additional_price > 0 ? ` (+Â¥${choice.additional_price})` : '';
        label.textContent = choiceName + priceText;
        
        choiceDiv.appendChild(input);
        choiceDiv.appendChild(label);
        optDiv.appendChild(choiceDiv);
      });
    }
    
    content.appendChild(optDiv);
  });
  
  modal.style.display = 'flex';
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeOptionModal() {
  const modal = document.getElementById('option-modal');
  modal.style.display = 'none';
  currentMenuForOptions = null;
  selectedOptions = {};
}

// é¸æŠã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
function updateSelectedOptions(option, choice, checked) {
  const optionName = option.option_name || option.name || 'ã‚ªãƒ—ã‚·ãƒ§ãƒ³';
  const choiceName = choice.choice_name || choice.name || 'é¸æŠè‚¢';
  
  if (!selectedOptions[option.id]) {
    selectedOptions[option.id] = {
      option_name: optionName,
      multiple: option.multiple || false,
      required: option.required || false,
      choices: []
    };
  }
  
  if (option.multiple) {
    if (checked) {
      selectedOptions[option.id].choices.push({
        id: choice.id,
        name: choiceName,
        price: choice.additional_price || 0
      });
    } else {
      selectedOptions[option.id].choices = selectedOptions[option.id].choices.filter(c => c.id !== choice.id);
    }
  } else {
    if (checked) {
      selectedOptions[option.id].choices = [{
        id: choice.id,
        name: choiceName,
        price: choice.additional_price || 0
      }];
    }
  }
}

// ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ãã§ã‚«ãƒ¼ãƒˆã«è¿½åŠ ï¼ˆâ˜…ç¨è¾¼è¨ˆç®—ã‚’æœ¬ä½“ãƒ­ã‚¸ãƒƒã‚¯ã¨çµ±ä¸€ï¼â˜…å¿…é ˆãƒã‚§ãƒƒã‚¯ã‚’IDå˜ä½ã§å³å¯†åŒ–ï¼‰
function addToCartWithOptions() {
  if (!currentMenuForOptions) return;
  
  const content = document.getElementById('option-modal-content');
  const allInputs = content.querySelectorAll('input[type="radio"], input[type="checkbox"]');

  // --- å¿…é ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³IDã”ã¨ï¼‰ ---
  const requiredOptionIds = Array.from(new Set(
    Array.from(allInputs)
      .filter(inp => inp.dataset.required === 'true')
      .map(inp => inp.dataset.optionId)
  ));
  for (const oid of requiredOptionIds) {
    const hasSelection = Array.from(allInputs).some(inp => inp.dataset.optionId === oid && inp.checked);
    if (!hasSelection) {
      const name = (Array.from(allInputs).find(inp => inp.dataset.optionId === oid)?.dataset.optionName) || 'å¿…é ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³';
      alert('å¿…é ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„: ' + name);
      return;
    }
  }
  
  // --- è¿½åŠ æ–™é‡‘ã¨è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆ ---
  let optionText = '';
  let additionalPrice = 0;
  Object.values(selectedOptions).forEach(opt => {
    if (opt.choices.length > 0) {
      const choiceNames = opt.choices.map(c => c.name).join(', ');
      optionText += `${opt.option_name}: ${choiceNames}\n`;
      additionalPrice += opt.choices.reduce((sum, c) => sum + Number(c.price || 0), 0);
    }
  });
  
  // --- ä¾¡æ ¼ï¼šæœ¬ä½“ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆexclâ†’incl ã¯ incl = excl + floor(excl*rate)ï¼‰ ---
  const {rate, excl, incl} = window.__computePrices(currentMenuForOptions);
  const finalExcl = excl + additionalPrice;
  const finalIncl = finalExcl + Math.floor(finalExcl * rate + 1e-9);

  window.__cart.push({
    menu_id: currentMenuForOptions.id,
    name: currentMenuForOptions.name,
    qty: 1,
    rate: rate,
    price_excl: finalExcl,
    price_incl: finalIncl,
    memo: optionText.trim(),
    options: selectedOptions
  });
  
  window.__renderCart();
  closeOptionModal();
}

window.addToCartWithOptions = addToCartWithOptions;
window.closeOptionModal = closeOptionModal;

// ===== æ™‚ä¾¡å•†å“ä¾¡æ ¼å…¥åŠ›æ©Ÿèƒ½ =====
let currentMarketPriceMenu = null;

function openMarketPriceModal(menu) {
  currentMarketPriceMenu = menu;
  const modal = document.getElementById('market-price-modal');
  const menuNameEl = document.getElementById('market-price-menu-name');
  const priceInput = document.getElementById('market-price-input');
  
  menuNameEl.textContent = menu.name || 'æ™‚ä¾¡å•†å“';
  priceInput.value = '';
  
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç¨è¾¼ã‚’é¸æŠ
  const inclRadio = document.querySelector('input[name="market-price-mode"][value="incl"]');
  if (inclRadio) inclRadio.checked = true;
  
  modal.style.display = 'flex';
  priceInput.focus();
}

function closeMarketPriceModal() {
  const modal = document.getElementById('market-price-modal');
  modal.style.display = 'none';
  currentMarketPriceMenu = null;
}

function saveMarketPrice() {
  if (!currentMarketPriceMenu) return;
  
  const priceInput = document.getElementById('market-price-input');
  const price = parseInt(priceInput.value, 10);
  
  if (!price || price <= 0) {
    alert('æœ‰åŠ¹ãªä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    priceInput.focus();
    return;
  }
  
  const modeRadio = document.querySelector('input[name="market-price-mode"]:checked');
  const mode = modeRadio ? modeRadio.value : 'incl';
  
  // ç¨ç‡ã‚’å–å¾—
  const taxRate = Number(currentMarketPriceMenu.tax_rate || 0.10);
  
  let priceExcl, priceIncl;
  
  if (mode === 'incl') {
    // ç¨è¾¼ä¾¡æ ¼ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆã€ç¨æŠœä¾¡æ ¼ã‚’é€†ç®—ï¼ˆåˆ‡ã‚Šä¸Šã’ï¼‰
    priceIncl = price;
    priceExcl = Math.ceil(price / (1 + taxRate));
  } else {
    // ç¨æŠœä¾¡æ ¼ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆ
    priceExcl = price;
    priceIncl = priceExcl + Math.floor(priceExcl * taxRate + 1e-9);
  }
  
  // ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
  window.__cart.push({
    menu_id: currentMarketPriceMenu.id,
    name: currentMarketPriceMenu.name,
    qty: 1,
    rate: taxRate,
    price_excl: priceExcl,
    price_incl: priceIncl,
    memo: '',
    actual_price: priceExcl,  // ç¨æŠœä¾¡æ ¼ã‚’ä¿å­˜
    price_mode: mode           // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’ä¿å­˜
  });
  
  window.__renderCart();
  closeMarketPriceModal();
}

window.openMarketPriceModal = openMarketPriceModal;
window.closeMarketPriceModal = closeMarketPriceModal;
window.saveMarketPrice = saveMarketPrice;
  </script>

  <!-- æ™‚ä¾¡å•†å“ä¾¡æ ¼å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="market-price-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1001; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:12px; padding:24px; max-width:400px; width:90%;">
      <h2 style="margin:0 0 16px;">æ™‚ä¾¡å•†å“ã®ä¾¡æ ¼è¨­å®š</h2>
      <div style="margin-bottom:16px;">
        <strong id="market-price-menu-name" style="font-size:18px;"></strong>
      </div>
      
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:8px; font-weight:500;">ä¾¡æ ¼å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</label>
        <div style="display:flex; gap:16px;">
          <label style="display:flex; align-items:center; cursor:pointer;">
            <input type="radio" name="market-price-mode" value="incl" checked style="margin-right:6px;">
            ç¨è¾¼ä¾¡æ ¼ã§å…¥åŠ›
          </label>
          <label style="display:flex; align-items:center; cursor:pointer;">
            <input type="radio" name="market-price-mode" value="excl" style="margin-right:6px;">
            ç¨æŠœä¾¡æ ¼ã§å…¥åŠ›
          </label>
        </div>
      </div>
      
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:8px; font-weight:500;">ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
        <input type="number" id="market-price-input" min="0" step="1" 
               style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; font-size:16px;"
               placeholder="ä¾‹: 5000">
      </div>
      
      <div style="display:flex; gap:12px; margin-top:24px;">
        <button class="btn sub" onclick="closeMarketPriceModal()" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" onclick="saveMarketPrice()" style="flex:1;">ä¿å­˜ã—ã¦ã‚«ãƒ¼ãƒˆã«è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- å•†å“ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="option-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:12px; padding:24px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto;">
      <h2 id="option-modal-title" style="margin:0 0 16px;">ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠ</h2>
      <div id="option-modal-content"></div>
      <div style="display:flex; gap:12px; margin-top:24px;">
        <button class="btn sub" onclick="closeOptionModal()" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" onclick="addToCartWithOptions()" style="flex:1;">ã‚«ãƒ¼ãƒˆã«è¿½åŠ </button>
      </div>
    </div>
  </div>

</body>
</html>
