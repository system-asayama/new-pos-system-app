{% extends "base.html" %}
{% block content %}
<h2>ã‚¹ã‚¿ãƒƒãƒ•ï¼šãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§</h2>
<!-- DEBUG: {{ debug_info }} -->

<div class="small" style="color:var(--muted);margin-bottom:8px">
  ã‚ˆã†ã“ãã€{{ staff_name }} ã•ã‚“
  <a class="btn sub" href="{{ url_for('logout') }}" style="float:right">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
</div>

<!-- â˜…â˜…â˜… è¿½åŠ ï¼šãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å±¥æ­´ãƒšãƒ¼ã‚¸ã¸ã®ãƒœã‚¿ãƒ³ â˜…â˜…â˜… -->
<div style="margin-bottom:16px; display:flex; gap:8px; align-items:center;">
  <a class="btn" href="{{ url_for('admin_table_move_history') }}" style="background:#6366f1; color:white;">
    ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å±¥æ­´ã‚’è¦‹ã‚‹
  </a>
  <span class="small" style="color:var(--muted)">éå»ã®ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•ã®å±¥æ­´ã‚’ç¢ºèªã§ãã¾ã™</span>
</div>

<div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px">
  {% for t in tables %}
    <div class="card">
      <div class="row-title">ãƒ†ãƒ¼ãƒ–ãƒ« {{ t['ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·'] }}</div>
      <div class="small" style="color:var(--muted)">çŠ¶æ…‹: {{ t['çŠ¶æ…‹'] }}</div>

      {% if t['order'] %}
        <div class="small">
          ç¾åœ¨åˆè¨ˆ: Â¥{{ t['order']['åˆè¨ˆ']|int }}
          {% if t['order'].get('æ—¢æ‰•') is not none and t['order'].get('æ®‹é¡') is not none %}
            ï¼ æ—¢æ‰•: Â¥{{ t['order']['æ—¢æ‰•']|int }} ï¼ æ®‹é¡: Â¥{{ t['order']['æ®‹é¡']|int }}
          {% endif %}
          {% if t['order'].get('çŠ¶æ…‹') %}
            ï¼ ä¼ç¥¨çŠ¶æ…‹: <strong>{{ t['order']['çŠ¶æ…‹'] }}</strong>
          {% endif %}
        </div>

        {# ==== ãƒœã‚¿ãƒ³ç¾¤ï¼ˆè¡¨ç¤ºæ¡ä»¶ã‚’é‡‘é¡ãƒ™ãƒ¼ã‚¹ã«ä¿®æ­£ï¼‰ ==== #}
        {% set o = t['order'] %}
        {% set status = o.get('çŠ¶æ…‹') or '' %}
        {% set paid = (o.get('æ—¢æ‰•', 0) | int) %}
        {% set remaining = (o.get('æ®‹é¡', 0) | int) %}
        {# ã‚¯ãƒ­ãƒ¼ã‚ºæ‰±ã„ã®çŠ¶æ…‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ï¼‰ #}
        {% set is_closed = status in ['ä¼šè¨ˆæ¸ˆ','closed','paid','ä¼šè¨ˆæ¸ˆ(çµ±åˆ)','ä¼šè¨ˆæ¸ˆ(è¿”å“)','ä¼šè¨ˆæ¸ˆ(è¨‚æ­£)'] %}
        {% set can_void = (paid > 0) and (not is_closed) %}
        {% set can_complete = (remaining == 0) and (paid > 0) and (not is_closed) %}

        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
          <!-- æ³¨æ–‡å…¥åŠ›ã¸ -->
          <a class="btn" href="{{ url_for('staff_open_menu', table_id=t['id']) }}">æ³¨æ–‡å…¥åŠ›ã¸</a>

          <!-- æ˜ç´°ï¼ˆorder_id ã‚’ã‚¯ã‚¨ãƒªã«ä»˜ä¸ï¼‰ -->
          <a class="btn sub" href="{{ url_for('table_detail', table_id=t['id']) }}?order_id={{ o['id'] }}">æ˜ç´°</a>

          <!-- ä¼šè¨ˆï¼šæœªã‚¯ãƒ­ãƒ¼ã‚ºã®ã¨ãæœ‰åŠ¹ -->
          <button class="btn {{ 'sub' if is_closed else '' }}" type="button"
                  onclick="openSettleModal({{ t['id'] }}, {{ o['id'] }})"
                  {{ 'disabled' if is_closed }}>
            ä¼šè¨ˆ
          </button>

          <!-- ä¼šè¨ˆå–ã‚Šæ¶ˆã—ï¼šæ—¢æ‰•>0 ã‹ã¤ æœªã‚¯ãƒ­ãƒ¼ã‚º -->
          {% if can_void %}
            <button class="btn warn" type="button"
                    onclick="voidPayments({{ o['id'] }})">
              ä¼šè¨ˆå–ã‚Šæ¶ˆã—
            </button>
          {% endif %}

          <!-- ä¼šè¨ˆå®Œäº†ï¼šæ®‹é¡0 ã‹ã¤ æ—¢æ‰•>0 ã‹ã¤ æœªã‚¯ãƒ­ãƒ¼ã‚º -->
          {% if can_complete %}
            <button class="btn" type="button"
                    onclick="completeOrder({{ o['id'] }})">
              ä¼šè¨ˆå®Œäº†
            </button>
          {% endif %}

          <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹• -->
          <button class="btn sub" type="button"
                  onclick="openMoveModal({{ t['id'] }}, {{ o['id'] }})">
            ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•
          </button>
        </div>
      {% else %}
        <div class="small">ç¾åœ¨åˆè¨ˆ: Â¥0</div>
        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
          <a class="btn sub" href="{{ url_for('staff_open_menu', table_id=t['id']) }}">æ–°è¦æ³¨æ–‡</a>
          <a class="btn" href="{{ url_for('table_detail', table_id=t['id']) }}">æ˜ç´°</a>
        </div>
      {% endif %}
    </div>
  {% endfor %}
</div>

<!-- ================= ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆåˆ†å‰²ä¼šè¨ˆï¼‰ ================= -->
<div id="settle-modal" class="modal" style="display:none">
  <div class="modal-body">
    <h3>ä¼šè¨ˆ</h3>
    <div class="small" id="settle-table-hint"></div>
    <div class="small" id="settle-summary" style="margin-top:6px"></div>

    <!-- æ”¯æ‰•è¡Œ -->
    <div id="pay-rows" style="display:flex; flex-direction:column; gap:8px; margin-top:12px"></div>

    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
      <button class="btn sub" type="button" onclick="addPayRow()">æ”¯æ‰•æ–¹æ³•ã‚’è¿½åŠ </button>
      <button class="btn" id="btn-do-split">ã“ã®å†…å®¹ã§ç™»éŒ²</button>
      <button class="btn sub" type="button" onclick="closeSettleModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- =============== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•ï¼‰ =============== -->
<div id="move-modal" class="modal" style="display:none">
  <div class="modal-body">
    <h3>ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•</h3>
    <div class="small" id="move-hint"></div>

    <div style="display:flex; flex-direction:column; gap:8px; margin-top:12px">
      <label class="small">ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«</label>
      <select id="move-dest" style="width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px"></select>

      <label class="small">ãƒ¢ãƒ¼ãƒ‰</label>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <label><input type="radio" name="move-mode" value="deny" checked> å…ˆå®¢ãŒã„ã‚Œã°ç§»å‹•ä¸å¯ï¼ˆdenyï¼‰</label>
        <label><input type="radio" name="move-mode" value="merge"> å…ˆå®¢ãŒã„ã‚Œã°åˆç®—ï¼ˆmergeï¼‰</label>
        <label><input type="radio" name="move-mode" value="merge_new"> åˆç®—ï¼‹æ–°ã—ã„ä¼ç¥¨ã‚’ä½œæˆï¼ˆmerge_newï¼‰</label>
        <label><input type="radio" name="move-mode" value="swap"> å…ˆå®¢ãŒã„ã‚Œã°äº¤æ›ï¼ˆswapï¼‰</label>
      </div>

      <div class="small" style="color:var(--muted)">
        ãƒ»mergeï¼šæ˜ç´°/æ”¯æ‰•/ãŠå®¢æ§˜æƒ…å ±ã‚’ç§»å‹•å…ˆã®ä¼ç¥¨ã«é›†ç´„ã—ã¾ã™ï¼ˆç§»å‹•å…ˆã®ä¼ç¥¨IDã‚’æ¸©å­˜ï¼‰ã€‚<br>
        ãƒ»merge_newï¼šåŒæ–¹ã®ä¼ç¥¨ã‚’ä¼šè¨ˆæ¸ˆ(çµ±åˆ)ã«ã—ã€æ–°ã—ã„ä¼ç¥¨IDã‚’ä½œã£ã¦ãã“ã¸é›†ç´„ã—ã¾ã™ã€‚<br>
        ãƒ»swapï¼šäºŒã¤ã®ä¼ç¥¨ãƒ»ãŠå®¢æ§˜çŠ¶æ…‹ãƒ»QR ã‚’ç›¸äº’ã«å…¥ã‚Œæ›¿ãˆã¾ã™ã€‚
      </div>

      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
        <button class="btn" id="btn-do-move">å®Ÿè¡Œ</button>
        <button class="btn sub" type="button" onclick="closeMoveModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<style>
/* ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…±ç”¨ï¼‰ */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center; z-index:9999;}
.modal-body{ background:#fff; color:#111; width:min(680px, 94vw); border-radius:12px; padding:16px; box-shadow:0 10px 24px rgba(0,0,0,.18);}
.modal-body h3{ margin:0 0 8px 0;}
.pay-row{ display:grid; grid-template-columns: 1fr 160px 36px; gap:8px; align-items:center; }
.pay-row select, .pay-row input{ width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; }
.pay-row button{ width:36px; height:36px; }
/* ãƒãƒƒã‚¸è‰² */
.badge-ok{ background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46; padding:0 6px; border-radius:10px; }
.badge-warn{ background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:0 6px; border-radius:10px; }
</style>

<script>
// ===== ç”»é¢ãƒ‡ãƒ¼ã‚¿ã‚’JSã¸ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’ç§»å‹•UIã«æ´»ç”¨ï¼‰ =====
window.__tables = {{ tables|tojson }};

let _settle_ctx = {
  table_id: null,
  order_id: null,
  total: 0,
  paid: 0,
  remaining: 0,
  methods: [] // {id, name, code}
};

function yen(n){
  try{ return 'Â¥' + Number(n).toLocaleString('ja-JP'); }catch(e){ return 'Â¥' + n; }
}

function forceReload(){
  const url = new URL(location.href);
  url.searchParams.set('r', Date.now().toString());
  setTimeout(()=>{ location.assign(url.toString()); }, 60);
}

/* ============ ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ï¼ˆæ—¢å­˜ï¼‰ ============ */
function closeSettleModal(){
  const m = document.getElementById('settle-modal');
  if(m) m.style.display = 'none';
  _settle_ctx = { table_id:null, order_id:null, total:0, paid:0, remaining:0, methods:[] };
  document.getElementById('pay-rows').innerHTML = '';
}
function canSettleFromSummary(sm){
  const pending = Number((sm && sm.items_pending) ?? 0);
  if (typeof sm?.items_ready === 'boolean') {
    return {ready: sm.items_ready, pending};
  }
  return {ready: pending === 0, pending};
}

async function openSettleModal(table_id, order_id){
  _settle_ctx.table_id = table_id;
  _settle_ctx.order_id = order_id;
  document.getElementById('settle-table-hint').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«ID: ${table_id} / æ³¨æ–‡ID: ${order_id}`;

  // ---- ã‚µãƒãƒªå–å¾—ï¼ˆäº’æ›ã‚­ãƒ¼å¯¾å¿œï¼‰----
  try{
    const r2 = await fetch(`/admin/order/${order_id}/summary`);
    const j = await r2.json();
    if(!j.ok) throw new Error(j.error || 'summary load failed');

    // å–æ¶ˆåæ˜ å¾Œã®é‡‘é¡ã¯ã‚µãƒ¼ãƒãŒè¿”ã™ j.total / j.paid / j.remaining ã‚’æœ€å„ªå…ˆ
    const total     = j.total     ?? j.åˆè¨ˆ        ?? j.grand_total ?? 0;
    const paid      = j.paid      ?? j.æ—¢æ‰•        ?? j.paid_total  ?? 0;
    const remaining = j.remaining ?? j.æ®‹é¡        ?? j.amount_due  ?? (total - paid);

    // æ—¢å­˜ã®ã€Œæœªæä¾›ãƒã‚§ãƒƒã‚¯ã€äº’æ›ï¼ˆj.summary ãŒã‚ã‚Œã°ä½¿ã†ã€ç„¡ã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    let ready = true, pending = 0;
    if (j.summary) {
      const rdy = canSettleFromSummary(j.summary);
      ready = rdy.ready; pending = rdy.pending;
    }
    if (!ready) {
      const go = confirm(`æœªæä¾›/èª¿ç†ä¸­ã®æ˜ç´°ãŒ ${pending} ä»¶ã‚ã‚Šã¾ã™ã€‚\nãã‚Œã§ã‚‚ä¼šè¨ˆã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`);
      if (!go) return;
    }

    _settle_ctx.total = Number(total);
    _settle_ctx.paid = Number(paid);
    _settle_ctx.remaining = Number(remaining);
    document.getElementById('settle-summary').innerHTML =
      `åˆè¨ˆ: <strong>${yen(_settle_ctx.total)}</strong> ï¼ æ—¢æ‰•: <strong>${yen(_settle_ctx.paid)}</strong> ï¼ æ®‹é¡: <strong>${yen(_settle_ctx.remaining)}</strong>`;
  }catch(e){
    alert('æ³¨æ–‡ã‚µãƒãƒªã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    return;
  }

  // ---- æ”¯æ‰•æ–¹æ³•ã®å–å¾— ----
  try{
    const r1 = await fetch('/admin/payment_methods/json');
    const j1 = await r1.json();
    if(!j1.ok) throw new Error('methods load failed');
    _settle_ctx.methods = j1.methods || [];
  }catch(e){
    alert('æ”¯æ‰•æ–¹æ³•ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  // åˆæœŸè¡Œã‚’1è¡Œè¿½åŠ ã—ã¦é–‹ã
  const box = document.getElementById('pay-rows');
  box.innerHTML = '';
  addPayRow();
  document.getElementById('btn-do-split').onclick = doSplitSettle;
  document.getElementById('settle-modal').style.display = 'flex';
}

function buildMethodSelect(){
  const sel = document.createElement('select');
  _settle_ctx.methods.forEach(m=>{
    const opt = document.createElement('option');
    opt.value = m.id;
    opt.textContent = `${m.name} (${m.code})`;
    sel.appendChild(opt);
  });
  return sel;
}
function addPayRow(){
  const row = document.createElement('div');
  row.className = 'pay-row';
  const sel = buildMethodSelect(); sel.required = true;
  const input = document.createElement('input'); input.type = 'number'; input.min='1'; input.step='1'; input.placeholder='é‡‘é¡ï¼ˆä¾‹ï¼š1000ï¼‰';
  const del = document.createElement('button'); del.type='button'; del.className='btn sub'; del.textContent='Ã—';
  del.onclick = () => { row.remove(); updateRemainingHint(); };
  input.addEventListener('input', updateRemainingHint);
  row.appendChild(sel); row.appendChild(input); row.appendChild(del);
  document.getElementById('pay-rows').appendChild(row);
  updateRemainingHint();
}
function calcEnteredSum(){
  const inputs = Array.from(document.querySelectorAll('#pay-rows input[type="number"]'));
  return inputs.reduce((a, el)=> a + Number(el.value||0), 0);
}
function updateRemainingHint(){
  const sum = calcEnteredSum();
  const remainAfter = Math.max(0, _settle_ctx.remaining - sum);
  const sdiv = document.getElementById('settle-summary');
  const over = sum > _settle_ctx.remaining;
  const badgeClass = over ? 'badge-warn' : 'badge-ok';
  sdiv.innerHTML = `åˆè¨ˆ: <strong>${yen(_settle_ctx.total)}</strong> ï¼ æ—¢æ‰•: <strong>${yen(_settle_ctx.paid)}</strong> ï¼ æ®‹é¡: <strong>${yen(_settle_ctx.remaining)}</strong>
    <span class="${badgeClass}" style="margin-left:8px">ä»Šå›å…¥åŠ›åˆè¨ˆ: ${yen(sum)} / ç™»éŒ²å¾Œã®æ®‹é¡: ${yen(remainAfter)}</span>`;
}
async function doSplitSettle(){
  let force = false;
  try{
    const r = await fetch(`/admin/order/${_settle_ctx.order_id}/summary`);
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'summary reload failed');
    // j.summary ãŒã‚ã‚‹æ™‚ã ã‘æœªæä¾›ãƒã‚§ãƒƒã‚¯
    if (j.summary){
      const {ready, pending} = canSettleFromSummary(j.summary || {});
      if (!ready) {
        const go = confirm(`æœªæä¾›ã®æ˜ç´°ãŒ ${pending} ä»¶ã‚ã‚Šã¾ã™ã€‚\nãã‚Œã§ã‚‚ä¼šè¨ˆã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`);
        if (!go) { closeSettleModal(); return; }
        force = true;
      }
    }
  }catch(e){
    alert('ã‚µãƒãƒªã®å†å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); return;
  }
  const rows = Array.from(document.querySelectorAll('#pay-rows .pay-row'));
  if(rows.length === 0){ alert('æ”¯æ‰•è¡Œã‚’1ã¤ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„ã€‚'); return; }
  const payments = [];
  for(const r of rows){
    const method_id = Number(r.querySelector('select').value || 0);
    const amount = Number(r.querySelector('input').value || 0);
    if(!method_id){ alert('æ”¯æ‰•æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
    if(!(amount > 0)){ alert('é‡‘é¡ã¯1ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
    payments.push({method_id, amount});
  }
  const enteredSum = payments.reduce((a,p)=>a+p.amount,0);
  if(enteredSum > _settle_ctx.remaining){ alert('å…¥åŠ›é‡‘é¡ã®åˆè¨ˆãŒæ®‹é¡ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚'); return; }
  try{
    const r = await fetch(`/admin/settle/${_settle_ctx.table_id}/pay`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ order_id: _settle_ctx.order_id, payments, force })
    });
    let j = await r.json();
    if(!j.ok && j.need_force){
      const go = confirm(`æœªæä¾›ã®æ˜ç´°ãŒã‚ã‚Šã¾ã™ï¼ˆ${j.pending} ä»¶ï¼‰ã€‚\nãã‚Œã§ã‚‚ä¼šè¨ˆã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`);
      if(!go) return;
      const r2 = await fetch(`/admin/settle/${_settle_ctx.table_id}/pay`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ order_id: _settle_ctx.order_id, payments, force:true })
      });
      j = await r2.json();
    }
    if(!j.ok){ alert(j.error || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    alert('æ”¯æ‰•ã„ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚æœ€æ–°è¡¨ç¤ºã«æ›´æ–°ã—ã¾ã™ã€‚'); forceReload();
  }catch(e){ alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
}

/* ============ ä¼šè¨ˆå–æ¶ˆ / å®Œäº† ============ */
async function voidPayments(order_id){
  if(!confirm('ã“ã®ä¼ç¥¨ã®æ”¯æ‰•ã„ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿï¼ˆä¼šè¨ˆæ¸ˆã®ä¼ç¥¨ã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰')) return;
  const btn = event?.currentTarget;
  if(btn){ btn.disabled = true; btn.dataset.lbl = btn.textContent; btn.textContent = 'å‡¦ç†ä¸­â€¦'; }
  try{
    const r = await fetch(`/admin/order/${order_id}/void-payments`, { method:'POST' });
    const j = await r.json();
    if(!j.ok){ alert(j.error || 'å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    alert('æ”¯æ‰•ã„ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚æœ€æ–°è¡¨ç¤ºã«æ›´æ–°ã—ã¾ã™ã€‚'); forceReload();
  }catch(e){ alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  finally{ if(btn){ btn.disabled = false; btn.textContent = btn.dataset.lbl || 'ä¼šè¨ˆå–ã‚Šæ¶ˆã—'; } }
}
async function completeOrder(order_id){
  if(!confirm('ã“ã®ä¼ç¥¨ã‚’ä¼šè¨ˆå®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿï¼ˆæ®‹é¡0ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰')) return;
  const btn = event?.currentTarget;
  if(btn){ btn.disabled = true; btn.dataset.lbl = btn.textContent; btn.textContent = 'å‡¦ç†ä¸­â€¦'; }
  try{
    const r = await fetch(`/admin/order/${order_id}/complete`, { method:'POST' });
    const j = await r.json();
    if(!j.ok){ alert(j.error || 'å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    alert('ä¼šè¨ˆã‚’å®Œäº†ã—ã¾ã—ãŸã€‚æœ€æ–°è¡¨ç¤ºã«æ›´æ–°ã—ã¾ã™ã€‚'); forceReload();
  }catch(e){ alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  finally{ if(btn){ btn.disabled = false; btn.textContent = btn.dataset.lbl || 'ä¼šè¨ˆå®Œäº†'; } }
}

/* ============ ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ ============ */
let _move_ctx = { from_table_id: null, from_order_id: null };

function closeMoveModal(){
  const m = document.getElementById('move-modal');
  if(m) m.style.display = 'none';
  _move_ctx = { from_table_id:null, from_order_id:null };
  const sel = document.getElementById('move-dest');
  if (sel) sel.innerHTML = '';
}

function buildDestOptions(from_id){
  const sel = document.getElementById('move-dest');
  sel.innerHTML = '';
  (window.__tables || []).forEach(t=>{
    if (t.id === from_id) return; // è‡ªå¸­ã¯é™¤å¤–
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${t["ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·"]}ï¼ˆID:${t.id}ï¼‰`;
    sel.appendChild(opt);
  });
}

function getSelectedMoveMode(){
  const v = document.querySelector('input[name="move-mode"]:checked')?.value || 'deny';
  return v;
}

function openMoveModal(from_table_id, from_order_id){
  _move_ctx.from_table_id = from_table_id;
  _move_ctx.from_order_id = from_order_id;
  buildDestOptions(from_table_id);
  document.getElementById('move-hint').textContent = `ç§»å‹•å…ƒãƒ†ãƒ¼ãƒ–ãƒ«ID: ${from_table_id} / æ³¨æ–‡ID: ${from_order_id}`;
  document.getElementById('btn-do-move').onclick = doMove;
  document.getElementById('move-modal').style.display = 'flex';
}

async function doMove(){
  const to_table_id = Number(document.getElementById('move-dest').value || 0);
  const mode = getSelectedMoveMode(); // "deny" | "merge" | "merge_new" | "swap"
  if(!to_table_id){ alert('ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
  const btn = document.getElementById('btn-do-move');
  if(btn){ btn.disabled = true; btn.dataset.lbl = btn.textContent; btn.textContent = 'å‡¦ç†ä¸­â€¦'; }
  try{
    const r = await fetch('/admin/table/move', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ from_table_id: _move_ctx.from_table_id, to_table_id, mode })
    });

    if (r.status === 409) {
      const j409 = await r.json().catch(()=>({}));
      alert(j409.error || 'ç§»å‹•ã§ãã¾ã›ã‚“ï¼ˆå…ˆå®¢ãŒã„ã¾ã™ï¼‰');
      return;
    }

    const j = await r.json();
    if(!j.ok){
      alert(j.error || 'ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ'); return;
    }

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
    if (mode === 'merge_new' && j.merged_new && j.new_order_id){
      alert(`çµ±åˆã—ã¦æ–°ã—ã„ä¼ç¥¨ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆæ–°ä¼ç¥¨ID: ${j.new_order_id}ï¼‰ã€‚\næœ€æ–°è¡¨ç¤ºã«æ›´æ–°ã—ã¾ã™ã€‚`);
    } else if (mode === 'swap' && j.swapped){
      alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’äº¤æ›ã—ã¾ã—ãŸã€‚æœ€æ–°è¡¨ç¤ºã«æ›´æ–°ã—ã¾ã™ã€‚');
    } else {
      alert('ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æœ€æ–°è¡¨ç¤ºã«æ›´æ–°ã—ã¾ã™ã€‚');
    }
    forceReload();
  }catch(e){ alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  finally{ if(btn){ btn.disabled = false; btn.textContent = btn.dataset.lbl || 'å®Ÿè¡Œ'; } }
}
</script>
{% endblock %}
