{% extends "base.html" %}
{% block content %}
<h2 class="center" style="margin-bottom:8px">
  ãƒ•ãƒ­ã‚¢
  <span>
    <button class="btn" id="btn-manual-refresh" onclick="forceReload()" title="æœ€æ–°çŠ¶æ…‹ã«æ›´æ–°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ï¼‰">ğŸ”„ ç”»é¢æ›´æ–°</button>
  </span>
</h2>
<!-- ï¼ˆå¿…è¦ãªã‚‰ï¼‰DEBUG: {{ debug_info }} -->

<style>
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .card{background:#fff;border:1px solid var(--border, #e5e7eb);border-radius:12px;padding:12px}
  .center{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:8px;border:1px solid var(--border,#e5e7eb);background:#f9fafb;cursor:pointer;text-decoration:none;color:inherit}
  a.btn{color:inherit}
  .btn.sub{background:#eef2ff;color:#3730a3}
  .badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:9999px;font-size:12px;border:1px solid transparent}
  .badge-idle{background:#f1f5f9;color:#334155;border-color:#e2e8f0}       /* ç©ºå¸­ */
  .badge-busy{background:#ecfeff;color:#0e7490;border-color:#a5f3fc}       /* åˆ©ç”¨ä¸­ */
  .badge-pay{ background:#fff7ed;color:#9a3412;border-color:#fed7aa }      /* ä¼šè¨ˆä¸­ï¼ˆéƒ¨åˆ†å…¥é‡‘ã‚ã‚Šï¼‰ */
  .small{font-size:12px;color:#6b7280}
  .muted{color:#6b7280}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:9999;}
  .modal-body{background:#fff;color:#111;width:min(640px,94vw);border-radius:12px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.18);}
  .modal-body h3{margin:0 0 8px 0;}
  .pay-row{display:grid;grid-template-columns:1fr 160px 36px;gap:8px;align-items:center;}
  .pay-row select,.pay-row input{width:100%;padding:8px 10px;border:1px solid var(--border,#e5e7eb);border-radius:8px;}
  .pay-row button{width:36px;height:36px;}
  .badge-ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;}
  .badge-warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;}
</style>

<div class="grid">
  {% for t in tables %}

  {% set o = (t.get('order') if t.get is defined else (t['order'] if 'order' in t else None)) %}
  {% set o_is_number = (o is number) %}
  {% set order_id = (o if o_is_number else (o.get('id') if o and o.get is defined else (o['id'] if o and 'id' in o else None))) %}

  {# åˆè¨ˆ/æ—¢æ‰•/æ®‹é¡ï¼šã‚«ãƒ³ãƒé™¤å»â†’int #}
  {% set total_raw =
    (o.get('åˆè¨ˆ') if o and o.get is defined and o.get('åˆè¨ˆ') is not none else
     (o['åˆè¨ˆ'] if o and 'åˆè¨ˆ' in o and o['åˆè¨ˆ'] is not none else
      (o.get('total') if o and o.get is defined else (o['total'] if o and 'total' in o else 0)))) %}
  {% set paid_raw =
    (o.get('æ—¢æ‰•') if o and o.get is defined and o.get('æ—¢æ‰•') is not none else
     (o['æ—¢æ‰•'] if o and 'æ—¢æ‰•' in o and o['æ—¢æ‰•'] is not none else
      (o.get('æ—¢æ‰•ã„') if o and o.get is defined and o.get('æ—¢æ‰•ã„') is not none else
       (o['æ—¢æ‰•ã„'] if o and 'æ—¢æ‰•ã„' in o and o['æ—¢æ‰•ã„'] is not none else
        (o.get('paid') if o and o.get is defined else (o['paid'] if o and 'paid' in o else 0)))))) %}
  {% set remaining_raw =
    (o.get('æ®‹é¡') if o and o.get is defined and o.get('æ®‹é¡') is not none else
     (o['æ®‹é¡'] if o and 'æ®‹é¡' in o and o['æ®‹é¡'] is not none else
      (o.get('remaining') if o and o.get is defined else (o['remaining'] if o and 'remaining' in o else None)))) %}

  {% set total_amt = ((total_raw|string)|replace(',', '')|replace('ï¼Œ',''))|int %}
  {% set paid_int  = ((paid_raw|string)|replace(',', '')|replace('ï¼Œ',''))|int %}
  {% if remaining_raw is not none %}
    {% set remaining_int = ((remaining_raw|string)|replace(',', '')|replace('ï¼Œ',''))|int %}
  {% else %}
    {% set tmp_diff = total_amt - paid_int %}
    {% set remaining_int = tmp_diff if tmp_diff > 0 else 0 %}
  {% endif %}

  {% set status =
    (o.get('status') if o and o.get is defined else
     (o['status'] if o and 'status' in o else
      (o.get('çŠ¶æ…‹') if o and o.get is defined else (o['çŠ¶æ…‹'] if o and 'çŠ¶æ…‹' in o else None)))) %}
  {% set is_closed = status in ['closed','settled','canceled','cancelled','ä¼šè¨ˆæ¸ˆ'] %}

  {% set has_order = (order_id is not none) or (total_amt>0) or (paid_int>0) or (remaining_int>0) %}

  {# ãƒãƒƒã‚¸ï¼šéƒ¨åˆ†å…¥é‡‘ãŒã‚ã‚‹ã¨ãã ã‘ä¼šè¨ˆä¸­ #}
  {% if has_order %}
    {% if (paid_int > 0) and (remaining_int > 0) %}
      {% set badge_text = 'ä¼šè¨ˆä¸­' %}{% set badge_class = 'badge-pay' %}
    {% elif not is_closed %}
      {% set badge_text = 'åˆ©ç”¨ä¸­' %}{% set badge_class = 'badge-busy' %}
    {% else %}
      {% set badge_text = 'ç©ºå¸­' %}{% set badge_class = 'badge-idle' %}
    {% endif %}
  {% else %}
    {% set badge_text = 'ç©ºå¸­' %}{% set badge_class = 'badge-idle' %}
  {% endif %}

  {% set table_id =
     (t.get('id') if t.get is defined else None)
     or (t['id'] if 'id' in t else None)
     or (t.get('table_id') if t.get is defined else None)
     or (t['table_id'] if 'table_id' in t else None)
     or (t.id if t.id is defined else None)
  %}
  {% set last_qr = (t.get('last_qr') if t.get is defined else (t['last_qr'] if 'last_qr' in t else None)) %}

  <div class="card">
    <div class="center">
      <strong>{{ t['ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·'] }}</strong>
      <span class="badge {{ badge_class }}">{{ badge_text }}</span>
    </div>

    {% if has_order %}
      <div class="small" style="margin-top:6px">
        æ³¨æ–‡ID: {{ order_id if order_id is not none else 'â€”' }}
        {% if total_amt %}/ åˆè¨ˆ: Â¥{{ total_amt|int }}{% endif %}
        / æ—¢æ‰•: Â¥{{ paid_int|int }}
        / æ®‹é¡: Â¥{{ remaining_int|int }}
        {% if status %}/ çŠ¶æ…‹: <strong>{{ status }}</strong>{% endif %}
      </div>
    {% else %}
      <div class="small" style="margin-top:6px">æœªæ³¨æ–‡</div>
    {% endif %}

    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
      {% if table_id is not none %}
        <a class="btn" href="{{ url_for('table_detail', table_id=table_id) }}">æ˜ç´°</a>
      {% endif %}
      {% if order_id is not none %}
        {# å°åˆ·ãƒœã‚¿ãƒ³ #}
        {# æ˜ç´°å°åˆ·ï¼šä¼šè¨ˆå‰ã®ã¿è¡¨ç¤º #}
        {% if paid_int == 0 %}
          <a class="btn" href="{{ url_for('bill_print', order_id=order_id) }}" target="_blank" rel="noopener">ğŸ–¨ï¸ æ˜ç´°å°åˆ·</a>
        {% endif %}
        
        {# ãƒ¬ã‚·ãƒ¼ãƒˆã¨é ˜åæ›¸ï¼šä¼šè¨ˆæ¸ˆã¿ã‹ã¤ä¼šè¨ˆå®Œäº†å‰ã®ã¿è¡¨ç¤º #}
        {% if (paid_int > 0) and (not is_closed) %}
          <a class="btn" href="{{ url_for('receipt_print', order_id=order_id) }}" target="_blank" rel="noopener">ğŸ§¾ ãƒ¬ã‚·ãƒ¼ãƒˆ</a>
          <a class="btn" href="{{ url_for('invoice_print', order_id=order_id) }}" target="_blank" rel="noopener">ğŸ“œ é ˜åæ›¸</a>
        {% endif %}
        
        <button class="btn sub" onclick="openSettleModal({{ table_id }}, {{ order_id }})">ä¼šè¨ˆ</button>

        {# å–æ¶ˆï¼šæœªã‚¯ãƒ­ãƒ¼ã‚º & æ—¢æ‰•>0 #}
        {% if (not is_closed) and (paid_int > 0) %}
          <button class="btn" onclick="voidPayments({{ order_id }})">ä¼šè¨ˆå–ã‚Šæ¶ˆã—</button>
        {% endif %}

        {# å®Œäº†ï¼šæœªã‚¯ãƒ­ãƒ¼ã‚º & æ®‹é¡0 & åˆè¨ˆ>0 #}
        {% if (not is_closed) and (remaining_int == 0) and (total_amt > 0) %}
          <button class="btn" onclick="completeOrder({{ order_id }})">ä¼šè¨ˆå®Œäº†</button>
        {% endif %}

        {# ğŸ”¹ ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–ï¼ˆæœªä¼šè¨ˆã‹ã¤æ˜ç´°0 or å…¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ã¿æˆåŠŸï¼‰ #}
        {% if not is_closed %}
          <button class="btn" style="background:#fee2e2;color:#b91c1c;"
                  onclick="resetSession({{ order_id }})"
                  title="æœªä¼šè¨ˆã‹ã¤æ˜ç´°0/å…¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ã¨ããƒ˜ãƒƒãƒ€ã‚’å‰Šé™¤">
            ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–
          </button>
        {% endif %}
      {% endif %}
    </div>

    <form method="post" action="{{ url_for('admin_new_token') }}" class="small" style="margin-top:8px">
      <input type="hidden" name="table_id" value="{{ table_id }}">
      <div class="center" style="gap:8px">
        <input type="number" name="ttl_minutes" placeholder="æœ‰åŠ¹åˆ†(ç©º=ç„¡æœŸé™)" style="width:50%">
        <button class="btn sub" type="submit" {% if table_id is none %}disabled title="ãƒ†ãƒ¼ãƒ–ãƒ«IDãŒä¸æ˜ã§ã™"{% endif %}>QRç™ºè¡Œ</button>
      </div>
    </form>

    {% if last_qr %}
      <div class="small" style="margin-top:6px">
        URL:
        <a href="{{ url_for('menu_page', tenant_slug=current_tenant_slug, token=last_qr, _external=True) }}"
           target="_blank" rel="noopener">é–‹ã</a>
      </div>
      <div style="margin-top:6px">
        {% if table_id is not none %}
          <a class="btn sub" href="{{ url_for('qr_print', table_id=table_id) }}" target="_blank" rel="noopener">QRå°åˆ·</a>
        {% else %}
          <button class="btn sub" type="button" disabled title="ãƒ†ãƒ¼ãƒ–ãƒ«IDãŒä¸æ˜ã§ã™">QRå°åˆ·</button>
        {% endif %}
      </div>
    {% else %}
      <div class="small muted" style="margin-top:6px">QRæœªç™ºè¡Œã§ã™ã€‚å…ˆã«ã€ŒQRç™ºè¡Œã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
      <div style="margin-top:6px">
        <button class="btn sub" type="button" disabled title="å…ˆã«QRç™ºè¡Œã—ã¦ãã ã•ã„">QRå°åˆ·</button>
      </div>
    {% endif %}
  </div>

  {% endfor %}
</div>

<!-- ================= ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆåˆ†å‰²ä¼šè¨ˆï¼‰ ================= -->
<div id="settle-modal" class="modal">
  <div class="modal-body">
    <h3>ä¼šè¨ˆ</h3>
    <div class="small" id="settle-table-hint"></div>
    <div class="small" id="settle-summary" style="margin-top:6px"></div>

    <!-- æ”¯æ‰•è¡Œ -->
    <div id="pay-rows" style="display:flex; flex-direction:column; gap:8px; margin-top:12px"></div>

    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
      <button class="btn sub" type="button" onclick="addPayRow()">æ”¯æ‰•æ–¹æ³•ã‚’è¿½åŠ </button>
      <button class="btn" id="btn-do-split">ã“ã®å†…å®¹ã§ç™»éŒ²</button>
      <button class="btn sub" type="button" onclick="closeSettleModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- ================= ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ™‚ä¾¡å•†å“ã®ä¾¡æ ¼è¨­å®šï¼‰ ================= -->
<div id="market-price-modal" class="modal" style="display:none">
  <div class="modal-body">
    <h3>æ™‚ä¾¡å•†å“ã®ä¾¡æ ¼è¨­å®š</h3>
    <p class="small muted">ä»¥ä¸‹ã®æ™‚ä¾¡å•†å“ã®ä¾¡æ ¼ï¼ˆç¨æŠœï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
    
    <div id="market-price-items" style="margin-top:12px"></div>
    
    <div style="display:flex; gap:8px; margin-top:16px">
      <button class="btn primary" id="btn-save-market-prices">ä¿å­˜</button>
      <button class="btn sub" id="btn-cancel-market-prices">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<script>
let _settle_ctx = { table_id: null, order_id: null, total: 0, paid: 0, remaining: 0, methods: [], market_price_items: [] };

function yen(n){ try{ return 'Â¥' + Number(n).toLocaleString('ja-JP'); }catch(e){ return 'Â¥' + n; } }

function closeSettleModal(){
  const m = document.getElementById('settle-modal');
  if(m) m.style.display = 'none';
  _settle_ctx = { table_id:null, order_id:null, total:0, paid:0, remaining:0, methods:[] };
  const box = document.getElementById('pay-rows'); if (box) box.innerHTML = '';
}

/* ==== è‡ªå‹•æ›´æ–°ï¼šSSE -> ãƒãƒ¼ãƒªãƒ³ã‚° -> ã‚¿ã‚¤ãƒãƒ¼ ã®é †ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ==== */
(function autoRefreshSetup(){
  const AUTO_REFRESH_MS = 5000;   // â† 5ç§’
  const FULL_REFRESH_MS = 30000;  // â† 30ç§’ã”ã¨ã«ãƒ•ãƒ«ãƒªãƒ­ãƒ¼ãƒ‰ä¿é™º

  // ä»–ã‚¿ãƒ–ã‹ã‚‰ã®é€šçŸ¥ã§å³æ™‚æ›´æ–°
  window.addEventListener('storage', (e)=>{
    if(e.key === 'floor_refresh'){ forceReload(true); }
  });

  // SSEï¼ˆã‚ã‚‹å ´åˆï¼‰â†’ å–å¾—ã§ããªã‘ã‚Œã°ãƒãƒ¼ãƒªãƒ³ã‚°
  let usingSSE = false;
  try{
    const es = new EventSource('/events/floor');
    usingSSE = true;
    es.onmessage = (ev)=>{
      const data = (ev.data || '').trim();
      if(!data) return;
      if (data === 'refresh' || data === 'changed') return forceReload(true);
      try{ const j = JSON.parse(data); if(j.changed) return forceReload(true); }catch(_){}
    };
    es.onerror = ()=>{ try{ es.close(); }catch(_){}; usingSSE=false; startPolling(); };
  }catch(_){
    startPolling();
  }

  function startPolling(){
    const tryPoll = async ()=>{
      try{
        const r = await fetch('/admin/floor/changed?_=' + Date.now(), {cache:'no-store'});
        if(r.ok){
          let changed = false;
          const ct = (r.headers.get('content-type')||'').toLowerCase();
          if(ct.includes('application/json')){
            const j = await r.json(); changed = !!j.changed;
          }else{
            const t = (await r.text()).trim();
            changed = (t === '1' || t === 'changed' || t === 'true');
          }
          if(changed) return forceReload(true);
        }
      }catch(_){}
    };
    setInterval(tryPoll, AUTO_REFRESH_MS);      // 5ç§’ã”ã¨ã«å·®åˆ†ãƒã‚§ãƒƒã‚¯
    setInterval(()=>forceReload(true), FULL_REFRESH_MS); // 30ç§’ã”ã¨ã«å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰
  }
})();

/** ã‚µãƒãƒªã‹ã‚‰ä¼šè¨ˆå¯å¦åˆ¤å®šï¼ˆå¾Œæ–¹äº’æ›ï¼‰ */
function canSettleFromSummary(sm){
  const pending = Number((sm && sm.items_pending) ?? 0);
  if (typeof sm?.items_ready === 'boolean') return { ready: sm.items_ready, pending };
  if ('items_pending' in (sm || {})) return { ready: pending === 0, pending };
  return { ready: true, pending: 0 };
}

/** ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡è¦–ã®å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆiOSå¯¾ç­–è¾¼ã¿ï¼‰ã€‚ä»–ã‚¿ãƒ–ã«ã‚‚é€šçŸ¥ã€‚ */
function forceReload(silent){
  try{ localStorage.setItem('floor_refresh', String(Date.now())); }catch(_){}
  if(!silent){
    const btn = document.getElementById('btn-manual-refresh');
    if(btn){ btn.disabled = true; btn.textContent = 'æ›´æ–°ä¸­â€¦'; setTimeout(()=>{ btn.disabled=false; btn.textContent='ğŸ”„ ç”»é¢æ›´æ–°'; }, 1200);}
  }
  try{ closeSettleModal(); }catch(e){}
  const url = new URL(location.href);
  url.searchParams.set('r', Date.now().toString());
  setTimeout(()=>{
    try{ location.assign(url.toString()); }
    catch(e1){ try{ location.href = url.toString(); } catch(e2){ location.reload(); } }
  }, 40);
}

/* ========== ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
async function openSettleModal(table_id, order_id){
  _settle_ctx.table_id = table_id;
  _settle_ctx.order_id = order_id;
  document.getElementById('settle-table-hint').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«ID: ${table_id} / æ³¨æ–‡ID: ${order_id}`;

  try{
    const r2 = await fetch(`/admin/order/${order_id}/summary`, {cache:'no-store'});
    const j2 = await r2.json();
    console.log('[openSettleModal] Summary response:', j2);
    if(!j2.ok) throw new Error(j2.error || 'summary load failed');
    const sm = j2;  // APIã¯ç›´æ¥ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«å€¤ã‚’è¿”ã™
    const {ready, pending} = canSettleFromSummary(sm);

    if (!ready) {
      const go = confirm(`æœªæä¾›/èª¿ç†ä¸­ã®æ˜ç´°ãŒ ${pending} ä»¶ã‚ã‚Šã¾ã™ã€‚\nãã‚Œã§ã‚‚ä¼šè¨ˆã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`);
      if (!go) return;
    }

    const toNum = v => Number(String(v ?? '0').replace(/[ï¼Œ,]/g,''));
    _settle_ctx.total = toNum(sm.total);
    _settle_ctx.paid = toNum(sm.paid);
    _settle_ctx.remaining = toNum(sm.remaining ?? (_settle_ctx.total - _settle_ctx.paid));
    _settle_ctx.market_price_items = sm.market_price_items || [];

    // æ™‚ä¾¡å•†å“ãŒã‚ã‚‹å ´åˆã¯è­¦å‘Šã‚’è¡¨ç¤º
    if (_settle_ctx.market_price_items.length > 0) {
      console.log('[openSettleModal] Market price items:', _settle_ctx.market_price_items);
      const itemNames = _settle_ctx.market_price_items.map(it => `${it.name} x${it.qty}`).join(', ');
      console.log('[openSettleModal] Item names:', itemNames);
      const go = confirm(`æ™‚ä¾¡å•†å“ãŒå«ã¾ã‚Œã¦ã„ã¾ã™: ${itemNames}\n\nä¼šè¨ˆå‰ã«ä¾¡æ ¼ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\nä¾¡æ ¼è¨­å®šç”»é¢ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ`);
      if (go) {
        await showMarketPriceModal();
        // ä¾¡æ ¼è¨­å®šå¾Œã€å†åº¦ã‚µãƒãƒªã‚’å–å¾—
        const r3 = await fetch(`/admin/order/${order_id}/summary`, {cache:'no-store'});
        const j3 = await r3.json();
        if(j3.ok) {
          _settle_ctx.total = toNum(j3.total);
          _settle_ctx.remaining = toNum(j3.remaining ?? (_settle_ctx.total - _settle_ctx.paid));
          _settle_ctx.market_price_items = j3.market_price_items || [];
        }
      } else {
        return; // ä¾¡æ ¼è¨­å®šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      }
    }

    document.getElementById('settle-summary').innerHTML =
      `åˆè¨ˆ: <strong>${yen(_settle_ctx.total)}</strong> ï¼ æ—¢æ‰•: <strong>${yen(_settle_ctx.paid)}</strong> ï¼ æ®‹é¡: <strong>${yen(_settle_ctx.remaining)}</strong>`;
  }catch(e){
    console.error('[openSettleModal] Error:', e);
    alert('æ³¨æ–‡ã‚µãƒãƒªã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    return;
  }

  try{
    const r1 = await fetch('/admin/payment_methods/json', {cache:'no-store'});
    const j1 = await r1.json();
    if(!j1.ok) throw new Error('methods load failed');
    _settle_ctx.methods = j1.methods || [];
  }catch(e){
    alert('æ”¯æ‰•æ–¹æ³•ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  const box = document.getElementById('pay-rows');
  box.innerHTML = '';
  addPayRow();
  document.getElementById('btn-do-split').onclick = doSplitSettle;
  document.getElementById('settle-modal').style.display = 'flex';
}

function buildMethodSelect(){
  const sel = document.createElement('select');
  _settle_ctx.methods.forEach(m=>{
    const opt = document.createElement('option');
    opt.value = m.id;
    opt.textContent = `${m.name} (${m.code})`;
    sel.appendChild(opt);
  });
  return sel;
}

function addPayRow(){
  const row = document.createElement('div'); row.className = 'pay-row';
  const sel = buildMethodSelect(); sel.required = true;
  const input = document.createElement('input'); input.type='number'; input.min='1'; input.step='1'; input.placeholder='é‡‘é¡ï¼ˆä¾‹ï¼š1000ï¼‰';
  const del = document.createElement('button'); del.type='button'; del.className='btn sub'; del.textContent='Ã—'; del.onclick=()=>{ row.remove(); updateRemainingHint(); };
  input.addEventListener('input', updateRemainingHint);
  row.appendChild(sel); row.appendChild(input); row.appendChild(del);
  document.getElementById('pay-rows').appendChild(row);
  updateRemainingHint();
}

function calcEnteredSum(){
  return Array.from(document.querySelectorAll('#pay-rows input[type="number"]'))
    .reduce((a, el)=> a + Number(el.value||0), 0);
}

function updateRemainingHint(){
  const sum = calcEnteredSum();
  const remainAfter = Math.max(0, _settle_ctx.remaining - sum);
  const over = sum > _settle_ctx.remaining;
  const badgeClass = over ? 'badge badge-warn' : 'badge badge-ok';
  document.getElementById('settle-summary').innerHTML =
    `åˆè¨ˆ: <strong>${yen(_settle_ctx.total)}</strong> ï¼ æ—¢æ‰•: <strong>${yen(_settle_ctx.paid)}</strong> ï¼ æ®‹é¡: <strong>${yen(_settle_ctx.remaining)}</strong>
     <span class="${badgeClass}" style="margin-left:8px">ä»Šå›å…¥åŠ›åˆè¨ˆ: ${yen(sum)} / ç™»éŒ²å¾Œã®æ®‹é¡: ${yen(remainAfter)}</span>`;
}

/* åˆ†å‰²ä¼šè¨ˆï¼šæœªæä¾›ãŒæ®‹ã£ã¦ã„ã‚Œã°ç¢ºèªã—ã¦ force:trueã€‚æˆåŠŸæ™‚ã¯ç¢ºå®Ÿã«ãƒªãƒ­ãƒ¼ãƒ‰ï¼‹ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã€‚ */
async function doSplitSettle(){
  let force = false;
  try{
    const r = await fetch(`/admin/order/${_settle_ctx.order_id}/summary`, {cache:'no-store'});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'summary reload failed');
    const {ready, pending} = canSettleFromSummary(j);  // APIã¯ç›´æ¥ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«å€¤ã‚’è¿”ã™
    if (!ready) {
      const go = confirm(`æœªæä¾›/èª¿ç†ä¸­ã®æ˜ç´°ãŒ ${pending} ä»¶ã‚ã‚Šã¾ã™ã€‚\nãã‚Œã§ã‚‚ä¼šè¨ˆã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`);
      if (!go) { closeSettleModal(); return; }
      force = true;
    }
  }catch(e){
    alert('ã‚µãƒãƒªã®å†å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    return;
  }

  const rows = Array.from(document.querySelectorAll('#pay-rows .pay-row'));
  if(rows.length === 0){ alert('æ”¯æ‰•è¡Œã‚’1ã¤ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„ã€‚'); return; }
  const payments = [];
  for(const r of rows){
    const method_id = Number(r.querySelector('select').value || 0);
    const amount = Number(r.querySelector('input').value || 0);
    if(!method_id){ alert('æ”¯æ‰•æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
    if(!(amount > 0)){ alert('é‡‘é¡ã¯1ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
    payments.push({method_id, amount});
  }

  const enteredSum = payments.reduce((a,p)=>a+p.amount,0);
  if(enteredSum > _settle_ctx.remaining){ alert('å…¥åŠ›é‡‘é¡ã®åˆè¨ˆãŒæ®‹é¡ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚'); return; }

  try{
    const r = await fetch(`/admin/settle/${_settle_ctx.table_id}/pay`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ order_id: _settle_ctx.order_id, payments, force })
    });
    let j = await r.json();
    if(!j.ok && j.need_force){
      const go2 = confirm(`æœªæä¾›ã®æ˜ç´°ãŒã‚ã‚Šã¾ã™ï¼ˆ${j.pending || 'ä¸æ˜'} ä»¶ï¼‰ã€‚\nãã‚Œã§ã‚‚ä¼šè¨ˆã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`);
      if(!go2) return;
      const r2 = await fetch(`/admin/settle/${_settle_ctx.table_id}/pay`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ order_id: _settle_ctx.order_id, payments, force:true })
      });
      j = await r2.json();
    }
    if(!j.ok){ alert(j.error || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }

    alert('æ”¯æ‰•ã„ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚æœ€æ–°è¡¨ç¤ºã«æ›´æ–°ã—ã¾ã™ã€‚');
    forceReload(true);

  }catch(e){ alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
}

/* ä¼šè¨ˆå–ã‚Šæ¶ˆã—ãƒ»ä¼šè¨ˆå®Œäº†ï¼šæˆåŠŸæ™‚ã¯å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆï¼‹ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆï¼‰ */
async function voidPayments(order_id){
  if(!confirm('ã“ã®ä¼ç¥¨ã®æ”¯æ‰•ã„ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿï¼ˆä¼šè¨ˆæ¸ˆã®ä¼ç¥¨ã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰')) return;
  try{
    const r = await fetch(`/admin/order/${order_id}/void-payments`, { method:'POST' });
    const j = await r.json();
    if(!j.ok){ alert(j.error || 'å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    alert('æ”¯æ‰•ã„ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚æœ€æ–°è¡¨ç¤ºã«æ›´æ–°ã—ã¾ã™ã€‚');
    forceReload(true);
  }catch(e){ alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
}
async function completeOrder(order_id){
  if(!confirm('ã“ã®ä¼ç¥¨ã‚’ä¼šè¨ˆå®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿï¼ˆæ®‹é¡0ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰')) return;
  try{
    const r = await fetch(`/admin/order/${order_id}/complete`, { method:'POST' });
    const j = await r.json();
    if(!j.ok){ alert(j.error || 'å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    alert('ä¼šè¨ˆã‚’å®Œäº†ã—ã¾ã—ãŸã€‚æœ€æ–°è¡¨ç¤ºã«æ›´æ–°ã—ã¾ã™ã€‚');
    forceReload(true);
  }catch(e){ alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
}

/* ğŸ”¹ ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–ï¼ˆç©º or å…¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®æœªä¼šè¨ˆãƒ˜ãƒƒãƒ€ã®ã¿å‰Šé™¤ï¼‰ */
function _getCsrf(){
  const m = document.querySelector('meta[name="csrf-token"]');
  return m ? (m.getAttribute('content') || '') : '';
}
async function resetSession(order_id){
  if(!order_id) return;
  const go = confirm('ã“ã®æ³¨æ–‡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ˜ç´°ãŒç„¡ã„ã€ã¾ãŸã¯å…¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®æ³¨æ–‡ã®ã¿å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰');
  if(!go) return;

  try{
    const r = await fetch(`/orders/${order_id}/reset_session`, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'X-CSRFToken': _getCsrf()
      }
    });

    // 200ç³»ï¼šæˆåŠŸ â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã—ã¦å³æ›´æ–°
    if (r.ok) {
      try{ await r.json(); }catch(_){}
      alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚');
      return forceReload(true);
    }

    // å¤±æ•—ï¼šç†ç”±ã‚’è¡¨ç¤º
    let msg = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
    try{
      const j = await r.json();
      if (j && j.error) {
        if (j.error === 'not_empty_or_closed') msg = 'æ˜ç´°ãŒæ®‹ã£ã¦ã„ã‚‹ã‹ã€ä¼šè¨ˆæ¸ˆã¿/ã‚¯ãƒ­ãƒ¼ã‚ºæ¸ˆã¿ã§ã™ã€‚';
        else if (j.error === 'order_not_found') msg = 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
      }
    }catch(_){}
    alert(msg);
    forceReload(true);

  }catch(e){
    alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }
}
</script>
{% endblock %}

/* ========== æ™‚ä¾¡å•†å“ã®ä¾¡æ ¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
async function showMarketPriceModal() {
  const items = _settle_ctx.market_price_items || [];
  if (items.length === 0) {
    alert('æ™‚ä¾¡å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
    return;
  }
  
  const modal = document.getElementById('market-price-modal');
  const container = document.getElementById('market-price-items');
  container.innerHTML = '';
  
  items.forEach(item => {
    const row = document.createElement('div');
    row.className = 'market-price-row';
    row.style.cssText = 'display:flex; align-items:center; gap:10px; margin-bottom:10px;';
    row.innerHTML = `
      <span style="flex:1">${item.name} x${item.qty}</span>
      <input type="number" min="0" step="1" placeholder="ä¾¡æ ¼ï¼ˆç¨æŠœï¼‰" data-item-id="${item.id}" style="width:150px; padding:8px;">
    `;
    container.appendChild(row);
  });
  
  modal.style.display = 'flex';
  
  return new Promise((resolve) => {
    document.getElementById('btn-save-market-prices').onclick = async () => {
      const inputs = container.querySelectorAll('input[type="number"]');
      const prices = [];
      
      for (const input of inputs) {
        const itemId = input.dataset.itemId;
        const price = Number(input.value || 0);
        
        if (price <= 0) {
          alert('ã™ã¹ã¦ã®æ™‚ä¾¡å•†å“ã®ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        
        prices.push({ itemId, price });
      }
      
      // å„æ™‚ä¾¡å•†å“ã®ä¾¡æ ¼ã‚’è¨­å®š
      for (const { itemId, price } of prices) {
        try {
          const r = await fetch(`/admin/order_item/${itemId}/set_price`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ price })
          });
          const j = await r.json();
          if (!j.ok) throw new Error(j.error || 'failed');
        } catch (e) {
          alert(`ä¾¡æ ¼ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`);
          return;
        }
      }
      
      modal.style.display = 'none';
      resolve();
    };
    
    document.getElementById('btn-cancel-market-prices').onclick = () => {
      modal.style.display = 'none';
      resolve();
    };
  });
}
