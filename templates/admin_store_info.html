{% extends "base.html" %}

{% block title %}åº—èˆ—æƒ…å ±ç·¨é›†{% endblock %}

{% block content %}
<style>
  body {
    font-family: sans-serif;
    background: #f9fafb;
    margin: 0;
    padding: 20px;
  }
  .container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  h1 {
    font-size: 24px;
    margin-bottom: 10px;
    color: #1f2937;
  }
  .subtitle {
    color: #6b7280;
    margin-bottom: 30px;
  }
  .form-group {
    margin-bottom: 20px;
  }
  label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #374151;
  }
  input[type="text"],
  textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
  }
  textarea {
    min-height: 80px;
    resize: vertical;
  }
  .help-text {
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
  }
  .btn-group {
    display: flex;
    gap: 10px;
    margin-top: 30px;
  }
  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    text-align: center;
  }
  .btn-primary {
    background: #2563eb;
    color: white;
  }
  .btn-primary:hover {
    background: #1d4ed8;
  }
  .btn-secondary {
    background: #6b7280;
    color: white;
  }
  .btn-secondary:hover {
    background: #4b5563;
  }
  .btn-secondary:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }
  .flash-message {
    padding: 12px 16px;
    border-radius: 4px;
    margin-bottom: 20px;
  }
  .flash-success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
  }
  .flash-error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
  }
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 20px;
  }
  .checkbox-group input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  .checkbox-group label {
    margin: 0;
    cursor: pointer;
  }
</style>

<div class="container">
  <h1>ğŸª åº—èˆ—æƒ…å ±ç·¨é›†</h1>
  <p class="subtitle">ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ã«å°åˆ·ã•ã‚Œã‚‹åº—èˆ—æƒ…å ±ã‚’è¨­å®šã—ã¾ã™</p>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash-message flash-{{ category }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST">
    <div class="form-group">
      <label for="ä½æ‰€">ä½æ‰€</label>
      <textarea id="ä½æ‰€" name="ä½æ‰€" placeholder="ã€’123-4567&#10;æ±äº¬éƒ½æ¸‹è°·åŒºâ—‹â—‹ç”º1-2-3">{{ store.address or '' }}</textarea>
      <div class="help-text">éƒµä¾¿ç•ªå·ã¨ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    </div>

    <div class="form-group">
      <label for="é›»è©±ç•ªå·">é›»è©±ç•ªå·</label>
      <input type="text" id="é›»è©±ç•ªå·" name="é›»è©±ç•ªå·" value="{{ store.phone or '' }}" placeholder="03-1234-5678">
      <div class="help-text">ãƒã‚¤ãƒ•ãƒ³ä»˜ãã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    </div>

    <div class="form-group">
      <label for="ç™»éŒ²ç•ªå·">ç™»éŒ²ç•ªå·ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ï¼‰</label>
      <input type="text" id="ç™»éŒ²ç•ªå·" name="ç™»éŒ²ç•ªå·" value="{{ store.registration_number or '' }}" placeholder="T1234567890123">
      <div class="help-text">é©æ ¼è«‹æ±‚æ›¸ç™ºè¡Œäº‹æ¥­è€…ã®ç™»éŒ²ç•ªå·ï¼ˆTã‹ã‚‰å§‹ã¾ã‚‹13æ¡ï¼‰</div>
    </div>

    <div class="form-group">
      <label for="å–¶æ¥­æ™‚é–“">å–¶æ¥­æ™‚é–“</label>
      <input type="text" id="å–¶æ¥­æ™‚é–“" name="å–¶æ¥­æ™‚é–“" value="{{ store.business_hours or '' }}" placeholder="11:00-23:00">
      <div class="help-text">å–¶æ¥­æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    </div>

    <div class="form-group">
      <label for="ãƒ¬ã‚·ãƒ¼ãƒˆãƒ•ãƒƒã‚¿ãƒ¼">ãƒ¬ã‚·ãƒ¼ãƒˆãƒ•ãƒƒã‚¿ãƒ¼</label>
      <textarea id="ãƒ¬ã‚·ãƒ¼ãƒˆãƒ•ãƒƒã‚¿ãƒ¼" name="ãƒ¬ã‚·ãƒ¼ãƒˆãƒ•ãƒƒã‚¿ãƒ¼" placeholder="ã”æ¥åº—ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚&#10;ã¾ãŸã®ãŠè¶Šã—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚">{{ store.receipt_footer or '' }}</textarea>
      <div class="help-text">ãƒ¬ã‚·ãƒ¼ãƒˆä¸‹éƒ¨ã«è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
    </div>

    <div class="form-group">
      <label for="å°åˆ·ã‚µãƒ¼ãƒãƒ¼URL">ğŸ–¨ï¸ ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ã‚µãƒ¼ãƒãƒ¼URL</label>
      
      <!-- ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‹ã‚‰é¸æŠ -->
      {% if printers %}
      <div style="margin-bottom: 10px;">
        <select id="printer-select" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
          <option value="">-- ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‹ã‚‰é¸æŠ --</option>
          {% for p in printers %}
          <option value="{{ p.connection }}">{{ p.name }} ({{ p.connection }})</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      
      <!-- æ‰‹å‹•å…¥åŠ›æ¬„ -->
      <div style="display: flex; gap: 8px; align-items: stretch;">
        <input type="text" id="å°åˆ·ã‚µãƒ¼ãƒãƒ¼URL" name="å°åˆ·ã‚µãƒ¼ãƒãƒ¼URL" value="{{ store.printer_server_url or '' }}" placeholder="http://192.168.1.100:3001" style="flex: 1;">
        <button type="button" id="btn-detect" class="btn btn-secondary" style="white-space: nowrap; padding: 10px 16px;">ğŸ” è‡ªå‹•æ¤œå‡º</button>
        <button type="button" id="btn-migrate" class="btn btn-secondary" style="white-space: nowrap; padding: 10px 16px;">ğŸ“¥ ç§»è¡Œ</button>
      </div>
      
      <div class="help-text">
        ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ã‚µãƒ¼ãƒãƒ¼ã®URLï¼ˆä¾‹: http://192.168.1.100:3001ï¼‰ã€‚<br>
        â€¢ ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‹ã‚‰é¸æŠã€ã¾ãŸã¯æ‰‹å‹•å…¥åŠ›<br>
        â€¢ ã€ŒğŸ” è‡ªå‹•æ¤œå‡ºã€ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã®ã‚µãƒ¼ãƒãƒ¼ã‚’æ¢ç´¢<br>
        â€¢ ã€ŒğŸ“¥ ç§»è¡Œã€ã§æ—¢å­˜ã®localStorageè¨­å®šã‚’å–ã‚Šè¾¼ã¿<br>
        â€¢ ç©ºæ¬„ã®å ´åˆã¯ http://localhost:3001 ãŒä½¿ç”¨ã•ã‚Œã¾ã™
      </div>
      <div id="detect-status" class="help-text" style="margin-top: 8px; color: #2563eb;"></div>
    </div>

    <div class="form-group">
      <label>ğŸ‘¨â€ğŸ³ èª¿ç†ä¸­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ä½¿ç”¨</label>
      <div class="checkbox-group">
        <input type="checkbox" id="use_cooking_status" name="use_cooking_status" value="1" {{ 'checked' if store.use_cooking_status else '' }}>
        <label for="use_cooking_status">ã€Œèª¿ç†ä¸­ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹</label>
      </div>
      <div class="help-text">ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ã€KDSç”»é¢ã‚„æ˜ç´°ç”»é¢ã§ã€Œèª¿ç†ä¸­ã€ãƒœã‚¿ãƒ³ãŒéè¡¨ç¤ºã«ãªã‚Šã¾ã™</div>
    </div>

    <div class="btn-group">
      <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
      <a href="{{ url_for('admin_console') }}" class="btn btn-secondary">æˆ»ã‚‹</a>
    </div>
  </form>
</div>

<script>
(function() {
  const urlInput = document.getElementById('å°åˆ·ã‚µãƒ¼ãƒãƒ¼URL');
  const printerSelect = document.getElementById('printer-select');
  const btnDetect = document.getElementById('btn-detect');
  const btnMigrate = document.getElementById('btn-migrate');
  const statusEl = document.getElementById('detect-status');

  // 1. ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‹ã‚‰é¸æŠ
  if (printerSelect) {
    printerSelect.addEventListener('change', function() {
      if (this.value) {
        urlInput.value = this.value;
        statusEl.textContent = 'âœ“ ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‹ã‚‰è¨­å®šã—ã¾ã—ãŸ';
        statusEl.style.color = '#059669';
      }
    });
  }

  // 2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è‡ªå‹•æ¤œå‡º
  btnDetect.addEventListener('click', async function() {
    btnDetect.disabled = true;
    statusEl.textContent = 'ğŸ” æ¤œå‡ºä¸­...';
    statusEl.style.color = '#2563eb';

    try {
      // ä¸€èˆ¬çš„ãªãƒ­ãƒ¼ã‚«ãƒ«IPãƒ¬ãƒ³ã‚¸ã¨ãƒãƒ¼ãƒˆ3001ã‚’ãƒã‚§ãƒƒã‚¯
      const candidates = [
        'http://localhost:3001',
        'http://127.0.0.1:3001',
      ];

      // ç¾åœ¨ã®ãƒ›ã‚¹ãƒˆã®åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚‚è©¦ã™
      const currentHost = location.hostname;
      if (currentHost && currentHost !== 'localhost' && currentHost !== '127.0.0.1') {
        // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¬¬3ã‚ªã‚¯ãƒ†ãƒƒãƒˆã¾ã§å–å¾—ã—ã¦.100ã‚’ãƒã‚§ãƒƒã‚¯
        const parts = currentHost.split('.');
        if (parts.length === 4) {
          const baseIp = parts.slice(0, 3).join('.');
          candidates.push(`http://${baseIp}.100:3001`);
          candidates.push(`http://${baseIp}.1:3001`);
        }
      }

      let found = null;
      for (const url of candidates) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 2000);
          
          const res = await fetch(`${url}/health`, { 
            signal: controller.signal,
            mode: 'cors'
          });
          
          clearTimeout(timeoutId);
          
          if (res.ok) {
            found = url;
            break;
          }
        } catch (e) {
          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯æ¥ç¶šå¤±æ•—ã¯ç„¡è¦–
        }
      }

      if (found) {
        urlInput.value = found;
        statusEl.textContent = `âœ“ æ¤œå‡ºæˆåŠŸ: ${found}`;
        statusEl.style.color = '#059669';
      } else {
        statusEl.textContent = 'âš  ã‚µãƒ¼ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        statusEl.style.color = '#d97706';
      }
    } catch (e) {
      statusEl.textContent = 'âš  æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ' + e.message;
      statusEl.style.color = '#dc2626';
    } finally {
      btnDetect.disabled = false;
    }
  });

  // 3. localStorage ã‹ã‚‰ç§»è¡Œ
  btnMigrate.addEventListener('click', function() {
    const oldUrl = localStorage.getItem('printerServerUrl');
    if (oldUrl) {
      urlInput.value = oldUrl;
      statusEl.textContent = `âœ“ æ—¢å­˜è¨­å®šã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ: ${oldUrl}`;
      statusEl.style.color = '#059669';
      
      if (confirm('æ—¢å­˜ã®localStorageè¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§ã€ã“ã®è¨­å®šã¯åæ˜ ã•ã‚Œã¾ã›ã‚“ï¼‰')) {
        localStorage.removeItem('printerServerUrl');
        statusEl.textContent += ' (localStorageå‰Šé™¤æ¸ˆã¿)';
      }
    } else {
      statusEl.textContent = 'âš  localStorage ã«è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
      statusEl.style.color = '#d97706';
    }
  });

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ç§»è¡Œã‚’ææ¡ˆ
  window.addEventListener('DOMContentLoaded', function() {
    const oldUrl = localStorage.getItem('printerServerUrl');
    const currentUrl = urlInput.value.trim();
    
    if (oldUrl && !currentUrl) {
      statusEl.textContent = `ğŸ’¡ æ—¢å­˜è¨­å®šã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ã€ŒğŸ“¥ ç§»è¡Œã€ãƒœã‚¿ãƒ³ã§å–ã‚Šè¾¼ã‚ã¾ã™ã€‚`;
      statusEl.style.color = '#2563eb';
    }
  });
})();
</script>
{% endblock %}
