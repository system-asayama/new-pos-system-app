{% extends "base.html" %}
{% block content %}
<h2 style="margin:0 0 12px">テーブル売上履歴</h2>
<p class="small" style="color:#666; margin-top:0;">
  {% if store_name %}店舗: <strong>{{ store_name }}</strong>{% endif %}
  {% if sid %}（ID: {{ sid }}）{% endif %}
</p>

{# CSRF（取消・返金・再開のPOSTで使用） #}
<input type="hidden" id="csrf" value="{{ csrf_token }}">

<form method="get" action="{{ url_for('admin_table_sales') }}" class="card" style="display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); align-items:end;">
  <div>
    <label>テーブル</label>
    <select name="table_id">
      <option value="">全テーブル</option>
      {% for t in tables or [] %}
        {% set is_map_t = t is mapping %}
        {% set tid = (t.id if t.id is defined else (t.get('id') if is_map_t else None)) %}
        {% set tno = (
          t.table_no if t.table_no is defined else
          (t.get('table_no') if is_map_t else None) or
          (t.get('テーブル番号') if is_map_t else None)
        ) %}
        <option value="{{ tid }}" {{ 'selected' if (current_table_id and tid == current_table_id) else '' }}>
          {{ tno or ('#' ~ tid) }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>開始日</label>
    <input type="date" name="from" value="{{ from_date or '' }}">
  </div>
  <div>
    <label>終了日</label>
    <input type="date" name="to" value="{{ to_date or '' }}">
  </div>
  <div>
    <button class="btn" type="submit">絞り込む</button>
    {% if request.query_string %}
      <a class="btn sub" href="{{ url_for('admin_table_sales') }}" style="margin-left:6px;">クリア</a>
    {% endif %}
  </div>
</form>

<style>
  .neg-row { color:#b91c1c; background:#fff1f2; }
  .void-badge{
    display:inline-block; padding:2px 6px; font-size:12px;
    border:1px solid #b91c1c; border-radius:6px; color:#b91c1c; background:#fff;
    margin-left:6px;
  }
  .progress-detail { display:inline-flex; gap:8px; font-size:12px; flex-wrap:wrap; }
  .status-chip {
    display:inline-block; padding:2px 8px; border-radius:4px; font-weight:500; cursor:pointer;
    user-select:none; border:1px solid transparent;
  }
  .status-chip:focus-visible { outline:2px solid #2563eb; outline-offset:2px; }
  .chip-served{background:#d1fae5;color:#065f46}
  .chip-canceled{background:#fee2e2;color:#991b1b}

  .time-cell{white-space:nowrap;font-variant-numeric:tabular-nums}
  .small.muted{color:#6b7280}

  .action-host { position:relative; min-height:26px; }
  .action-pop {
    position:absolute; top:0; left:0; z-index:50;
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    padding:8px; background:#fff; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.12);
  }
  .action-pop .badge-src {
    display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px; border:1px solid #e5e7eb; background:#f9fafb;
  }
  .action-pop input[type="number"] { width:72px; padding:4px 6px; }
  .action-pop .btn { padding:6px 10px; }
  .action-pop .btn.sub { background:#f3f4f6; border:1px solid #e5e7eb; }
  .action-pop .btn.primary { background:#2563eb; color:#fff; border:1px solid #1d4ed8; }

  .card, table, thead, tbody, tr, th, td, .action-host, .action-pop, .progress-detail, .status-chip, select, input, button {
    position:relative; z-index:1; pointer-events:auto !important;
  }
  tr::before, tr::after, td::before, td::after { pointer-events:none !重要; }
</style>

<div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:12px; margin-top:12px;">
  <section class="card">
    <div class="small" style="color:#666;">伝票件数</div>
    <div style="font-size:22px; font-weight:700;">{{ total_orders or (rows|length if rows else 0) }}</div>
  </section>
  <section class="card">
    <div class="small" style="color:#666;">合計（税込）</div>
    <div style="font-size:22px; font-weight:700;">¥{{ (total_amount if total_amount is defined else (rows|sum(attribute='total') if rows else 0)) }}</div>
  </section>
  <section class="card">
    <div class="small" style="color:#666;">小計（税抜）</div>
    <div style="font-size:22px; font-weight:700;">¥{{ (total_subtotal if total_subtotal is defined else (rows|sum(attribute='subtotal') if rows else 0)) }}</div>
  </section>
  <section class="card">
    <div class="small" style="color:#666;">税額</div>
    <div style="font-size:22px; font-weight:700;">¥{{ (total_tax if total_tax is defined else (rows|sum(attribute='tax') if rows else 0)) }}</div>
  </section>
</div>

<div class="card" style="margin-top:12px;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
    <div style="font-weight:600;">売上一覧</div>
    <div class="small" style="color:#666;">
      {{ rows|length if rows else 0 }} 件
    </div>
  </div>

  <div style="overflow:auto;">
    <table>
      <thead>
        <tr>
          <th style="white-space:nowrap;">日時</th>
          <th>テーブル</th>
          <th>伝票ID</th>
          <th>状態</th>
          <th style="text-align:right;">小計</th>
          <th style="text-align:right;">税額</th>
          <th style="text-align:right;">合計</th>
          <th>明細</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows or [] %}
          {% set is_map_r = r is mapping %}
          {% set dt = (
            r.opened_at if r.opened_at is defined else
            (r.get('opened_at') if is_map_r else None) or
            (r.get('作成日時') if is_map_r else None) or
            (r.get('開始日時') if is_map_r else None)
          ) %}
          {% set rid = (r.id if r.id is defined else (r.get('id') if is_map_r else None)) %}
          {% set tbl = (
            r.table_no if r.table_no is defined else
            (r.get('table_no') if is_map_r else None) or
            (r.get('テーブル番号') if is_map_r else None) or
            (r.get('table_id') if is_map_r else None)
          ) %}
          {% set st  = (r.status if r.status is defined else (r.get('status') if is_map_r else None) or (r.get('状態') if is_map_r else None)) %}
          
          {# ★★★ 明細から直接合計金額を計算（キャンセルを除外） ★★★ #}
          {% set items = (items_map.get(rid, []) if items_map is defined else []) %}
          {% set ns = namespace(subtotal=0, tax=0, total=0) %}
          {% for d in items %}
            {% set is_map_d = d is mapping %}
            {% set qty   = (d.qty if d.qty is defined else (d.get('qty') if is_map_d else (d.get('数量') if is_map_d else 0))) | int %}
            {% set excl  = (d.unit_price if d.unit_price is defined else (d.get('unit_price') if is_map_d else (d.get('単価') if is_map_d else (d.get('税抜単価') if is_map_d else 0)))) | int %}
            {% set rate  = (d.tax_rate if d.tax_rate is defined else (d.get('tax_rate') if is_map_d else (d.get('税率') if is_map_d else 0.10))) | float %}
            {% set unit_tax = (excl * rate) | round(0, 'floor') | int %}
            {% set incl  = (d.unit_price_incl if d.unit_price_incl is defined else (d.get('unit_price_incl') if is_map_d else (d.get('税込単価') if is_map_d else (excl + unit_tax)))) | int %}
            {% set label_raw = (d.status if d.status is defined else (d.get('status') if is_map_d else (d.get('状態') if is_map_d else ''))) | string %}
            {% set label = label_raw|lower %}
            {% set is_cancel = label in ['取消','ｷｬﾝｾﾙ','キャンセル','cancel','void'] %}
            {% if qty != 0 and (qty < 0 or not is_cancel) %}
              {% set ns.subtotal = ns.subtotal + (excl * qty) %}
              {% set ns.tax      = ns.tax      + (unit_tax * qty) %}
              {% set ns.total    = ns.total    + (incl * qty) %}
            {% endif %}
          {% endfor %}
          {% set sub = ns.subtotal %}
          {% set tax = ns.tax %}
          {% set tot = ns.total %}

          {% set st_lower = (st or '')|string|lower %}
          {% set is_closed = (st == '会計済') or (st_lower in ['closed','paid']) %}

          <tr>
            <td style="white-space:nowrap;">{{ dt }}</td>
            <td>{{ tbl }}</td>
            <td>{{ rid }}</td>
            <td>{{ st }}</td>
            <td style="text-align:right;">¥{{ sub }}</td>
            <td style="text-align:right;">¥{{ tax }}</td>
            <td style="text-align:right; font-weight:600;">¥{{ tot }}</td>
            <td>
              <button type="button"
                      class="btn sub js-toggle"
                      data-target="#detail-{{ rid }}"
                      aria-expanded="false"
                      aria-controls="detail-{{ rid }}">
                明細
              </button>
            </td>
            <td style="display:flex; gap:6px; flex-wrap:wrap;">
              {% if ALLOW_DIRECT_REFUND %}
                <button type="button" class="btn sub js-refund" data-order-id="{{ rid }}">返金</button>
              {% endif %}
              {% if is_closed %}
                <button type="button" class="btn warn js-reopen" data-order-id="{{ rid }}">会計取消（再開）</button>
              {% endif %}
            </td>
          </tr>

          {# ▼ 折りたたみ明細（提供済・取消のみ表示/編集） ▼ #}
          <tr id="detail-{{ rid }}" class="detail-row" style="display:none; background:#fafafa;">
            <td colspan="9">
              {% set items = (items_map.get(rid, []) if items_map is defined else []) %}
              {% if items and items|length > 0 %}
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>品名</th>
                      <th>数量</th>
                      <th>単価<br><span class="small muted">(税込 / 税抜)</span></th>
                      <th>小計<br><span class="small muted">(税込 / 税抜)</span></th>
                      <th>状態</th>
                      <th>操作</th>
                      <th>注文</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for d in items %}
                      {% set is_map = d is mapping %}
                      {% set did  = (d.id if d.id is defined else (d.get('id') if is_map else '')) %}
                      {% set name = (
                        d.名称 if d.名称 is defined else
                        (d.name if d.name is defined else
                          (d.menu.name if d.menu is defined and d.menu and d.menu.name is defined else
                           (d.get('名称') if is_map else '')))
                      ) %}
                      {% set qty  = (
                        d.数量 if d.数量 is defined else
                        (d.qty if d.qty is defined else (d.get('数量') if is_map else 0))
                      ) | int %}
                      {% set excl = (
                        d.税抜単価 if d.税抜単価 is defined else
                        (d.unit_price if d.unit_price is defined else (d.get('税抜単価') if is_map else 0))
                      ) | int %}
                      {% set rate = (
                        d.税率 if d.税率 is defined else
                        (d.tax_rate if d.tax_rate is defined else (d.get('税率') if is_map else 0.10))
                      ) | float %}
                      {% set unit_tax = (excl * rate) | round(0, 'floor') | int %}
                      {% set incl = (
                        d.税込単価 if d.税込単価 is defined else
                        (d.get('税込単価') if is_map else None) or
                        (excl + unit_tax)
                      ) | int %}

                      {% set label = (
                        d.状態 if d.状態 is defined else
                        (d.status if d.status is defined else (d.get('状態') if is_map else ''))
                      ) | string %}
                      {% set is_negative = qty < 0 %}
                      {% set is_void_label = (label|lower in ['取消','ｷｬﾝｾﾙ','キャンセル','cancel','void']) %}

                      {# サーバで付与した progress を使用（qty_served / qty_canceled のみ） #}
                      {% set prog = (d.progress if d.progress is defined else (d.get('progress') if is_map else {})) %}
                      {% set qty_served   = (prog.qty_served if prog and prog.qty_served is defined else (prog.get('qty_served') if prog is mapping else 0)) | int %}
                      {% set qty_canceled = (prog.qty_canceled if prog and prog.qty_canceled is defined else (prog.get('qty_canceled') if prog is mapping else 0)) | int %}

                      {% set sub_excl = excl * qty %}
                      {% set sub_incl = incl * qty %}

                      {# 会計済 & 正数明細のみ操作可 #}
                      {% set show_progress = (is_closed and qty > 0 and not is_negative) %}

                      <tr class="{% if is_negative %}neg-row{% elif is_void_label %}muted{% endif %}">
                        <td>{{ did }}</td>
                        <td>
                          {{ name }}
                          {% if is_negative %}<span class="void-badge">取消</span>{% endif %}
                        </td>
                        <td>{{ qty }}</td>
                        <td>税込 ¥{{ incl }}<br><span class="small muted">税抜 ¥{{ excl }}</span></td>
                        <td>税込 ¥{{ sub_incl }}<br><span class="small muted">税抜 ¥{{ sub_excl }}</span></td>

                        <td>
                          {% if show_progress %}
                            <div class="progress-detail">
                              <span class="status-chip chip-served"
                                    data-role="chip" data-src="served" data-count="{{ qty_served }}"
                                    data-item-id="{{ did }}">提供済: {{ qty_served }}</span>
                              <span class="status-chip chip-canceled"
                                    data-role="chip" data-src="canceled" data-count="{{ qty_canceled }}"
                                    data-item-id="{{ did }}">取消: {{ qty_canceled }}</span>
                            </div>
                          {% else %}
                            <span class="small muted">—</span>
                          {% endif %}
                        </td>

                        <td>
                          {% if show_progress %}
                            <div class="action-host" data-item-id="{{ did }}"></div>
                            <span class="small muted js-save-result" data-item-id="{{ did }}"></span>
                          {% else %}
                            <span class="small muted">—</span>
                          {% endif %}
                        </td>

                        {% set ordered_at =
                          (d.ordered_at if d.ordered_at is defined and d.ordered_at else
                           (d.added_at if d.added_at is defined else
                            (d.created_at if d.created_at is defined else
                             (d.get('追加日時') if is_map else None))))
                        %}
                        <td class="time-cell">{% if ordered_at %}<span class="small">{{ ordered_at }}</span>{% endif %}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% else %}
                <div class="small muted">この伝票に明細はありません。</div>
              {% endif %}
            </td>
          </tr>
          {# ▲ 折りたたみ明細 #}

        {% else %}
          <tr><td colspan="9" class="muted">該当データがありません。</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  (function(){
    // 明細の開閉
    document.querySelectorAll('.js-toggle').forEach(function(btn){
      btn.addEventListener('click', function(){
        var sel = this.getAttribute('data-target');
        var el  = document.querySelector(sel);
        if (!el) return;
        var expanded = this.getAttribute('aria-expanded') === 'true';
        var willExpand = !expanded;
        el.style.display = willExpand ? '' : 'none';
        this.setAttribute('aria-expanded', willExpand ? 'true' : 'false');
        this.textContent = willExpand ? '明細を閉じる' : '明細';
      });
    });

    const CSRF = document.getElementById('csrf')?.value || '';

    {% if ALLOW_DIRECT_REFUND %}
    // 返金
    document.querySelectorAll('.js-refund').forEach(function(btn){
      btn.addEventListener('click', async function(){
        const orderId = this.getAttribute('data-order-id');
        const amount  = window.prompt('返金金額（税込）を入力してください（正の数）');
        if (!amount) return;
        if (isNaN(amount) || Number(amount) <= 0) { alert('金額が不正です'); return; }
        const reason  = window.prompt('返金理由を入力してください（必須）');
        if (!reason) return;

        try {
          this.disabled = true;
          const res = await fetch(`/admin/orders/${orderId}/refund`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRF-Token': CSRF},
            body: JSON.stringify({amount: amount, reason: reason, method: 'refund'})
          });
          const j = await res.json().catch(_=>({}));
          if (!res.ok || !j.ok) throw new Error(j.error || res.status);
          location.reload();
        } catch (e) {
          alert('返金に失敗しました: ' + e.message);
        } finally {
          this.disabled = false;
        }
      });
    });
    {% endif %}

    // 会計取消（再開）
    document.querySelectorAll('.js-reopen').forEach(function(btn){
      btn.addEventListener('click', async function(){
        const orderId = this.getAttribute('data-order-id');
        if (!confirm('この伝票の会計を取り消して再開しますか？\n※ テーブルが既に再利用されている場合は実行できません。')) return;

        try {
          this.disabled = true;
          const res = await fetch(`/admin/order/${orderId}/reopen`, {
            method: 'POST',
            headers: { 'X-CSRF-Token': CSRF }
          });
          const j = await res.json();
          if (!res.ok || !j.ok) throw new Error(j.error || res.status);
          alert(j.restored_guests ? '会計を取り消し、来客情報を復元しました。' : '会計を取り消しました。');
          location.reload();
        } catch (e) {
          if (String(e.message) === '409' || /already reused/.test(e.message)) {
            alert('会計を取り消せません：テーブルが既に再利用されています。');
          } else {
            alert('会計取消に失敗しました: ' + e.message);
          }
        } finally {
          this.disabled = false;
        }
      });
    });

    /* ===== 進捗操作：提供済 ↔ 取消 のみ。会計済の伝票だけ編集可 ===== */
    async function postJSON(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRF-Token": CSRF },
        body: JSON.stringify(body || {})
      });
      return res.json().catch(()=>({}));
    }
    function clamp(n, lo, hi){ n = Number(n||0); return Math.max(lo, Math.min(hi, n)); }

    // allowed transitions
    const ALLOW = {
      served:   ["取消"],     // 提供済 → 取消
      canceled: ["提供済"]    // 取消 → 提供済
    };
    function statusLabel(srcKey){ return srcKey==="served" ? "提供済" : "取消"; }
    function refreshChips(rowEl, p){
      const map = {
        served:   Number(p.qty_served||0),
        canceled: Number(p.qty_canceled||0),
      };
      rowEl.querySelectorAll('[data-role="chip"]').forEach(chip=>{
        const k = chip.dataset.src;
        const v = map[k]||0;
        chip.dataset.count = String(v);
        chip.textContent = (k==="served"?"提供済":"取消") + ": " + v;
      });
    }
    function openActionPop(itemId, srcKey, maxCount, host){
      const detailTable = host.closest('table');
      if (!detailTable) return;
      detailTable.querySelectorAll('.action-pop').forEach(p=>p.remove());

      const actionHost = detailTable.querySelector(`.action-host[data-item-id="${itemId}"]`);
      if (!actionHost) return;

      const targets = ALLOW[srcKey] || [];
      if (!targets.length || maxCount<=0) return;

      const pop = document.createElement('div');
      pop.className = 'action-pop';
      pop.innerHTML = `
        <span class="badge-src">${statusLabel(srcKey)} →</span>
        <select class="js-target">
          ${targets.map(t => `<option value="${t}">${t}</option>`).join('')}
        </select>
        <input type="number" class="js-count" min="1" value="${Math.max(1, maxCount)}">
        <button type="button" class="btn primary js-apply">適用</button>
        <button type="button" class="btn sub js-cancel">閉じる</button>
      `;
      actionHost.appendChild(pop);

      const countInput = pop.querySelector('.js-count');
      countInput.max = String(Math.max(1, maxCount));
      countInput.value = String(Math.max(1, Math.min(maxCount||1, Number(countInput.value||1))));

      pop.querySelector('.js-cancel').addEventListener('click', ()=>pop.remove());
      pop.addEventListener('keydown', (e)=>{ if(e.key==='Escape') pop.remove(); });

      pop.querySelector('.js-apply').addEventListener('click', async ()=>{
        const to  = pop.querySelector('.js-target').value;        // "取消" or "提供済"
        const cnt = clamp(countInput.value, 1, Math.max(1, maxCount||1));
        const hint = detailTable.querySelector(`.js-save-result[data-item-id="${itemId}"]`);
        if (hint) hint.textContent = "保存中…";
        try{
          const json = await postJSON(`/staff/api/order_item/${itemId}/status`, {
            status: to,
            from_status: statusLabel(srcKey),
            count: cnt
          });
          if (json && (json.ok || json.status==='success')){
            if (hint) hint.textContent = `✓ ${statusLabel(srcKey)} から ${to} に ${cnt}個変更`;
            if (json.progress){
              const tr = actionHost.closest('tr');
              refreshChips(tr, json.progress);
            }
            pop.remove();
            setTimeout(()=>location.reload(), 300);
          }else{
            if (hint) hint.textContent = "× 失敗" + (json && (json.error||json.message)?(": "+(json.error||json.message)):"");
          }
        }catch(e){
          if (hint) hint.textContent = "× 通信エラー";
        }
        setTimeout(()=>{ if(hint) hint.textContent = ""; }, 2000);
      });
    }

    // バッジクリック
    document.addEventListener('click', function(ev){
      const chip = ev.target.closest('[data-role="chip"]');
      if (!chip) return;
      const maxCount = Number(chip.dataset.count || 0);
      const srcKey   = chip.dataset.src;  // served / canceled
      const itemId   = chip.dataset.itemId;
      if (!ALLOW[srcKey] || ALLOW[srcKey].length===0 || maxCount<=0) return;
      openActionPop(itemId, srcKey, maxCount, chip);
    });

  })();
</script>
{% endblock %}
